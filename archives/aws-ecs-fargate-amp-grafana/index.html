<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ | Nikaeraintokyo.</title><meta name=keywords content="fargate,prometheus,grafana,aws,nodejs"><meta name=description content="ã¯ã˜ã‚ã«
ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Fargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
å‹•ä½œç’°å¢ƒ

Node.js v16.13.0
AWS CDK 2.0.0 (build 4b6ce31)
Prometheus 2.32.1

ç’°å¢ƒæ§‹ç¯‰
æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)
aws-aps ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ AWS CDK ã‹ã‚‰ã§ã‚‚ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ç¢ºèªã§ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã®åˆ©ç”¨ã‚’æ¨å¥¨ã„ãŸã—ã¾ã™&mldr; ğŸ™‡ğŸ™‡
lib/prometheus-agent-test-stack.ts ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¿®æ­£æ¸ˆã¿ã§ AWS CDK ã§ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ãŸã€‚(2021/12/18 è¿½è¨˜)"><meta name=author content="Me"><link rel=canonical href=https://zenn.dev/nikaera/articles/aws-ecs-fargate-amp-grafana><meta name=google-site-verification content="G-39TEECMFQW"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://nikaera.com/favicon.ico><link rel=apple-touch-icon href=https://nikaera.com/apple-touch-icon.png><link rel=mask-icon href=https://nikaera.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TEECMFQW"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TEECMFQW")}</script><meta property="og:url" content="https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"><meta property="og:site_name" content="Nikaeraintokyo."><meta property="og:title" content="ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹"><meta property="og:description" content="ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Fargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
å‹•ä½œç’°å¢ƒ Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.1 ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)
aws-aps ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ AWS CDK ã‹ã‚‰ã§ã‚‚ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ç¢ºèªã§ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã®åˆ©ç”¨ã‚’æ¨å¥¨ã„ãŸã—ã¾ã™â€¦ ğŸ™‡ğŸ™‡
lib/prometheus-agent-test-stack.ts ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¿®æ­£æ¸ˆã¿ã§ AWS CDK ã§ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ãŸã€‚(2021/12/18 è¿½è¨˜)"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="archives"><meta property="article:published_time" content="2021-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-05T00:00:00+00:00"><meta property="article:tag" content="Fargate"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Grafana"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Nodejs"><meta property="og:image" content="https://i.gyazo.com/a6905ee24a684da236b8360697098672.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://i.gyazo.com/a6905ee24a684da236b8360697098672.png"><meta name=twitter:title content="ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹"><meta name=twitter:description content="ã¯ã˜ã‚ã«
ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Fargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
å‹•ä½œç’°å¢ƒ

Node.js v16.13.0
AWS CDK 2.0.0 (build 4b6ce31)
Prometheus 2.32.1

ç’°å¢ƒæ§‹ç¯‰
æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)
aws-aps ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ AWS CDK ã‹ã‚‰ã§ã‚‚ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ç¢ºèªã§ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã®åˆ©ç”¨ã‚’æ¨å¥¨ã„ãŸã—ã¾ã™&mldr; ğŸ™‡ğŸ™‡
lib/prometheus-agent-test-stack.ts ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¿®æ­£æ¸ˆã¿ã§ AWS CDK ã§ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ãŸã€‚(2021/12/18 è¿½è¨˜)"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Archives","item":"https://nikaera.com/archives/"},{"@type":"ListItem","position":2,"name":"ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹","item":"https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹","name":"ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹","description":"ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\nFargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚\nã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚\næœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚\nå‹•ä½œç’°å¢ƒ Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.1 ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)\naws-aps ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ AWS CDK ã‹ã‚‰ã§ã‚‚ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ç¢ºèªã§ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã®åˆ©ç”¨ã‚’æ¨å¥¨ã„ãŸã—ã¾ã™\u0026hellip; ğŸ™‡ğŸ™‡\nlib/prometheus-agent-test-stack.ts ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¿®æ­£æ¸ˆã¿ã§ AWS CDK ã§ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ãŸã€‚(2021/12/18 è¿½è¨˜)\n","keywords":["fargate","prometheus","grafana","aws","nodejs"],"articleBody":"ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\nFargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚\nã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚\næœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚\nå‹•ä½œç’°å¢ƒ Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.1 ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)\naws-aps ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ AWS CDK ã‹ã‚‰ã§ã‚‚ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ç¢ºèªã§ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã®åˆ©ç”¨ã‚’æ¨å¥¨ã„ãŸã—ã¾ã™â€¦ ğŸ™‡ğŸ™‡\nlib/prometheus-agent-test-stack.ts ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¿®æ­£æ¸ˆã¿ã§ AWS CDK ã§ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ãŸã€‚(2021/12/18 è¿½è¨˜)\næ‰‹å‹•ã§ AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æ‰‹é † ã¾ãšã€AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚\n1. AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹\n2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹\n3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã\nAMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã¯ã€Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚\nAWS CDK ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹ CDK ã§æ§‹ç¯‰ä½œæ¥­ã‚’é€²ã‚ã¾ã™ã€‚ã¾ãšã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ CDK ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ä½¿ç”¨è¨€èªã¯ TypeScript ã‚’é¸æŠã—ã¾ã™ã€‚\nmkdir prometheus-agent-test \u0026\u0026 cd prometheus-agent-test cdk init --language typescript ã¾ãš CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãå‰ã«ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ†ã‚¹ãƒˆç”¨ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚\nECS Fargate ã§å‹•ã‹ã™ Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹ prom-client ã‚’åˆ©ç”¨ã—ã¦ã€Node.js ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ãã‚‹ã ã‘ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚prometheus-agent-test ãƒ•ã‚©ãƒ«ãƒ€ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nmkdir metrics-app \u0026\u0026 cd metrics-app npm init -y npm install --save prom-client æ¬¡ã« metrics-app ãƒ•ã‚©ãƒ«ãƒ€å†…ã« index.js ã‚’ä½œæˆã—ã¦ä¸‹è¨˜ã‚’ç·¨é›†ã—ã¾ã™ã€‚\n// metrics-app/index.js \"use strict\"; const http = require(\"http\"); const server = http.createServer(); const client = require(\"prom-client\"); const register = new client.Registry(); // 5ç§’é–“éš”ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹ client.collectDefaultMetrics({ register, timeout: 5 * 1000 }); server.on(\"request\", async function (req, res) { // /metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰ã€Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿”ã™ if (req.url === \"/metrics\") { res.setHeader(\"Content-Type\", register.contentType); const metrics = await register.metrics(); return res.end(metrics); } else { return res.writeHead(404, { \"Content-Type\": \"text/plain\" }); } }); server.listen(8080); node index.js ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ http://localhost:8080/metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã®ã‚ˆã†ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ãŒç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚\nPrometheus ã®ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­\nä»Šå›ã¯ ECS ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€Dockerfile ã‚‚ä½œæˆã—ã¾ã™ã€‚\n# metrics-app/Dockerfile FROM public.ecr.aws/docker/library/node:16-alpine3.12 AS builder EXPOSE 8080 WORKDIR /usr/src/app COPY package*.json ./ RUN npm install --max-old-space-size=4096 COPY . . CMD [ \"node\", \"index.js\" ] ä¸Šè¨˜ Dockerfile ä½œæˆå¾Œã€å†ã³å‹•ä½œæ¤œè¨¼ã®ãŸã‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€http://localhost:8080/metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚\ndocker build -t prometheus-agent-test/metrics-app . docker run -p 8080:8080 prometheus-agent-test/metrics-app:latest å…ˆã»ã©ã¨åŒæ§˜ã« http://localhost:8080/metrics ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ã‚’ç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚\nNode.js ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹ Prometheus Agent ã‚’æº–å‚™ã™ã‚‹ ã¾ãšã¯ Prometheus é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚prometheus-agent-test ãƒ•ã‚©ãƒ«ãƒ€å†…ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nmkdir prometheus-agent \u0026\u0026 cd prometheus-agent æ¬¡ã« Prometheus ã®è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ sed ã‚’åˆ©ç”¨ã—ã¦ä¸­èº«ã® __TASK_ID__ ãŠã‚ˆã³ __REMOTE_WRITE_URL__ ã‚’æ›¸ãæ›ãˆã¦åˆ©ç”¨ã—ã¾ã™ã€‚\n# prometheus-agent/prometheus.tmpl.yml global: scrape_interval: 5s external_labels: monitor: \"prometheus\" scrape_configs: - job_name: \"prometheus-agent-test\" static_configs: - targets: [\"localhost:8080\"] labels: # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® localhost:8080 ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹ã¨ã€ # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åˆ¤åˆ¥ãŒã—ã¥ã‚‰ããªã‚‹ãŸã‚ ECS Task ã® ID ã‚’åˆ©ç”¨ã™ã‚‹ instance: \"__TASK_ID__\" remote_write: # AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆæ™‚ã«æ§ãˆã¦ãŠã„ãŸã€ # `ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL` ã‚’è¨­å®šã™ã‚‹ç®‡æ‰€ - url: \"__REMOTE_WRITE_URL__\" sigv4: region: ap-northeast-1 queue_config: max_samples_per_send: 1000 max_shards: 200 capacity: 2500 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ Prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€Prometheus Agent ã‚’èµ·å‹•ã•ã›ã‚‹ãŸã‚ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\n# prometheus-agent/docker-entrypoint.sh #!/bin/sh while [ -z \"$taskId\" ] do # ECS Fargate ã§èµ·å‹•ã—ãŸã‚¿ã‚¹ã‚¯ ID ã‚’å–å¾—ã™ã‚‹ taskId=$(curl --silent ${ECS_CONTAINER_METADATA_URI}/task | jq -r '.TaskARN | split(\"/\") | .[-1]') echo \"waiting...\" sleep 1 done echo \"taskId: ${taskId}\" echo \"remoteWriteUrl: ${REMOTE_WRITE_URL}\" # ã‚¿ã‚¹ã‚¯ ID `taskId` ãŠã‚ˆã³ã€ç’°å¢ƒå¤‰æ•° `REMOTE_WRITE_URL` ã§ã€ # Prometheus ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« `prometheus.tmpl.yml` ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã€ # ãã®çµæœã‚’ `/etc/prometheus/prometheus.yml` ã«å‡ºåŠ›ã™ã‚‹ cat /etc/prometheus/prometheus.tmpl.yml | \\ sed \"s/__TASK_ID__/${taskId}/g\" | \\ sed \"s\u003e__REMOTE_WRITE_URL__\u003e${REMOTE_WRITE_URL}\u003eg\" \u003e /etc/prometheus/prometheus.yml # --enable-feature=agent ã§ Prometheus ã‚’ Agent ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã™ã‚‹ # Prometheus ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä¸Šè¨˜ã§å‡ºåŠ›ã—ãŸ `/etc/prometheus/prometheus.yml` ã‚’åˆ©ç”¨ã™ã‚‹ /usr/local/bin/prometheus \\ --enable-feature=agent \\ --config.file=/etc/prometheus/prometheus.yml \\ --web.console.libraries=/etc/prometheus/console_libraries \\ --web.console.templates=/etc/prometheus/consoles ã“ã‚Œã§ Prometheus Agent èµ·å‹•ã®ãŸã‚ã®æº–å‚™ã¯æ•´ã£ãŸãŸã‚ã€æœ€å¾Œã« Dockerfile ã‚’æº–å‚™ã—ã¾ã™ã€‚ã¡ãªã¿ã« Prometheus Agent ã¯ v2.32.0 ä»¥é™ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ v2.32.1 ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚\n# prometheus-agent/Dockerfile FROM --platform=arm64 alpine:3.15 ADD prometheus.tmpl.yml /etc/prometheus/ RUN apk add --update --no-cache jq sed curl # ARM64 ã§å‹•ä½œã™ã‚‹ Prometheus v2.32.1 ã‚’ curl ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±•é–‹ã™ã‚‹ RUN curl -sL -O https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-arm64.tar.gz RUN tar -zxvf prometheus-2.32.1.linux-arm64.tar.gz \u0026\u0026 rm prometheus-2.32.1.linux-arm64.tar.gz # `prometheus` ã‚³ãƒãƒ³ãƒ‰ã‚’ `/usr/local/bin/prometheus` ã«ç§»å‹•ã™ã‚‹ RUN mv prometheus-2.32.1.linux-arm64/prometheus /usr/local/bin/prometheus COPY ./docker-entrypoint.sh / RUN chmod +x /docker-entrypoint.sh CMD [\"/docker-entrypoint.sh\"] ã“ã“ã¾ã§ã§ CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚’é€²ã‚ã¦ã„ããŸã‚ã®ä¸‹æº–å‚™ã¯å®Œäº†ã§ã™ã€‚\nECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agent ã‚’å‹•ä½œã•ã›ã‚‹ ã‚ã¨ã¯ CDK ã§ ECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agentã€Grafana ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ•´å‚™ã—ã¦ã„ãã¾ã™ã€‚\nlib/prometheus-agent-test-stack.ts ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚\n// lib/prometheus-agent-test-stack.ts import { Construct } from \"constructs\"; import { Stack, StackProps, aws_ecs as ecs, aws_logs as logs, aws_aps as aps, aws_ecs_patterns as ecs_patterns, aws_iam as iam, aws_elasticloadbalancingv2 as elbv2, Duration, CfnOutput, } from \"aws-cdk-lib\"; export class PrometheusAgentTestStack extends Stack { constructor(scope: Construct, id: string, props?: StackProps) { super(scope, id, props); // Node.js ã‚¢ãƒ—ãƒªã« ecs_patterns.ApplicationLoadBalancedFargateService ã‚’åˆ©ç”¨ã—ã¦ ALB çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ const projectName = \"prometheus-agent-test\"; const fargateService = new ecs_patterns.ApplicationLoadBalancedFargateService( this, `${projectName}-fargate-service`, { serviceName: `${projectName}-fargate-service`, cpu: 256, desiredCount: 3, listenerPort: 80, taskImageOptions: { family: `${projectName}-taskdef`, image: ecs.ContainerImage.fromAsset(\"metrics-app\"), containerPort: 8080, logDriver: ecs.LogDrivers.awsLogs({ streamPrefix: `/${projectName}/metrics-app`, logRetention: logs.RetentionDays.ONE_DAY, }), }, cluster: new ecs.Cluster(this, `${projectName}-cluster`, { clusterName: `${projectName}-cluster`, }), memoryLimitMiB: 512, } ); fargateService.targetGroup.configureHealthCheck({ path: \"/metrics\", timeout: Duration.seconds(8), interval: Duration.seconds(10), healthyThresholdCount: 2, unhealthyThresholdCount: 4, healthyHttpCodes: \"200\", }); // æœ¬è³ªã§ã¯ãªã„ãŒã€Gravition2 ã§å‹•ä½œã•ã›ãŸã„ãŸã‚ã« RuntimePlatform ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã—ã¦ã„ã‚‹ const fargateServiceTaskdef = fargateService.taskDefinition.node .defaultChild as ecs.CfnTaskDefinition; fargateServiceTaskdef.addPropertyOverride(\"RuntimePlatform\", { CpuArchitecture: \"ARM64\", OperatingSystemFamily: \"LINUX\", }); // AMP ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ fargateService.taskDefinition.taskRole.addManagedPolicy( iam.ManagedPolicy.fromAwsManagedPolicyName( \"AmazonPrometheusRemoteWriteAccess\" ) ); // (2021/12/18) Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã€Prometheus ã® remote-write URL ã‚’å–å¾—ã™ã‚‹ const apsWorkspace = new aps.CfnWorkspace( this, `${projectName}-prom-workspace`, { alias: `${projectName}-prom-workspace`, } ); const apsWorkspaceRemoteUrl = `${apsWorkspace.attrPrometheusEndpoint}api/v1/remote_write`; // (2021/12/18) æœ¬è¨˜äº‹ã§é »å‡ºã™ã‚‹ \"ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL\" ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹ new CfnOutput(this, \"prom-remote-write-url\", { value: apsWorkspaceRemoteUrl, description: \"Prometheus Workspace ã® remote-write URL\", exportName: \"PromRemoteWriteURL\", }); // AMP ã¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã® Prometheus Agent ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ const containerName = `${projectName}-prometheus-agent`; fargateService.taskDefinition.addContainer(containerName, { containerName, image: ecs.ContainerImage.fromAsset(\"prometheus-agent\"), memoryReservationMiB: 128, environment: { // (2021/12/18) CDK çµŒç”±ã§ä½œæˆã—ãŸ Prometheus ã® remote-write URL ã‚’è¨­å®šã™ã‚‹ REMOTE_WRITE_URL: apsWorkspaceRemoteUrl, }, logging: new ecs.AwsLogDriver({ streamPrefix: `/${projectName}/prometheus-agent`, logRetention: logs.RetentionDays.ONE_DAY, }), }); // Grafana ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä½œæˆã™ã‚‹ const grafanaDashboardTaskDefinition = new ecs.FargateTaskDefinition( this, `${projectName}-grafana-taskdef`, { family: `${projectName}-grafana-taskdef`, } ); // Grafana ã®ã‚¿ã‚¹ã‚¯ãŒ Prometheus Query ã‚’å©ã‘ã‚‹ã‚ˆã†ã«æ¨©é™ä»˜ä¸ã™ã‚‹ grafanaDashboardTaskDefinition.taskRole.addManagedPolicy( iam.ManagedPolicy.fromAwsManagedPolicyName(\"AmazonPrometheusQueryAccess\") ); // Grafana ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã€‚ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã«ã¯ dashboard ã‚’è¨­å®šã™ã‚‹ const grafanaDashboardContainerName = `${projectName}-grafana-dashboard`; grafanaDashboardTaskDefinition.addContainer(grafanaDashboardContainerName, { containerName: grafanaDashboardContainerName, image: ecs.ContainerImage.fromRegistry(\"public.ecr.aws/ubuntu/grafana\"), environment: { AWS_SDK_LOAD_CONFIG: \"true\", GF_AUTH_SIGV4_AUTH_ENABLED: \"true\", GF_SERVER_SERVE_FROM_SUB_PATH: \"true\", GF_SERVER_ROOT_URL: \"%(protocol)s://%(domain)s/dashboard\", }, portMappings: [{ containerPort: 3000 }], memoryLimitMiB: 512, logging: new ecs.AwsLogDriver({ streamPrefix: `/${projectName}/grafana-dashboard`, logRetention: logs.RetentionDays.ONE_DAY, }), }); const grafanaDashboardServiceName = `${projectName}-grafana-dashboard-service`; const grafanaDashboardService = new ecs.FargateService( this, grafanaDashboardServiceName, { serviceName: grafanaDashboardServiceName, cluster: fargateService.cluster, taskDefinition: grafanaDashboardTaskDefinition, desiredCount: 1, } ); // Grafana ã®ã‚¿ã‚¹ã‚¯ã‚’ ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã‚‹ fargateService.listener.addTargets( `${projectName}-grafana-dashboard-target`, { priority: 1, conditions: [elbv2.ListenerCondition.pathPatterns([\"/dashboard/*\"])], healthCheck: { path: \"/dashboard/login\", interval: Duration.seconds(10), timeout: Duration.seconds(8), healthyThresholdCount: 2, unhealthyThresholdCount: 3, healthyHttpCodes: \"200\", }, port: 3000, protocol: elbv2.ApplicationProtocol.HTTP, targets: [grafanaDashboardService], } ); } } ãã®å¾Œã€cdk deploy ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚\nCDK ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®æ§˜å­\nãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã®ã‚’ç¢ºèªã—ãŸã‚‰ã€Outputs ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ PrometheusAgentTestStack.prometheusagenttestfargateserviceServiceURL\u003cè­˜åˆ¥å­\u003e ã® URL æœ«å°¾ã« /metrics ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ http://\u003cè­˜åˆ¥å­\u003e.ap-northeast-1.elb.amazonaws.com ã«ãªã‚Šã¾ã™ã€‚\nã¤ã¾ã‚Šã€http://\u003cè­˜åˆ¥å­\u003e.ap-northeast-1.elb.amazonaws.com/metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚\nALB çµŒç”±ã§ Node.js ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã™ã‚‹\nã¾ãŸã€Outputs ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ PrometheusAgentTestStack.promremotewriteurl ã¯å¾Œã«åˆ©ç”¨ã™ã‚‹ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã§ä½¿ç”¨ã™ã‚‹ã®ã§æ§ãˆã¦ãŠãã¾ã™ã€‚\nã“ã“ã¾ã§ã§ AWS CDK ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ä½œæ¥­ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æœ€å¾Œã« Grafana ã§ AMP ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚\nGrafana ã§ Prometheus (AMP) ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ å…ˆã»ã©ã® /metrics ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åŒæ§˜ã€Outputs ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®æœ«å°¾ã« /dashboard/login ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚Grafana ã®åˆæœŸãƒ¦ãƒ¼ã‚¶ãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ admin ã¨ãªã‚Šã¾ã™ã€‚\nã¤ã¾ã‚Šã€http://\u003cè­˜åˆ¥å­\u003e.ap-northeast-1.elb.amazonaws.com/dashboard/login ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚\nãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ­£ã—ã‘ã‚Œã°ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§æ–°ãŸãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’çµ‚ãˆã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ã€Prometheus (AMP) ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹ãŸã‚ã«ä¸‹è¨˜ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã€‚\n1. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ Data sources ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\n2. Add data source ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\n3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Prometheus ã‚’é¸æŠã™ã‚‹\n4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹\nPrometheus (AMP) ã«é€ä¿¡ã—ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€å®Ÿéš›ã« Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¾ã™ã€‚æ‰‹ã£å–ã‚Šæ—©ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ NodeJS Application Dashboard ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚\n1. + ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Import ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\n2. NodeJS Application Dashboard ã® ID ã‚’å…¥åŠ›ã—ã¦ Load ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\n3. å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ NodeJS Application Dashboard ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹\n4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒç¢ºèªã§ãã‚‹\nã“ã“ã¾ã§ã®æ‰‹é †ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å¯è¦–åŒ–ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€è² è·ã«å¿œã˜ã¦å®Ÿéš›ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå¤‰åŒ–ã™ã‚‹æ§˜å­ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚Vegeta ã‚’åˆ©ç”¨ã—ã¦ã€å®Ÿéš›ã«è² è·ã‚’ã‹ã‘ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\necho 'GET http://\u003cè­˜åˆ¥å­\u003e.ap-northeast-1.elb.amazonaws.com/metrics' | vegeta attack -duration=5s | vegeta report ãã®å¾Œã€å†ã³ Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã«ã„ãã¾ã™ã€‚è² è·ã‚’ã‹ã‘ãŸæ™‚é–“å¸¯ã®ã¿ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚\nãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® CPU ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã£ãŸã“ã¨ã‚’ç¢ºèªã§ãã‚‹\nãŠã‚ã‚Šã« ä»Šå›ã¯ ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã§ Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã€ãã‚Œã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚\nECS ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª ã®åˆ©ç”¨ãŒå¯èƒ½ãªãŸã‚ã€Prometheus ã® ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã®è¨­å®š ã‚’è¡Œã†ã“ã¨ã§ã€å˜ä¸€ã® Prometheus ã§å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ‰±ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚\nã¾ãŸ Node.js ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹éš›ã«åˆ©ç”¨ã—ãŸ prom-client ã§ ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ç›£è¦–ã—ãŸã„é …ç›®ã‚’è‡ªç”±ã«å¢—ã‚„ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚\næœ¬è¨˜äº‹ãŒ ECS Fargate ã‚’ç›£è¦–ã™ã‚‹éš›ã®æ¤œè¨ææ–™ã® 1 ã¤ã¨ãªã‚ŒãŸã‚‰å¹¸ã„ã§ã™ã€‚\nå‚è€ƒãƒªãƒ³ã‚¯ AWS Fargateï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ç®¡ç†ãŒä¸è¦ãªã‚³ãƒ³ãƒ†ãƒŠã®ä½¿ç”¨ï¼‰| AWS Introducing Prometheus Agent Mode, an Efficient and Cloud-Native Way for Metric Forwarding | Prometheus Amazon Managed Service for Prometheus | ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ Prometheus | Amazon Web Services Grafana: The open observability platform | Grafana Labs AWS ã‚¯ãƒ©ã‚¦ãƒ‰é–‹ç™ºã‚­ãƒƒãƒˆ â€“ ã‚¢ãƒã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹ siimon/prom-client: Prometheus client for node.js tsenart/vegeta: HTTP load testing tool and library. Itâ€™s over 9000! NodeJS Application Dashboard dashboard for Grafana | Grafana Labs ","wordCount":"1139","inLanguage":"ja","image":"https://i.gyazo.com/a6905ee24a684da236b8360697098672.png","datePublished":"2021-12-05T00:00:00Z","dateModified":"2021-12-05T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"},"publisher":{"@type":"Organization","name":"Nikaeraintokyo.","logo":{"@type":"ImageObject","url":"https://nikaera.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://nikaera.com/ accesskey=h title="Nikaeraintokyo. (Alt + H)">Nikaeraintokyo.</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://nikaera.tumblr.com/ title="Music ğŸµ" target=_blank rel="noopener noreferrer"><span>Music ğŸµ</span></a></li><li><span>|</span></li><li><a href=https://nikaera.com/archives/ title="Archives ğŸ—„ï¸"><span>Archives ğŸ—„ï¸</span></a></li><li><a href=https://nikaera.com/rss_feeds/ title="RSS Feeds ğŸ”–"><span>RSS Feeds ğŸ”–</span></a></li><li><a href=https://nikaera.com/profile/ title="Profile ğŸ‘¦"><span>Profile ğŸ‘¦</span></a></li><li><a href=https://nikaera.com/portfolio/ title="Portfolio ğŸ’¼"><span>Portfolio ğŸ’¼</span></a></li><li><a href=https://nikaera.com/contact/ title="Contact ğŸ“¥"><span>Contact ğŸ“¥</span></a></li><li><a href=https://nikaera.com/search/ title="Search ğŸ”"><span>Search ğŸ”</span></a></li></ul></nav></header><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TEECMFQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TEECMFQW")</script><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹</h1><div class=post-meta><span title='2021-12-05 00:00:00 +0000 UTC'>12æœˆ 5, 2021</span>&nbsp;Â·&nbsp;6 åˆ†&nbsp;Â·&nbsp;Me
<span style=text-align:right;margin-left:auto;font-size:1em>Originally published at <a href=https://zenn.dev/nikaera/articles/aws-ecs-fargate-amp-grafana target=_blank rel="noopener noreferrer">zenn.dev</a></span></div></header><figure class=entry-cover><img loading=lazy src=https://i.gyazo.com/a6905ee24a684da236b8360697098672.png alt="ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã®ç”»é¢ã§ç¢ºèªã—ã¦ã„ã‚‹æ§˜å­"></figure><div class=post-content><h1 id=ã¯ã˜ã‚ã«>ã¯ã˜ã‚ã«<a hidden class=anchor aria-hidden=true href=#ã¯ã˜ã‚ã«>#</a></h1><p>ã“ã®è¨˜äº‹ã¯ <a href=https://qiita.com/advent-calendar/2021/aws>AWS Advent Calendar 2021</a> ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚</p><p><a href=https://aws.amazon.com/jp/fargate/>Fargate</a> ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ <a href=https://prometheus.io/blog/2021/11/16/agent/>Prometheus Agent</a> ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€<a href=https://aws.amazon.com/jp/prometheus/>Amazon Managed Service for Prometheus (AMP)</a> ã«é€ä¿¡ã—ã¦ <a href=https://grafana.com/>Grafana</a> ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚</p><p>ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  <a href=https://prometheus.io/blog/2021/11/16/agent/#prometheus-agent-mode>å®Ÿé¨“çš„ãªæ©Ÿèƒ½</a> ãªãŸã‚ã€<strong>å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚</strong></p><p>æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ <a href=https://aws.amazon.com/jp/cdk/>AWS CDK</a> ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p><h1 id=å‹•ä½œç’°å¢ƒ>å‹•ä½œç’°å¢ƒ<a hidden class=anchor aria-hidden=true href=#å‹•ä½œç’°å¢ƒ>#</a></h1><ul><li>Node.js v16.13.0</li><li>AWS CDK 2.0.0 (build 4b6ce31)</li><li>Prometheus 2.32.1</li></ul><h1 id=ç’°å¢ƒæ§‹ç¯‰>ç’°å¢ƒæ§‹ç¯‰<a hidden class=anchor aria-hidden=true href=#ç’°å¢ƒæ§‹ç¯‰>#</a></h1><p><del>æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)</del></p><p><strong><a href=https://docs.aws.amazon.com/cdk/api/latest/docs/aws-aps-readme.html><code>aws-aps</code></a> ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ AWS CDK ã‹ã‚‰ã§ã‚‚ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã“ã¨ç¢ºèªã§ãã¾ã—ãŸã®ã§ã€ãã¡ã‚‰ã®åˆ©ç”¨ã‚’æ¨å¥¨ã„ãŸã—ã¾ã™&mldr; ğŸ™‡ğŸ™‡</strong></p><p><strong><a href=/archives/aws-ecs-fargate-amp-grafana/#ecs-fargate-%e4%b8%8a%e3%81%a7-node.js-%e3%82%a2%e3%83%97%e3%83%aa%e3%81%8a%e3%82%88%e3%81%b3-prometheus-agent-%e3%82%92%e5%8b%95%e4%bd%9c%e3%81%95%e3%81%9b%e3%82%8b>lib/prometheus-agent-test-stack.ts</a> ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¿®æ­£æ¸ˆã¿ã§ AWS CDK ã§ Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ç·¨é›†ã—ã¾ã—ãŸã€‚(2021/12/18 è¿½è¨˜)</strong></p><h2 id=æ‰‹å‹•ã§-amp-ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æ‰‹é †><del>æ‰‹å‹•ã§ AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æ‰‹é †</del><a hidden class=anchor aria-hidden=true href=#æ‰‹å‹•ã§-amp-ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æ‰‹é †>#</a></h2><p>ã¾ãšã€<a href=https://ap-northeast-1.console.aws.amazon.com/prometheus/home>AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢</a> ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚</p><p><img alt="AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹" loading=lazy src=https://i.gyazo.com/bf30611d6bc0f6b93281fd80123b611e.png>
<strong>1. <a href=https://ap-northeast-1.console.aws.amazon.com/prometheus/home>AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢</a> ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹</strong></p><p><img alt="2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹" loading=lazy src=https://i.gyazo.com/7199bed8693832b26f4594bcf5541c86.png>
<strong>2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹</strong></p><p><img alt="3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã" loading=lazy src=https://i.gyazo.com/e32231b46a716aaeb37c8ef88a02e434.png>
<strong>3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã</strong></p><p>AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® <code>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL</code> ã¯ã€<strong>Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚</strong></p><h2 id=aws-cdk-ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹>AWS CDK ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#aws-cdk-ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹>#</a></h2><p>CDK ã§æ§‹ç¯‰ä½œæ¥­ã‚’é€²ã‚ã¾ã™ã€‚ã¾ãšã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ CDK ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ä½¿ç”¨è¨€èªã¯ <code>TypeScript</code> ã‚’é¸æŠã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir prometheus-agent-test <span style=color:#f92672>&amp;&amp;</span> cd prometheus-agent-test
</span></span><span style=display:flex><span>cdk init --language typescript
</span></span></code></pre></div><p>ã¾ãš CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãå‰ã«ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ†ã‚¹ãƒˆç”¨ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚</p><h3 id=ecs-fargate-ã§å‹•ã‹ã™-nodejs-ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹>ECS Fargate ã§å‹•ã‹ã™ Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#ecs-fargate-ã§å‹•ã‹ã™-nodejs-ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹>#</a></h3><p><a href=https://github.com/siimon/prom-client>prom-client</a> ã‚’åˆ©ç”¨ã—ã¦ã€Node.js ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ãã‚‹ã ã‘ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚<code>prometheus-agent-test</code> ãƒ•ã‚©ãƒ«ãƒ€ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir metrics-app <span style=color:#f92672>&amp;&amp;</span> cd metrics-app
</span></span><span style=display:flex><span>npm init -y
</span></span><span style=display:flex><span>npm install --save prom-client
</span></span></code></pre></div><p>æ¬¡ã« <code>metrics-app</code> ãƒ•ã‚©ãƒ«ãƒ€å†…ã« <code>index.js</code> ã‚’ä½œæˆã—ã¦ä¸‹è¨˜ã‚’ç·¨é›†ã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// metrics-app/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>&#34;use strict&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;http&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;prom-client&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>register</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Registry</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 5ç§’é–“éš”ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>collectDefaultMetrics</span>({ <span style=color:#a6e22e>register</span>, <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;request&#34;</span>, <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// /metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰ã€Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿”ã™
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>url</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;/metrics&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>setHeader</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#a6e22e>register</span>.<span style=color:#a6e22e>contentType</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>register</span>.<span style=color:#a6e22e>metrics</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>metrics</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>404</span>, { <span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text/plain&#34;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>8080</span>);
</span></span></code></pre></div><p><code>node index.js</code> ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ <code>http://localhost:8080/metrics</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã®ã‚ˆã†ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ãŒç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚</p><p><img alt="Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­" loading=lazy src=https://i.gyazo.com/a5feae6dba9a9f4eaecae0055dd9be9e.png>
<strong>Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­</strong></p><p>ä»Šå›ã¯ ECS ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€<code>Dockerfile</code> ã‚‚ä½œæˆã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># metrics-app/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> public.ecr.aws/docker/library/node:16-alpine3.12 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install --max-old-space-size<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;index.js&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>ä¸Šè¨˜ <code>Dockerfile</code> ä½œæˆå¾Œã€å†ã³å‹•ä½œæ¤œè¨¼ã®ãŸã‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€<code>http://localhost:8080/metrics</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t prometheus-agent-test/metrics-app .
</span></span><span style=display:flex><span>docker run -p 8080:8080 prometheus-agent-test/metrics-app:latest
</span></span></code></pre></div><p>å…ˆã»ã©ã¨åŒæ§˜ã« <code>http://localhost:8080/metrics</code> ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ã‚’ç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚</p><h3 id=nodejs-ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹-prometheus-agent-ã‚’æº–å‚™ã™ã‚‹>Node.js ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹ Prometheus Agent ã‚’æº–å‚™ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#nodejs-ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹-prometheus-agent-ã‚’æº–å‚™ã™ã‚‹>#</a></h3><p>ã¾ãšã¯ Prometheus é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚<code>prometheus-agent-test</code> ãƒ•ã‚©ãƒ«ãƒ€å†…ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir prometheus-agent <span style=color:#f92672>&amp;&amp;</span> cd prometheus-agent
</span></span></code></pre></div><p>æ¬¡ã« Prometheus ã®è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ <a href=https://atmarkit.itmedia.co.jp/ait/articles/1610/18/news008.html><code>sed</code></a> ã‚’åˆ©ç”¨ã—ã¦ä¸­èº«ã® <code>__TASK_ID__</code> ãŠã‚ˆã³ <code>__REMOTE_WRITE_URL__</code> ã‚’æ›¸ãæ›ãˆã¦åˆ©ç”¨ã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># prometheus-agent/prometheus.tmpl.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>external_labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>monitor</span>: <span style=color:#e6db74>&#34;prometheus&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#34;prometheus-agent-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#34;localhost:8080&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#75715e># ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® localhost:8080 ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹ã¨ã€</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åˆ¤åˆ¥ãŒã—ã¥ã‚‰ããªã‚‹ãŸã‚ ECS Task ã® ID ã‚’åˆ©ç”¨ã™ã‚‹</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>instance</span>: <span style=color:#e6db74>&#34;__TASK_ID__&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote_write</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆæ™‚ã«æ§ãˆã¦ãŠã„ãŸã€</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># `ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL` ã‚’è¨­å®šã™ã‚‹ç®‡æ‰€</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;__REMOTE_WRITE_URL__&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sigv4</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>region</span>: <span style=color:#ae81ff>ap-northeast-1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>queue_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>max_samples_per_send</span>: <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>max_shards</span>: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>capacity</span>: <span style=color:#ae81ff>2500</span>
</span></span></code></pre></div><p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ Prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€Prometheus Agent ã‚’èµ·å‹•ã•ã›ã‚‹ãŸã‚ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># prometheus-agent/docker-entrypoint.sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$taskId<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ECS Fargate ã§èµ·å‹•ã—ãŸã‚¿ã‚¹ã‚¯ ID ã‚’å–å¾—ã™ã‚‹</span>
</span></span><span style=display:flex><span>  taskId<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl --silent <span style=color:#e6db74>${</span>ECS_CONTAINER_METADATA_URI<span style=color:#e6db74>}</span>/task | jq -r <span style=color:#e6db74>&#39;.TaskARN | split(&#34;/&#34;) | .[-1]&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;waiting...&#34;</span>
</span></span><span style=display:flex><span>  sleep <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;taskId: </span><span style=color:#e6db74>${</span>taskId<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;remoteWriteUrl: </span><span style=color:#e6db74>${</span>REMOTE_WRITE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># ã‚¿ã‚¹ã‚¯ ID `taskId` ãŠã‚ˆã³ã€ç’°å¢ƒå¤‰æ•° `REMOTE_WRITE_URL` ã§ã€</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prometheus ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« `prometheus.tmpl.yml` ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã€</span>
</span></span><span style=display:flex><span><span style=color:#75715e># ãã®çµæœã‚’ `/etc/prometheus/prometheus.yml` ã«å‡ºåŠ›ã™ã‚‹</span>
</span></span><span style=display:flex><span>cat /etc/prometheus/prometheus.tmpl.yml | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed <span style=color:#e6db74>&#34;s/__TASK_ID__/</span><span style=color:#e6db74>${</span>taskId<span style=color:#e6db74>}</span><span style=color:#e6db74>/g&#34;</span> | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed <span style=color:#e6db74>&#34;s&gt;__REMOTE_WRITE_URL__&gt;</span><span style=color:#e6db74>${</span>REMOTE_WRITE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&gt;g&#34;</span> &gt; /etc/prometheus/prometheus.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --enable-feature=agent ã§ Prometheus ã‚’ Agent ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã™ã‚‹</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prometheus ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä¸Šè¨˜ã§å‡ºåŠ›ã—ãŸ `/etc/prometheus/prometheus.yml` ã‚’åˆ©ç”¨ã™ã‚‹</span>
</span></span><span style=display:flex><span>/usr/local/bin/prometheus <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-feature<span style=color:#f92672>=</span>agent <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --config.file<span style=color:#f92672>=</span>/etc/prometheus/prometheus.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --web.console.libraries<span style=color:#f92672>=</span>/etc/prometheus/console_libraries <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --web.console.templates<span style=color:#f92672>=</span>/etc/prometheus/consoles
</span></span></code></pre></div><p>ã“ã‚Œã§ Prometheus Agent èµ·å‹•ã®ãŸã‚ã®æº–å‚™ã¯æ•´ã£ãŸãŸã‚ã€æœ€å¾Œã« <code>Dockerfile</code> ã‚’æº–å‚™ã—ã¾ã™ã€‚ã¡ãªã¿ã« Prometheus Agent ã¯ <code>v2.32.0</code> ä»¥é™ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚<strong>æœ¬è¨˜äº‹ã§ã¯ <code>v2.32.1</code> ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># prometheus-agent/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> --platform=arm64 alpine:3.15</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> prometheus.tmpl.yml /etc/prometheus/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --update --no-cache jq sed curl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ARM64 ã§å‹•ä½œã™ã‚‹ Prometheus v2.32.1 ã‚’ curl ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±•é–‹ã™ã‚‹</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl -sL -O https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-arm64.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> tar -zxvf prometheus-2.32.1.linux-arm64.tar.gz <span style=color:#f92672>&amp;&amp;</span> rm prometheus-2.32.1.linux-arm64.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># `prometheus` ã‚³ãƒãƒ³ãƒ‰ã‚’ `/usr/local/bin/prometheus` ã«ç§»å‹•ã™ã‚‹</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv prometheus-2.32.1.linux-arm64/prometheus /usr/local/bin/prometheus<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /docker-entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>ã“ã“ã¾ã§ã§ CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚’é€²ã‚ã¦ã„ããŸã‚ã®ä¸‹æº–å‚™ã¯å®Œäº†ã§ã™ã€‚</p><h3 id=ecs-fargate-ä¸Šã§-nodejs-ã‚¢ãƒ—ãƒªãŠã‚ˆã³-prometheus-agent-ã‚’å‹•ä½œã•ã›ã‚‹>ECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agent ã‚’å‹•ä½œã•ã›ã‚‹<a hidden class=anchor aria-hidden=true href=#ecs-fargate-ä¸Šã§-nodejs-ã‚¢ãƒ—ãƒªãŠã‚ˆã³-prometheus-agent-ã‚’å‹•ä½œã•ã›ã‚‹>#</a></h3><p>ã‚ã¨ã¯ CDK ã§ ECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agentã€Grafana ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ•´å‚™ã—ã¦ã„ãã¾ã™ã€‚</p><p><code>lib/prometheus-agent-test-stack.ts</code> ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// lib/prometheus-agent-test-stack.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Construct</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;constructs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Stack</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>StackProps</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_ecs</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_logs</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>logs</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_aps</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>aps</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_ecs_patterns</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs_patterns</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_iam</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>iam</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_elasticloadbalancingv2</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>elbv2</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Duration</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CfnOutput</span>,
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;aws-cdk-lib&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrometheusAgentTestStack</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Stack</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>Construct</span>, <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>props?</span>: <span style=color:#66d9ef>StackProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(<span style=color:#a6e22e>scope</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>props</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Node.js ã‚¢ãƒ—ãƒªã« ecs_patterns.ApplicationLoadBalancedFargateService ã‚’åˆ©ç”¨ã—ã¦ ALB çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>projectName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;prometheus-agent-test&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fargateService</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs_patterns</span>.<span style=color:#a6e22e>ApplicationLoadBalancedFargateService</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-fargate-service`</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-fargate-service`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cpu</span>: <span style=color:#66d9ef>256</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>desiredCount</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>listenerPort</span>: <span style=color:#66d9ef>80</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>taskImageOptions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>family</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-taskdef`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromAsset</span>(<span style=color:#e6db74>&#34;metrics-app&#34;</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>8080</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>logDriver</span>: <span style=color:#66d9ef>ecs.LogDrivers.awsLogs</span>({
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/metrics-app`</span>,
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>            }),
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cluster</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>Cluster</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster`</span>, {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>clusterName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster`</span>,
</span></span><span style=display:flex><span>          }),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>memoryLimitMiB</span>: <span style=color:#66d9ef>512</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>targetGroup</span>.<span style=color:#a6e22e>configureHealthCheck</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/metrics&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>interval</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>healthyThresholdCount</span>: <span style=color:#66d9ef>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>unhealthyThresholdCount</span>: <span style=color:#66d9ef>4</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>healthyHttpCodes</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;200&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æœ¬è³ªã§ã¯ãªã„ãŒã€Gravition2 ã§å‹•ä½œã•ã›ãŸã„ãŸã‚ã« RuntimePlatform ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã—ã¦ã„ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fargateServiceTaskdef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>defaultChild</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>CfnTaskDefinition</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fargateServiceTaskdef</span>.<span style=color:#a6e22e>addPropertyOverride</span>(<span style=color:#e6db74>&#34;RuntimePlatform&#34;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>CpuArchitecture</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ARM64&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>OperatingSystemFamily</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;LINUX&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// AMP ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>taskRole</span>.<span style=color:#a6e22e>addManagedPolicy</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>ManagedPolicy</span>.<span style=color:#a6e22e>fromAwsManagedPolicyName</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;AmazonPrometheusRemoteWriteAccess&#34;</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (2021/12/18) Amazon Managed Service for Prometheus ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã€Prometheus ã® remote-write URL ã‚’å–å¾—ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apsWorkspace</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>aps</span>.<span style=color:#a6e22e>CfnWorkspace</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prom-workspace`</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>alias</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prom-workspace`</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apsWorkspaceRemoteUrl</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>apsWorkspace</span>.<span style=color:#a6e22e>attrPrometheusEndpoint</span><span style=color:#e6db74>}</span><span style=color:#e6db74>api/v1/remote_write`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (2021/12/18) æœ¬è¨˜äº‹ã§é »å‡ºã™ã‚‹ &#34;ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL&#34; ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CfnOutput</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#34;prom-remote-write-url&#34;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>apsWorkspaceRemoteUrl</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Prometheus Workspace ã® remote-write URL&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exportName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PromRemoteWriteURL&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// AMP ã¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã® Prometheus Agent ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>containerName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prometheus-agent`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>addContainer</span>(<span style=color:#a6e22e>containerName</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>containerName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromAsset</span>(<span style=color:#e6db74>&#34;prometheus-agent&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>memoryReservationMiB</span>: <span style=color:#66d9ef>128</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// (2021/12/18) CDK çµŒç”±ã§ä½œæˆã—ãŸ Prometheus ã® remote-write URL ã‚’è¨­å®šã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>REMOTE_WRITE_URL</span>: <span style=color:#66d9ef>apsWorkspaceRemoteUrl</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logging</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>AwsLogDriver</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/prometheus-agent`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä½œæˆã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>FargateTaskDefinition</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-taskdef`</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>family</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-taskdef`</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana ã®ã‚¿ã‚¹ã‚¯ãŒ Prometheus Query ã‚’å©ã‘ã‚‹ã‚ˆã†ã«æ¨©é™ä»˜ä¸ã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span>.<span style=color:#a6e22e>taskRole</span>.<span style=color:#a6e22e>addManagedPolicy</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>ManagedPolicy</span>.<span style=color:#a6e22e>fromAwsManagedPolicyName</span>(<span style=color:#e6db74>&#34;AmazonPrometheusQueryAccess&#34;</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã€‚ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã«ã¯ dashboard ã‚’è¨­å®šã™ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardContainerName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span>.<span style=color:#a6e22e>addContainer</span>(<span style=color:#a6e22e>grafanaDashboardContainerName</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>containerName</span>: <span style=color:#66d9ef>grafanaDashboardContainerName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromRegistry</span>(<span style=color:#e6db74>&#34;public.ecr.aws/ubuntu/grafana&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>AWS_SDK_LOAD_CONFIG</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>GF_AUTH_SIGV4_AUTH_ENABLED</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>GF_SERVER_SERVE_FROM_SUB_PATH</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>GF_SERVER_ROOT_URL</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;%(protocol)s://%(domain)s/dashboard&#34;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>portMappings</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>3000</span> }],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>memoryLimitMiB</span>: <span style=color:#66d9ef>512</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logging</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>AwsLogDriver</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/grafana-dashboard`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardServiceName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard-service`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>FargateService</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>grafanaDashboardServiceName</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>serviceName</span>: <span style=color:#66d9ef>grafanaDashboardServiceName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cluster</span>: <span style=color:#66d9ef>fargateService.cluster</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>taskDefinition</span>: <span style=color:#66d9ef>grafanaDashboardTaskDefinition</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>desiredCount</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana ã®ã‚¿ã‚¹ã‚¯ã‚’ ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã‚‹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>listener</span>.<span style=color:#a6e22e>addTargets</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard-target`</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>priority</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conditions</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>elbv2</span>.<span style=color:#a6e22e>ListenerCondition</span>.<span style=color:#a6e22e>pathPatterns</span>([<span style=color:#e6db74>&#34;/dashboard/*&#34;</span>])],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthCheck</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/dashboard/login&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>interval</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>healthyThresholdCount</span>: <span style=color:#66d9ef>2</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>unhealthyThresholdCount</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>healthyHttpCodes</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;200&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>3000</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>elbv2.ApplicationProtocol.HTTP</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>targets</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>grafanaDashboardService</span>],
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ãã®å¾Œã€<code>cdk deploy</code> ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p><p><img alt="CDK ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®æ§˜å­" loading=lazy src=https://i.gyazo.com/c7da0f6c6b5a57edee47ae20a8026f8f.png>
<strong>CDK ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®æ§˜å­</strong></p><p>ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã®ã‚’ç¢ºèªã—ãŸã‚‰ã€<code>Outputs</code> ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ <strong><code>PrometheusAgentTestStack.prometheusagenttestfargateserviceServiceURL&lt;è­˜åˆ¥å­></code> ã® URL æœ«å°¾ã« <code>/metrics</code> ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚</strong> å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ <code>http://&lt;è­˜åˆ¥å­>.ap-northeast-1.elb.amazonaws.com</code> ã«ãªã‚Šã¾ã™ã€‚</p><p>ã¤ã¾ã‚Šã€<strong><code>http://&lt;è­˜åˆ¥å­>.ap-northeast-1.elb.amazonaws.com/metrics</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚</strong></p><p><img alt="ALB çµŒç”±ã§ Node.js ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã™ã‚‹" loading=lazy src=https://i.gyazo.com/c13a2b0efc3bb96e79b4f1f5a2886a8a.png>
<strong>ALB çµŒç”±ã§ Node.js ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã™ã‚‹</strong></p><p>ã¾ãŸã€<code>Outputs</code> ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ <strong><code>PrometheusAgentTestStack.promremotewriteurl</code> ã¯å¾Œã«åˆ©ç”¨ã™ã‚‹ <code>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL</code> ã§ä½¿ç”¨ã™ã‚‹ã®ã§æ§ãˆã¦ãŠãã¾ã™ã€‚</strong></p><p>ã“ã“ã¾ã§ã§ AWS CDK ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ä½œæ¥­ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æœ€å¾Œã« Grafana ã§ AMP ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚</p><h1 id=grafana-ã§-prometheus-amp-ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹>Grafana ã§ Prometheus (AMP) ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#grafana-ã§-prometheus-amp-ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹>#</a></h1><p>å…ˆã»ã©ã® <code>/metrics</code> ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åŒæ§˜ã€<code>Outputs</code> ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®æœ«å°¾ã« <code>/dashboard/login</code> ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚<strong>Grafana ã®åˆæœŸãƒ¦ãƒ¼ã‚¶ãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ <code>admin</code> ã¨ãªã‚Šã¾ã™ã€‚</strong></p><p>ã¤ã¾ã‚Šã€<code>http://&lt;è­˜åˆ¥å­>.ap-northeast-1.elb.amazonaws.com/dashboard/login</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚</p><p><img alt=ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã† loading=lazy src=https://i.gyazo.com/fe4ea6515f54dec23234e10a93023a36.png></p><p>ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ­£ã—ã‘ã‚Œã°ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§æ–°ãŸãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’çµ‚ãˆã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ã€Prometheus (AMP) ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹ãŸã‚ã«ä¸‹è¨˜ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã€‚</p><p><img alt="1. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ <code>Data sources</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹" loading=lazy src=https://i.gyazo.com/599d49e4167ccc35c5d44d5df7678036.png>
<strong>1. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ <code>Data sources</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img alt="2. <code>Add data source</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹" loading=lazy src=https://i.gyazo.com/e88bfc58a35deaa16a16920a5e551837.png>
<strong>2. <code>Add data source</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img alt="3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Prometheus ã‚’é¸æŠã™ã‚‹" loading=lazy src=https://i.gyazo.com/1c8031a3182f03e20194bf0b76e66e5a.png>
<strong>3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Prometheus ã‚’é¸æŠã™ã‚‹</strong></p><p><img alt="4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹" loading=lazy src=https://i.gyazo.com/1684c1fca9decb29e60bd654400fd06b.png></p><p><img alt="4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹" loading=lazy src=https://i.gyazo.com/2119361eac350044e783ed0c9280580a.png></p><p><img alt="4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹" loading=lazy src=https://i.gyazo.com/00cc7edbfc45dbd43ad3b0cccea72c7d.png>
<strong>4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹</strong></p><p>Prometheus (AMP) ã«é€ä¿¡ã—ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€å®Ÿéš›ã« Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¾ã™ã€‚æ‰‹ã£å–ã‚Šæ—©ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ <a href=https://grafana.com/grafana/dashboards/11159>NodeJS Application Dashboard</a> ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚</p><p><img alt="1. + ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€<code>Import</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹" loading=lazy src=https://i.gyazo.com/b36c0281e273e21fc9474666786281c3.png>
<strong>1. + ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€<code>Import</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img alt="2. <code>NodeJS Application Dashboard</code> ã® ID ã‚’å…¥åŠ›ã—ã¦ <code>Load</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹" loading=lazy src=https://i.gyazo.com/130718dff8b86758acb415764bd37338.png>
<strong>2. <code>NodeJS Application Dashboard</code> ã® ID ã‚’å…¥åŠ›ã—ã¦ <code>Load</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img alt="3. å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ <code>NodeJS Application Dashboard</code> ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹" loading=lazy src=https://i.gyazo.com/2aa8903f3f64d8021699cd5d4bfa9757.png>
<strong>3. å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ <code>NodeJS Application Dashboard</code> ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹</strong></p><p><img alt="4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ Prometheus ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒç¢ºèªã§ãã‚‹" loading=lazy src=https://i.gyazo.com/1378b09c281da28653917ee40494dee8.png>
<strong>4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒç¢ºèªã§ãã‚‹</strong></p><p>ã“ã“ã¾ã§ã®æ‰‹é †ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å¯è¦–åŒ–ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€è² è·ã«å¿œã˜ã¦å®Ÿéš›ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå¤‰åŒ–ã™ã‚‹æ§˜å­ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚<a href=https://github.com/tsenart/vegeta>Vegeta</a> ã‚’åˆ©ç”¨ã—ã¦ã€å®Ÿéš›ã«è² è·ã‚’ã‹ã‘ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;GET http://&lt;è­˜åˆ¥å­&gt;.ap-northeast-1.elb.amazonaws.com/metrics&#39;</span> | vegeta attack -duration<span style=color:#f92672>=</span>5s | vegeta report
</span></span></code></pre></div><p>ãã®å¾Œã€å†ã³ Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã«ã„ãã¾ã™ã€‚è² è·ã‚’ã‹ã‘ãŸæ™‚é–“å¸¯ã®ã¿ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚</p><p><img alt="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® CPU ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã£ãŸã“ã¨ã‚’ç¢ºèªã§ãã‚‹" loading=lazy src=https://i.gyazo.com/d019d33d3e4bd321ae4d1f4bbecc6ef8.png>
<strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® CPU ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã£ãŸã“ã¨ã‚’ç¢ºèªã§ãã‚‹</strong></p><h1 id=ãŠã‚ã‚Šã«>ãŠã‚ã‚Šã«<a hidden class=anchor aria-hidden=true href=#ãŠã‚ã‚Šã«>#</a></h1><p>ä»Šå›ã¯ ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã§ Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã€ãã‚Œã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚</p><p>ECS ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ <a href=https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/service-discovery.html>ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª</a> ã®åˆ©ç”¨ãŒå¯èƒ½ãªãŸã‚ã€Prometheus ã® <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config>ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã®è¨­å®š</a> ã‚’è¡Œã†ã“ã¨ã§ã€å˜ä¸€ã® Prometheus ã§å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ‰±ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p><p>ã¾ãŸ Node.js ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹éš›ã«åˆ©ç”¨ã—ãŸ <code>prom-client</code> ã§ <a href=https://github.com/siimon/prom-client#custom-metrics>ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹</a> ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ç›£è¦–ã—ãŸã„é …ç›®ã‚’è‡ªç”±ã«å¢—ã‚„ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p><p>æœ¬è¨˜äº‹ãŒ ECS Fargate ã‚’ç›£è¦–ã™ã‚‹éš›ã®æ¤œè¨ææ–™ã® 1 ã¤ã¨ãªã‚ŒãŸã‚‰å¹¸ã„ã§ã™ã€‚</p><h1 id=å‚è€ƒãƒªãƒ³ã‚¯>å‚è€ƒãƒªãƒ³ã‚¯<a hidden class=anchor aria-hidden=true href=#å‚è€ƒãƒªãƒ³ã‚¯>#</a></h1><ul><li><a href=https://aws.amazon.com/jp/fargate/>AWS Fargateï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ç®¡ç†ãŒä¸è¦ãªã‚³ãƒ³ãƒ†ãƒŠã®ä½¿ç”¨ï¼‰| AWS</a></li><li><a href=https://prometheus.io/blog/2021/11/16/agent/>Introducing Prometheus Agent Mode, an Efficient and Cloud-Native Way for Metric Forwarding | Prometheus</a></li><li><a href=https://aws.amazon.com/jp/prometheus/>Amazon Managed Service for Prometheus | ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ Prometheus | Amazon Web Services</a></li><li><a href=https://grafana.com/>Grafana: The open observability platform | Grafana Labs</a></li><li><a href=https://aws.amazon.com/jp/cdk/>AWS ã‚¯ãƒ©ã‚¦ãƒ‰é–‹ç™ºã‚­ãƒƒãƒˆ â€“ ã‚¢ãƒã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹</a></li><li><a href=https://github.com/siimon/prom-client>siimon/prom-client: Prometheus client for node.js</a></li><li><a href=https://github.com/tsenart/vegeta>tsenart/vegeta: HTTP load testing tool and library. It&rsquo;s over 9000!</a></li><li><a href=https://grafana.com/grafana/dashboards/11159>NodeJS Application Dashboard dashboard for Grafana | Grafana Labs</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://nikaera.com/tags/fargate/>Fargate</a></li><li><a href=https://nikaera.com/tags/prometheus/>Prometheus</a></li><li><a href=https://nikaera.com/tags/grafana/>Grafana</a></li><li><a href=https://nikaera.com/tags/aws/>Aws</a></li><li><a href=https://nikaera.com/tags/nodejs/>Nodejs</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on x" href="https://x.com/intent/tweet/?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&amp;hashtags=fargate%2cprometheus%2cgrafana%2caws%2cnodejs"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&amp;title=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;summary=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;source=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&title=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on whatsapp" href="https://api.whatsapp.com/send?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b%20-%20https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on telegram" href="https://telegram.me/share/url?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on ycombinator" href="https://news.ycombinator.com/submitlink?t=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&u=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://nikaera.com/>Nikaeraintokyo.</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>