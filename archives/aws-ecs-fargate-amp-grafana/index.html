<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ | Nikaeraintokyo.</title><meta name=keywords content="fargate,prometheus,grafana,aws,nodejs"><meta name=description content="ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Fargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
å‹•ä½œç’°å¢ƒ  Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.0-rc.0  ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)
AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ ã¾ãšã€AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
1. AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹
2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã
AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã¯ã€Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚"><meta name=author content="Me"><link rel=canonical href=https://zenn.dev/nikaera/articles/aws-ecs-fargate-amp-grafana><link crossorigin=anonymous href=/assets/css/stylesheet.min.d0c0348c2d0cff14148d0e347258519d8df2ce53ce5ac32c7bd9a549182cb8ae.css integrity="sha256-0MA0jC0M/xQUjQ40clhRnY3yzlPOWsMse9mlSRgsuK4=" rel="preload stylesheet" as=style><link rel=preload href=/profile.jpg as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w=" onload=hljs.initHighlightingOnLoad();></script><link rel=icon href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://nikaera.com/favicon.ico><link rel=apple-touch-icon href=https://nikaera.com/apple-touch-icon.png><link rel=mask-icon href=https://nikaera.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.79.0"><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-33707296-2','auto');ga('send','pageview');}</script><meta property="og:title" content="ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹"><meta property="og:description" content="ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Fargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
å‹•ä½œç’°å¢ƒ  Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.0-rc.0  ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)
AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ ã¾ãšã€AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
1. AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹
2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã
AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã¯ã€Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"><meta property="og:image" content="https://i.gyazo.com/a6905ee24a684da236b8360697098672.png"><meta property="article:section" content="archives"><meta property="article:published_time" content="2021-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-05T00:00:00+00:00"><meta property="og:site_name" content="Nikaeraintokyo."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://i.gyazo.com/a6905ee24a684da236b8360697098672.png"><meta name=twitter:title content="ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹"><meta name=twitter:description content="ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
Fargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚
ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
å‹•ä½œç’°å¢ƒ  Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.0-rc.0  ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)
AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ ã¾ãšã€AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
1. AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹
2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã
AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã¯ã€Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Archives","item":"https://nikaera.com/archives/"},{"@type":"ListItem","position":2,"name":"ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹","item":"https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹","name":"ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹","description":"ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\nFargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚\nã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚\næœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚\nå‹•ä½œç’°å¢ƒ  Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.0-rc.0  ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)\nAMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ ã¾ãšã€AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚\n1. AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹\n2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹\n3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã\nAMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã¯ã€Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚","keywords":["fargate","prometheus","grafana","aws","nodejs"],"articleBody":"ã¯ã˜ã‚ã« ã“ã®è¨˜äº‹ã¯ AWS Advent Calendar 2021 ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚\nFargate ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã¦ Grafana ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚\nã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  å®Ÿé¨“çš„ãªæ©Ÿèƒ½ ãªãŸã‚ã€å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚\næœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ AWS CDK ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚\nå‹•ä½œç’°å¢ƒ  Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.0-rc.0  ç’°å¢ƒæ§‹ç¯‰ æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)\nAMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ ã¾ãšã€AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚\n1. AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹\n2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹\n3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã\nAMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL ã¯ã€Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚\nAWS CDK ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹ AMP ä»¥å¤–ã®ã‚¤ãƒ³ãƒ•ãƒ©ã«ã¤ã„ã¦ã¯ CDK ã§æ§‹ç¯‰ä½œæ¥­ã‚’é€²ã‚ã¾ã™ã€‚ã¾ãšã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ CDK ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ä½¿ç”¨è¨€èªã¯ TypeScript ã‚’é¸æŠã—ã¾ã™ã€‚\nmkdir prometheus-agent-test \u0026\u0026 cd prometheus-agent-test cdk init --language typescript ã¾ãš CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãå‰ã«ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ†ã‚¹ãƒˆç”¨ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚\nECS Fargate ã§å‹•ã‹ã™ Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹ prom-client ã‚’åˆ©ç”¨ã—ã¦ã€Node.js ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ãã‚‹ã ã‘ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚prometheus-agent-test ãƒ•ã‚©ãƒ«ãƒ€ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nmkdir metrics-app \u0026\u0026 cd metrics-app npm init -y npm install --save prom-client æ¬¡ã« metrics-app ãƒ•ã‚©ãƒ«ãƒ€å†…ã« index.js ã‚’ä½œæˆã—ã¦ä¸‹è¨˜ã®ç·¨é›†ã‚’è¡Œã„ã¾ã™ã€‚\n'use strict'; const http = require('http'); const server = http.createServer(); const client = require('prom-client'); const register = new client.Registry() // 5ç§’é–“éš”ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹ client.collectDefaultMetrics({ register, timeout: 5 * 1000 }); server.on('request', async function(req, res) { // /metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰ã€Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿”ã™  if (req.url === '/metrics') { res.setHeader('Content-Type', register.contentType) const metrics = await register.metrics() return res.end(metrics) } else { return res.writeHead(404, {'Content-Type' : 'text/plain'}); } }); server.listen(8080); node index.jsã€€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ http://localhost:8080/metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã®ã‚ˆã†ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ãŒç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚\nPrometheus ã®ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­\nä»Šå›ã¯ ECS ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€Dockerfile ã‚‚ä½œæˆã—ã¾ã™ã€‚\nFROMpublic.ecr.aws/docker/library/node:16-alpine3.12 AS builderEXPOSE8080WORKDIR/usr/src/appCOPY package*.json ./RUN npm install --max-old-space-size=4096COPY . .CMD [ \"node\", \"index.js\" ]ä¸Šè¨˜ Dockerfile ä½œæˆå¾Œã€å†ã³å‹•ä½œæ¤œè¨¼ã®ãŸã‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€http://localhost:8080/metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚\ndocker build -t prometheus-agent-test/metrics-app . docker run -p 8080:8080 prometheus-agent-test/metrics-app:latest å…ˆã»ã©ã¨åŒæ§˜ã« http://localhost:8080/metrics ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ã‚’ç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚\nNode.js ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹ Prometheus Agent ã‚’æº–å‚™ã™ã‚‹ ã¾ãšã¯ Prometheus é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚prometheus-agent-test ãƒ•ã‚©ãƒ«ãƒ€å†…ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\nmkdir prometheus-agent \u0026\u0026 cd prometheus-agent æ¬¡ã« Prometheus ã®è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ sed ã‚’åˆ©ç”¨ã—ã¦ä¸­èº«ã® __TASK_ID__ ãŠã‚ˆã³ __REMOTE_WRITE_URL__ ã‚’æ›¸ãæ›ãˆã¦åˆ©ç”¨ã—ã¾ã™ã€‚\nglobal: scrape_interval: 5s external_labels: monitor: 'prometheus' scrape_configs: - job_name: 'prometheus-agent-test' static_configs: - targets: ['localhost:8080'] labels: # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® localhost:8080 ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹ã¨ã€ # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åˆ¤åˆ¥ãŒã—ã¥ã‚‰ããªã‚‹ãŸã‚ ECS Task ã® ID ã‚’åˆ©ç”¨ã™ã‚‹ instance: '__TASK_ID__' remote_write: # AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆæ™‚ã«æ§ãˆã¦ãŠã„ãŸã€ # `ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL` ã‚’è¨­å®šã™ã‚‹ç®‡æ‰€ - url: '__REMOTE_WRITE_URL__' sigv4: region: ap-northeast-1 queue_config: max_samples_per_send: 1000 max_shards: 200 capacity: 2500 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ Prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€Prometheus Agent ã‚’èµ·å‹•ã•ã›ã‚‹ãŸã‚ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\n#!/bin/sh  while [ -z \"$taskId\" ] do # ECS Fargate ã§èµ·å‹•ã—ãŸã‚¿ã‚¹ã‚¯ ID ã‚’å–å¾—ã™ã‚‹ taskId=$(curl --silent ${ECS_CONTAINER_METADATA_URI}/task | jq -r '.TaskARN | split(\"/\") | .[-1]') echo \"waiting...\" sleep 1 done echo \"taskId: ${taskId}\" echo \"remoteWriteUrl: ${REMOTE_WRITE_URL}\" # ã‚¿ã‚¹ã‚¯ ID `taskId` ãŠã‚ˆã³ã€ç’°å¢ƒå¤‰æ•° `REMOTE_WRITE_URL` ã§ã€ # Prometheus ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« `prometheus.tmpl.yml` ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã€ # ãã®çµæœã‚’ `/etc/prometheus/prometheus.yml` ã«å‡ºåŠ›ã™ã‚‹ cat /etc/prometheus/prometheus.tmpl.yml | \\  sed \"s/__TASK_ID__/${taskId}/g\" | \\  sed \"s__REMOTE_WRITE_URL__${REMOTE_WRITE_URL}g\"  /etc/prometheus/prometheus.yml # --enable-feature=agent ã§ Prometheus ã‚’ Agent ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã™ã‚‹ # Prometheus ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä¸Šè¨˜ã§å‡ºåŠ›ã—ãŸ `/etc/prometheus/prometheus.yml` ã‚’åˆ©ç”¨ã™ã‚‹ /usr/local/bin/prometheus \\  --enable-feature=agent \\  --config.file=/etc/prometheus/prometheus.yml \\  --web.console.libraries=/etc/prometheus/console_libraries \\  --web.console.templates=/etc/prometheus/consoles ã“ã‚Œã§ Prometheus Agent èµ·å‹•ã®ãŸã‚ã®æº–å‚™ã¯æ•´ã£ãŸãŸã‚ã€æœ€å¾Œã« Dockerfile ã‚’æº–å‚™ã—ã¾ã™ã€‚ã¡ãªã¿ã« Prometheus Agent ã¯ v2.32.0 ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚\nFROM--platform=arm64 alpine:3.15ADD prometheus.tmpl.yml /etc/prometheus/RUN apk add --update --no-cache jq sed curl# ARM64 ã§å‹•ä½œã™ã‚‹ Prometheus v2.32.0 ã‚’ curl ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±•é–‹ã™ã‚‹RUN curl -sL -O https://github.com/prometheus/prometheus/releases/download/v2.32.0-rc.0/prometheus-2.32.0-rc.0.linux-arm64.tar.gzRUN tar -zxvf prometheus-2.32.0-rc.0.linux-arm64.tar.gz \u0026\u0026 rm prometheus-2.32.0-rc.0.linux-arm64.tar.gz# `prometheus` ã‚³ãƒãƒ³ãƒ‰ã‚’ `/usr/local/bin/prometheus` ã«ç§»å‹•ã™ã‚‹RUN mv prometheus-2.32.0-rc.0.linux-arm64/prometheus /usr/local/bin/prometheusCOPY ./docker-entrypoint.sh /RUN chmod +x /docker-entrypoint.shCMD [\"/docker-entrypoint.sh\"]ã“ã“ã¾ã§ã§ CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚’é€²ã‚ã¦ã„ããŸã‚ã®ä¸‹æº–å‚™ã¯å®Œäº†ã§ã™ã€‚\nECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agent ã‚’å‹•ä½œã•ã›ã‚‹ ã‚ã¨ã¯ CDK ã§ ECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agentã€Grafana ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ•´å‚™ã—ã¦ã„ãã¾ã™ã€‚\nlib/prometheus-agent-test-stack.ts ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚\nimport { Construct } from 'constructs'; import { Stack, StackProps, aws_ecs as ecs, aws_logs as logs, aws_ecs_patterns as ecs_patterns, aws_iam as iam, aws_elasticloadbalancingv2 as elbv2, Duration, } from 'aws-cdk-lib'; export class PrometheusAgentTestStack extends Stack { constructor(scope: Construct, id: string, props?: StackProps) { super(scope, id, props); // Node.js ã‚¢ãƒ—ãƒªã« ecs_patterns.ApplicationLoadBalancedFargateService ã‚’åˆ©ç”¨ã—ã¦ ALB çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹  const projectName = 'prometheus-agent-test'; const fargateService = new ecs_patterns.ApplicationLoadBalancedFargateService(this, `${projectName}-fargate-service`, { serviceName: `${projectName}-fargate-service`, cpu: 256, desiredCount: 3, listenerPort: 80, taskImageOptions: { family: `${projectName}-taskdef`, image: ecs.ContainerImage.fromAsset('metrics-app'), containerPort: 8080, logDriver: ecs.LogDrivers.awsLogs({ streamPrefix: `/${projectName}/metrics-app`, logRetention: logs.RetentionDays.ONE_DAY }) }, cluster: new ecs.Cluster(this, `${projectName}-cluster`, { clusterName: `${projectName}-cluster` }), memoryLimitMiB: 512, }); fargateService.targetGroup.configureHealthCheck({ path: \"/metrics\", timeout: Duration.seconds(8), interval: Duration.seconds(10), healthyThresholdCount: 2, unhealthyThresholdCount: 4, healthyHttpCodes: \"200\", }); // æœ¬è³ªã§ã¯ãªã„ãŒã€Gravition2 ã§å‹•ä½œã•ã›ãŸã„ãŸã‚ã« RuntimePlatform ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã—ã¦ã„ã‚‹  const fargateServiceTaskdef = fargateService.taskDefinition.node.defaultChild as ecs.CfnTaskDefinition fargateServiceTaskdef.addPropertyOverride('RuntimePlatform', { CpuArchitecture: \"ARM64\", OperatingSystemFamily: \"LINUX\" }); // AMP ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹  fargateService.taskDefinition.taskRole.addManagedPolicy( iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonPrometheusRemoteWriteAccess') ) // AMP ã¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã® Prometheus Agent ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹  const containerName = `${projectName}-prometheus-agent` fargateService.taskDefinition.addContainer(containerName, { containerName, image: ecs.ContainerImage.fromAsset('prometheus-agent'), memoryReservationMiB: 128, environment: { REMOTE_WRITE_URL: '' }, logging: new ecs.AwsLogDriver({ streamPrefix: `/${projectName}/prometheus-agent`, logRetention: logs.RetentionDays.ONE_DAY, }) }); // Grafana ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä½œæˆã™ã‚‹  const grafanaDashboardTaskDefinition = new ecs.FargateTaskDefinition(this, `${projectName}-grafana-taskdef`, { family: `${projectName}-grafana-taskdef` }); // Grafana ã®ã‚¿ã‚¹ã‚¯ãŒ Prometheus Query ã‚’å©ã‘ã‚‹ã‚ˆã†ã«æ¨©é™ä»˜ä¸ã™ã‚‹  grafanaDashboardTaskDefinition.taskRole.addManagedPolicy( iam.ManagedPolicy.fromAwsManagedPolicyName('AmazonPrometheusQueryAccess') ) // Grafana ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã€‚ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã«ã¯ dashboard ã‚’è¨­å®šã™ã‚‹  const grafanaDashboardContainerName = `${projectName}-grafana-dashboard` grafanaDashboardTaskDefinition.addContainer(grafanaDashboardContainerName, { containerName: grafanaDashboardContainerName, image: ecs.ContainerImage.fromRegistry('public.ecr.aws/ubuntu/grafana'), environment: { AWS_SDK_LOAD_CONFIG: 'true', GF_AUTH_SIGV4_AUTH_ENABLED: 'true', GF_SERVER_SERVE_FROM_SUB_PATH: 'true', GF_SERVER_ROOT_URL: '%(protocol)s://%(domain)s/dashboard' }, portMappings: [{ containerPort: 3000 }], memoryLimitMiB: 512, logging: new ecs.AwsLogDriver({ streamPrefix: `/${projectName}/grafana-dashboard`, logRetention: logs.RetentionDays.ONE_DAY, }) }); const grafanaDashboardServiceName = `${projectName}-grafana-dashboard-service` const grafanaDashboardService = new ecs.FargateService(this, grafanaDashboardServiceName, { serviceName: grafanaDashboardServiceName, cluster: fargateService.cluster, taskDefinition: grafanaDashboardTaskDefinition, desiredCount: 1 }); // Grafana ã®ã‚¿ã‚¹ã‚¯ã‚’ ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã‚‹  fargateService.listener.addTargets(`${projectName}-grafana-dashboard-target`, { priority: 1, conditions: [ elbv2.ListenerCondition.pathPatterns(['/dashboard/*']), ], healthCheck: { path: '/dashboard/login', interval: Duration.seconds(10), timeout: Duration.seconds(8), healthyThresholdCount: 2, unhealthyThresholdCount: 3, healthyHttpCodes: \"200\" }, port: 3000, protocol: elbv2.ApplicationProtocol.HTTP, targets: [grafanaDashboardService], }); } } ãã®å¾Œã€cdk deploy ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚\nCDK ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®æ§˜å­\nãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€Outputs ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®æœ«å°¾ã« /metrics ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ http://.ap-northeast-1.elb.amazonaws.com ã«ãªã‚Šã¾ã™ã€‚\nã¤ã¾ã‚Šã€http://.ap-northeast-1.elb.amazonaws.com/metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚\nALB çµŒç”±ã§ Node.js ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã™ã‚‹\nã“ã“ã¾ã§ã§ AWS CDK ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ä½œæ¥­ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æœ€å¾Œã« Grafana ã§ AMP ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚\nGrafana ã§ Prometheus (AMP) ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ å…ˆã»ã©ã® /metrics ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åŒæ§˜ã€Outputs ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®æœ«å°¾ã« /dashboard/login ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚Grafana ã®åˆæœŸãƒ¦ãƒ¼ã‚¶ãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ admin ã¨ãªã‚Šã¾ã™ã€‚\nã¤ã¾ã‚Šã€http://.ap-northeast-1.elb.amazonaws.com/dashboard/login ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚\nãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ­£ã—ã‘ã‚Œã°ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§æ–°ãŸãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’çµ‚ãˆã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ã€Prometheus (AMP) ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹ãŸã‚ã«ä¸‹è¨˜ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã€‚\nData sources ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\" / 1. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ Data sources ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\nAdd data source ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\" / 2. Add data source ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\n3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Prometheus ã‚’é¸æŠã™ã‚‹\n4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹\nPrometheus (AMP) ã«é€ä¿¡ã—ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€å®Ÿéš›ã« Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¾ã™ã€‚æ‰‹ã£å–ã‚Šæ—©ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ NodeJS Application Dashboard ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚\nImport ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\" / 1. + ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€Import ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\nNodeJS Application Dashboard ã® ID ã‚’å…¥åŠ›ã—ã¦ Load ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\" / 2. NodeJS Application Dashboard ã® ID ã‚’å…¥åŠ›ã—ã¦ Load ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹\nNodeJS Application Dashboard ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹\" / 3. å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ NodeJS Application Dashboard ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹\n4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒç¢ºèªã§ãã‚‹\nã“ã“ã¾ã§ã®æ‰‹é †ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å¯è¦–åŒ–ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€è² è·ã«å¿œã˜ã¦å®Ÿéš›ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå¤‰åŒ–ã™ã‚‹æ§˜å­ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚Vegeta ã‚’åˆ©ç”¨ã—ã¦ã€å®Ÿéš›ã«è² è·ã‚’ã‹ã‘ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚\necho 'GET http://.ap-northeast-1.elb.amazonaws.com/metrics' | vegeta attack -duration=5s | vegeta report ãã®å¾Œã€å†ã³ Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã«ã„ãã¾ã™ã€‚è² è·ã‚’ã‹ã‘ãŸæ™‚é–“å¸¯ã®ã¿ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚\nãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® CPU ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã£ãŸã“ã¨ãŒç¢ºèªã§ãã‚‹\nãŠã‚ã‚Šã« ä»Šå›ã¯ ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã§ Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã€ãã‚Œã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚\nECS ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª ã®åˆ©ç”¨ãŒå¯èƒ½ãªãŸã‚ã€Prometheus ã® ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã®è¨­å®š ã‚’è¡Œã†ã“ã¨ã§ã€å˜ä¸€ã® Prometheus ã§å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ‰±ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚\nã¾ãŸ Node.js ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹éš›ã«åˆ©ç”¨ã—ãŸ prom-client ã§ ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ç›£è¦–ã—ãŸã„é …ç›®ã‚’è‡ªç”±ã«å¢—ã‚„ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚\næœ¬è¨˜äº‹ãŒ ECS Fargate ã®ç›£è¦–ã‚’è¡Œã†éš›ã®æ¤œè¨ææ–™ã® 1 ã¤ã¨ãªã‚ŒãŸã‚‰å¹¸ã„ã§ã™ã€‚\nå‚è€ƒãƒªãƒ³ã‚¯  AWS Fargateï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ç®¡ç†ãŒä¸è¦ãªã‚³ãƒ³ãƒ†ãƒŠã®ä½¿ç”¨ï¼‰| AWS Introducing Prometheus Agent Mode, an Efficient and Cloud-Native Way for Metric Forwarding | Prometheus Amazon Managed Service for Prometheus | ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ Prometheus | Amazon Web Services Grafana: The open observability platform | Grafana Labs AWS ã‚¯ãƒ©ã‚¦ãƒ‰é–‹ç™ºã‚­ãƒƒãƒˆ â€“ ã‚¢ãƒã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹ siimon/prom-client: Prometheus client for node.js tsenart/vegeta: HTTP load testing tool and library. Itâ€™s over 9000! NodeJS Application Dashboard dashboard for Grafana | Grafana Labs  ","wordCount":"997","inLanguage":"ja","image":"https://i.gyazo.com/a6905ee24a684da236b8360697098672.png","datePublished":"2021-12-05T00:00:00Z","dateModified":"2021-12-05T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"},"publisher":{"@type":"Organization","name":"Nikaeraintokyo.","logo":{"@type":"ImageObject","url":"https://nikaera.com/favicon.ico"}}}</script></head><body class=dark id=top><script>if(localStorage.getItem("pref-theme")==="light"){document.body.classList.remove('dark')}</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://nikaera.com/ accesskey=h title="Nikaeraintokyo. (Alt + H)">Nikaeraintokyo.</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://music.nikaera.com/ title="Music ğŸµ" target=_blank rel="noopener noreferrer"><span>Music ğŸµ</span></a></li><li><span>|</span></li><li><a href=https://nikaera.com/archives/ title="Archives ğŸ—„ï¸"><span>Archives ğŸ—„ï¸</span></a></li><li><a href=https://nikaera.com/rss_feeds/ title="RSS Feeds ğŸ”–"><span>RSS Feeds ğŸ”–</span></a></li><li><a href=https://nikaera.com/profile/ title="Profile ğŸ‘¦"><span>Profile ğŸ‘¦</span></a></li><li><a href=https://nikaera.com/portfolio/ title="Portfolio ğŸ’¼"><span>Portfolio ğŸ’¼</span></a></li><li><a href=https://nikaera.com/contact/ title="Contact ğŸ“¥"><span>Contact ğŸ“¥</span></a></li><li><a href=https://nikaera.com/search/ title="Search ğŸ”"><span>Search ğŸ”</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹</h1><div class=post-meta>December 5, 2021&nbsp;Â·&nbsp;5 åˆ†&nbsp;Â·&nbsp;Me
<span style=text-align:right;margin-left:auto;font-size:1em>Originally published at <a href=https://zenn.dev/nikaera/articles/aws-ecs-fargate-amp-grafana target=_blank rel="noopener noreferrer">zenn.dev</a></span></div></header><figure class=entry-cover><img loading=lazy src=https://i.gyazo.com/a6905ee24a684da236b8360697098672.png alt="ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã®ç”»é¢ã§ç¢ºèªã—ã¦ã„ã‚‹æ§˜å­"><p>ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã®ç”»é¢ã§ç¢ºèªã—ã¦ã„ã‚‹æ§˜å­</p></figure><div class=post-content><h1 id=ã¯ã˜ã‚ã«>ã¯ã˜ã‚ã«<a hidden class=anchor aria-hidden=true href=#ã¯ã˜ã‚ã«>#</a></h1><p>ã“ã®è¨˜äº‹ã¯ <a href=https://qiita.com/advent-calendar/2021/aws>AWS Advent Calendar 2021</a> ã® 5 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚</p><p><a href=https://aws.amazon.com/jp/fargate/>Fargate</a> ã§ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ <a href=https://prometheus.io/blog/2021/11/16/agent/>Prometheus Agent</a> ã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦å‹•ã‹ã—ã¦ã€<a href=https://aws.amazon.com/jp/prometheus/>Amazon Managed Service for Prometheus (AMP)</a> ã«é€ä¿¡ã—ã¦ <a href=https://grafana.com/>Grafana</a> ã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚</p><p>ã¡ãªã¿ã« Promethus Agent ã¯ã¾ã  <a href=https://prometheus.io/blog/2021/11/16/agent/#prometheus-agent-mode>å®Ÿé¨“çš„ãªæ©Ÿèƒ½</a> ãªãŸã‚ã€<strong>å®Ÿå‹™ã§ã®åˆ©ç”¨ã¯æ¨å¥¨ã—ã¾ã›ã‚“ã€‚</strong></p><p>æœ¬è¨˜äº‹ã®ç’°å¢ƒæ§‹ç¯‰ã«ã¯ <a href=https://aws.amazon.com/jp/cdk/>AWS CDK</a> ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p><h1 id=å‹•ä½œç’°å¢ƒ>å‹•ä½œç’°å¢ƒ<a hidden class=anchor aria-hidden=true href=#å‹•ä½œç’°å¢ƒ>#</a></h1><ul><li>Node.js v16.13.0</li><li>AWS CDK 2.0.0 (build 4b6ce31)</li><li>Prometheus 2.32.0-rc.0</li></ul><h1 id=ç’°å¢ƒæ§‹ç¯‰>ç’°å¢ƒæ§‹ç¯‰<a hidden class=anchor aria-hidden=true href=#ç’°å¢ƒæ§‹ç¯‰>#</a></h1><p>æ—©é€Ÿç’°å¢ƒæ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚ã¾ã  AMP ã«ã¤ã„ã¦ã¯ CDK ã‹ã‚‰æ“ä½œã§ããªã„ã‚ˆã†ã§ã—ãŸã®ã§ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«ã¤ã„ã¦ã¯ AWS ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ‰‹å‹•ã§è¡Œã„ã¾ã™ã€‚(2021/12/06)</p><h2 id=amp-ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹>AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹<a hidden class=anchor aria-hidden=true href=#amp-ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹>#</a></h2><p>ã¾ãšã€<a href=https://ap-northeast-1.console.aws.amazon.com/prometheus/home>AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢</a> ã«é·ç§»ã—ã¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/bf30611d6bc0f6b93281fd80123b611e.png alt="AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹">
<strong>1. <a href=https://ap-northeast-1.console.aws.amazon.com/prometheus/home>AMP ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢</a> ã‹ã‚‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆç”»é¢ã«é·ç§»ã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/7199bed8693832b26f4594bcf5541c86.png alt="2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹">
<strong>2. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/e32231b46a716aaeb37c8ef88a02e434.png alt="3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã">
<strong>3. AMP ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆå®Œäº†ã‚’ç¢ºèªã™ã‚‹ã¨åŒæ™‚ã«è¨­å®šå€¤ã‚’æ§ãˆã¦ãŠã</strong></p><p>AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã® <code>ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL</code> ã¯ã€<strong>Prometheus Agent ã§ AMP ã«ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã™ã‚‹éš›ã‚„ã€Grafana ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²ã™ã‚‹éš›ãªã©ã«å¿…è¦ã¨ãªã‚‹ãŸã‚æ§ãˆã¦ãŠãã¾ã™ã€‚</strong></p><h2 id=aws-cdk-ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹>AWS CDK ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#aws-cdk-ã§ç’°å¢ƒæ§‹ç¯‰ã™ã‚‹>#</a></h2><p>AMP ä»¥å¤–ã®ã‚¤ãƒ³ãƒ•ãƒ©ã«ã¤ã„ã¦ã¯ CDK ã§æ§‹ç¯‰ä½œæ¥­ã‚’é€²ã‚ã¾ã™ã€‚ã¾ãšã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ CDK ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚ä½¿ç”¨è¨€èªã¯ <code>TypeScript</code> ã‚’é¸æŠã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir prometheus-agent-test <span style=color:#f92672>&amp;&amp;</span> cd prometheus-agent-test
cdk init --language typescript
</code></pre></div><p>ã¾ãš CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã‚’é€²ã‚ã¦ã„ãå‰ã«ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ†ã‚¹ãƒˆç”¨ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚</p><h3 id=ecs-fargate-ã§å‹•ã‹ã™-nodejs-ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹>ECS Fargate ã§å‹•ã‹ã™ Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#ecs-fargate-ã§å‹•ã‹ã™-nodejs-ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã™ã‚‹>#</a></h3><p><a href=https://github.com/siimon/prom-client>prom-client</a> ã‚’åˆ©ç”¨ã—ã¦ã€Node.js ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå–å¾—ã§ãã‚‹ã ã‘ã® Node.js ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¾ã™ã€‚<code>prometheus-agent-test</code> ãƒ•ã‚©ãƒ«ãƒ€ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir metrics-app <span style=color:#f92672>&amp;&amp;</span> cd metrics-app
npm init -y
npm install --save prom-client
</code></pre></div><p>æ¬¡ã« <code>metrics-app</code> ãƒ•ã‚©ãƒ«ãƒ€å†…ã« <code>index.js</code> ã‚’ä½œæˆã—ã¦ä¸‹è¨˜ã®ç·¨é›†ã‚’è¡Œã„ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript:metrics-app/index.js data-lang=javascript:metrics-app/index.js><span style=color:#e6db74>&#39;use strict&#39;</span>;

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>();

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;prom-client&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>register</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Registry</span>()

<span style=color:#75715e>// 5ç§’é–“éš”ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹
</span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>collectDefaultMetrics</span>({ <span style=color:#a6e22e>register</span>, <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span> });

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;request&#39;</span>, <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
    <span style=color:#75715e>// /metrics ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰ã€Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’è¿”ã™
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>url</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;/metrics&#39;</span>) {
        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>setHeader</span>(<span style=color:#e6db74>&#39;Content-Type&#39;</span>, <span style=color:#a6e22e>register</span>.<span style=color:#a6e22e>contentType</span>)

        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>register</span>.<span style=color:#a6e22e>metrics</span>()
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>metrics</span>)
    } <span style=color:#66d9ef>else</span> {
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>404</span>, {<span style=color:#e6db74>&#39;Content-Type&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text/plain&#39;</span>});
    }
});

<span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>8080</span>);
</code></pre></div><p><code>node index.js</code>ã€€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ <code>http://localhost:8080/metrics</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã®ã‚ˆã†ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ãŒç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/a5feae6dba9a9f4eaecae0055dd9be9e.png alt="Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­">
<strong>Prometheus ã®ãƒ¬ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­</strong></p><p>ä»Šå›ã¯ ECS ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€<code>Dockerfile</code> ã‚‚ä½œæˆã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker:metrics-app/Dockerfile data-lang=docker:metrics-app/Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> public.ecr.aws/docker/library/node:16-alpine3.12 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install --max-old-space-size<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;index.js&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>ä¸Šè¨˜ <code>Dockerfile</code> ä½œæˆå¾Œã€å†ã³å‹•ä½œæ¤œè¨¼ã®ãŸã‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€<code>http://localhost:8080/metrics</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t prometheus-agent-test/metrics-app .
docker run -p 8080:8080 prometheus-agent-test/metrics-app:latest
</code></pre></div><p>å…ˆã»ã©ã¨åŒæ§˜ã« <code>http://localhost:8080/metrics</code> ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å„ç¨®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹æ§˜å­ã‚’ç¢ºèªã§ãã‚Œã° OK ã§ã™ã€‚</p><h3 id=nodejs-ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹-prometheus-agent-ã‚’æº–å‚™ã™ã‚‹>Node.js ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹ Prometheus Agent ã‚’æº–å‚™ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#nodejs-ã‚¢ãƒ—ãƒªã‚’ç›£è¦–ã™ã‚‹-prometheus-agent-ã‚’æº–å‚™ã™ã‚‹>#</a></h3><p>ã¾ãšã¯ Prometheus é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚<code>prometheus-agent-test</code> ãƒ•ã‚©ãƒ«ãƒ€å†…ã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir prometheus-agent <span style=color:#f92672>&amp;&amp;</span> cd prometheus-agent
</code></pre></div><p>æ¬¡ã« Prometheus ã®è¨­å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ <a href=https://atmarkit.itmedia.co.jp/ait/articles/1610/18/news008.html><code>sed</code></a> ã‚’åˆ©ç”¨ã—ã¦ä¸­èº«ã® <code>__TASK_ID__</code> ãŠã‚ˆã³ <code>__REMOTE_WRITE_URL__</code> ã‚’æ›¸ãæ›ãˆã¦åˆ©ç”¨ã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml:prometheus-agent/prometheus.tmpl.yml data-lang=yaml:prometheus-agent/prometheus.tmpl.yml><span style=color:#f92672>global</span>:
  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
  <span style=color:#f92672>external_labels</span>:
    <span style=color:#f92672>monitor</span>: <span style=color:#e6db74>&#39;prometheus&#39;</span>

<span style=color:#f92672>scrape_configs</span>:
  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#39;prometheus-agent-test&#39;</span>
    <span style=color:#f92672>static_configs</span>:
      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#39;localhost:8080&#39;</span>]
        <span style=color:#f92672>labels</span>:
          <span style=color:#75715e># ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® localhost:8080 ãŒã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹ã¨ã€</span>
          <span style=color:#75715e># ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åˆ¤åˆ¥ãŒã—ã¥ã‚‰ããªã‚‹ãŸã‚ ECS Task ã® ID ã‚’åˆ©ç”¨ã™ã‚‹</span>
          <span style=color:#f92672>instance</span>: <span style=color:#e6db74>&#39;__TASK_ID__&#39;</span>

<span style=color:#f92672>remote_write</span>:
  <span style=color:#75715e># AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆæ™‚ã«æ§ãˆã¦ãŠã„ãŸã€</span>
  <span style=color:#75715e># `ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL` ã‚’è¨­å®šã™ã‚‹ç®‡æ‰€</span>
  - <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#39;__REMOTE_WRITE_URL__&#39;</span>
    <span style=color:#f92672>sigv4</span>:
      <span style=color:#f92672>region</span>: <span style=color:#ae81ff>ap-northeast-1</span>
    <span style=color:#f92672>queue_config</span>:
      <span style=color:#f92672>max_samples_per_send</span>: <span style=color:#ae81ff>1000</span>
      <span style=color:#f92672>max_shards</span>: <span style=color:#ae81ff>200</span>
      <span style=color:#f92672>capacity</span>: <span style=color:#ae81ff>2500</span>

</code></pre></div><p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ Prometheus ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€Prometheus Agent ã‚’èµ·å‹•ã•ã›ã‚‹ãŸã‚ã®ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh:prometheus-agent/docker-entrypoint.sh data-lang=sh:prometheus-agent/docker-entrypoint.sh><span style=color:#75715e>#!/bin/sh
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>while</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$taskId<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
<span style=color:#66d9ef>do</span>
  <span style=color:#75715e># ECS Fargate ã§èµ·å‹•ã—ãŸã‚¿ã‚¹ã‚¯ ID ã‚’å–å¾—ã™ã‚‹</span>
  taskId<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl --silent <span style=color:#e6db74>${</span>ECS_CONTAINER_METADATA_URI<span style=color:#e6db74>}</span>/task | jq -r <span style=color:#e6db74>&#39;.TaskARN | split(&#34;/&#34;) | .[-1]&#39;</span><span style=color:#66d9ef>)</span>

  echo <span style=color:#e6db74>&#34;waiting...&#34;</span>
  sleep <span style=color:#ae81ff>1</span>
<span style=color:#66d9ef>done</span>

echo <span style=color:#e6db74>&#34;taskId: </span><span style=color:#e6db74>${</span>taskId<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
echo <span style=color:#e6db74>&#34;remoteWriteUrl: </span><span style=color:#e6db74>${</span>REMOTE_WRITE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># ã‚¿ã‚¹ã‚¯ ID `taskId` ãŠã‚ˆã³ã€ç’°å¢ƒå¤‰æ•° `REMOTE_WRITE_URL` ã§ã€</span>
<span style=color:#75715e># Prometheus ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ« `prometheus.tmpl.yml` ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã€</span>
<span style=color:#75715e># ãã®çµæœã‚’ `/etc/prometheus/prometheus.yml` ã«å‡ºåŠ›ã™ã‚‹</span>
cat /etc/prometheus/prometheus.tmpl.yml | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    sed <span style=color:#e6db74>&#34;s/__TASK_ID__/</span><span style=color:#e6db74>${</span>taskId<span style=color:#e6db74>}</span><span style=color:#e6db74>/g&#34;</span> | <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    sed <span style=color:#e6db74>&#34;s&gt;__REMOTE_WRITE_URL__&gt;</span><span style=color:#e6db74>${</span>REMOTE_WRITE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&gt;g&#34;</span> &gt; /etc/prometheus/prometheus.yml

<span style=color:#75715e># --enable-feature=agent ã§ Prometheus ã‚’ Agent ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã™ã‚‹</span>
<span style=color:#75715e># Prometheus ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ä¸Šè¨˜ã§å‡ºåŠ›ã—ãŸ `/etc/prometheus/prometheus.yml` ã‚’åˆ©ç”¨ã™ã‚‹</span>
/usr/local/bin/prometheus <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --enable-feature<span style=color:#f92672>=</span>agent <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --config.file<span style=color:#f92672>=</span>/etc/prometheus/prometheus.yml <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --web.console.libraries<span style=color:#f92672>=</span>/etc/prometheus/console_libraries <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>    --web.console.templates<span style=color:#f92672>=</span>/etc/prometheus/consoles

</code></pre></div><p>ã“ã‚Œã§ Prometheus Agent èµ·å‹•ã®ãŸã‚ã®æº–å‚™ã¯æ•´ã£ãŸãŸã‚ã€æœ€å¾Œã« <code>Dockerfile</code> ã‚’æº–å‚™ã—ã¾ã™ã€‚ã¡ãªã¿ã« Prometheus Agent ã¯ <code>v2.32.0</code> ã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker:prometheus-agent/Dockerfile data-lang=docker:prometheus-agent/Dockerfile><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> --platform=arm64 alpine:3.15</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> prometheus.tmpl.yml /etc/prometheus/<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --update --no-cache jq sed curl<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ARM64 ã§å‹•ä½œã™ã‚‹ Prometheus v2.32.0 ã‚’ curl ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±•é–‹ã™ã‚‹</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl -sL -O https://github.com/prometheus/prometheus/releases/download/v2.32.0-rc.0/prometheus-2.32.0-rc.0.linux-arm64.tar.gz<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> tar -zxvf prometheus-2.32.0-rc.0.linux-arm64.tar.gz <span style=color:#f92672>&amp;&amp;</span> rm prometheus-2.32.0-rc.0.linux-arm64.tar.gz<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># `prometheus` ã‚³ãƒãƒ³ãƒ‰ã‚’ `/usr/local/bin/prometheus` ã«ç§»å‹•ã™ã‚‹</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv prometheus-2.32.0-rc.0.linux-arm64/prometheus /usr/local/bin/prometheus<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /docker-entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>ã“ã“ã¾ã§ã§ CDK ã§ã‚¤ãƒ³ãƒ•ãƒ©æ•´å‚™ã‚’é€²ã‚ã¦ã„ããŸã‚ã®ä¸‹æº–å‚™ã¯å®Œäº†ã§ã™ã€‚</p><h3 id=ecs-fargate-ä¸Šã§-nodejs-ã‚¢ãƒ—ãƒªãŠã‚ˆã³-prometheus-agent-ã‚’å‹•ä½œã•ã›ã‚‹>ECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agent ã‚’å‹•ä½œã•ã›ã‚‹<a hidden class=anchor aria-hidden=true href=#ecs-fargate-ä¸Šã§-nodejs-ã‚¢ãƒ—ãƒªãŠã‚ˆã³-prometheus-agent-ã‚’å‹•ä½œã•ã›ã‚‹>#</a></h3><p>ã‚ã¨ã¯ CDK ã§ ECS Fargate ä¸Šã§ Node.js ã‚¢ãƒ—ãƒªãŠã‚ˆã³ Prometheus Agentã€Grafana ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã®ç’°å¢ƒã‚’æ•´å‚™ã—ã¦ã„ãã¾ã™ã€‚</p><p><code>lib/prometheus-agent-test-stack.ts</code> ã®å†…å®¹ã‚’æ›¸ãæ›ãˆã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript:lib/prometheus-agent-test-stack.ts data-lang=typescript:lib/prometheus-agent-test-stack.ts><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Construct</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;constructs&#39;</span>;
<span style=color:#66d9ef>import</span> {
  <span style=color:#a6e22e>Stack</span>,
  <span style=color:#a6e22e>StackProps</span>,
  <span style=color:#a6e22e>aws_ecs</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs</span>,
  <span style=color:#a6e22e>aws_logs</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>logs</span>,
  <span style=color:#a6e22e>aws_ecs_patterns</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs_patterns</span>,
  <span style=color:#a6e22e>aws_iam</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>iam</span>,
  <span style=color:#a6e22e>aws_elasticloadbalancingv2</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>elbv2</span>,
  <span style=color:#a6e22e>Duration</span>,
} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;aws-cdk-lib&#39;</span>;

<span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrometheusAgentTestStack</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Stack</span> {
  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>Construct</span>, <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>props?</span>: <span style=color:#66d9ef>StackProps</span>) {
    <span style=color:#66d9ef>super</span>(<span style=color:#a6e22e>scope</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>props</span>);

    <span style=color:#75715e>// Node.js ã‚¢ãƒ—ãƒªã« ecs_patterns.ApplicationLoadBalancedFargateService ã‚’åˆ©ç”¨ã—ã¦ ALB çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>projectName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;prometheus-agent-test&#39;</span>;
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fargateService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs_patterns</span>.<span style=color:#a6e22e>ApplicationLoadBalancedFargateService</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-fargate-service`</span>, {
      <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-fargate-service`</span>,
      <span style=color:#a6e22e>cpu</span>: <span style=color:#66d9ef>256</span>,
      <span style=color:#a6e22e>desiredCount</span>: <span style=color:#66d9ef>3</span>,
      <span style=color:#a6e22e>listenerPort</span>: <span style=color:#66d9ef>80</span>,
      <span style=color:#a6e22e>taskImageOptions</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>family</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-taskdef`</span>,
        <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromAsset</span>(<span style=color:#e6db74>&#39;metrics-app&#39;</span>),
        <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>8080</span>,
        <span style=color:#a6e22e>logDriver</span>: <span style=color:#66d9ef>ecs.LogDrivers.awsLogs</span>({
          <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/metrics-app`</span>,
          <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>
        })
      },
      <span style=color:#a6e22e>cluster</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>Cluster</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster`</span>, {
        <span style=color:#a6e22e>clusterName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster`</span>
      }),
      <span style=color:#a6e22e>memoryLimitMiB</span>: <span style=color:#66d9ef>512</span>,
    });
    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>targetGroup</span>.<span style=color:#a6e22e>configureHealthCheck</span>({
      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/metrics&#34;</span>,
      <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>8</span>),
      <span style=color:#a6e22e>interval</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>10</span>),
      <span style=color:#a6e22e>healthyThresholdCount</span>: <span style=color:#66d9ef>2</span>,
      <span style=color:#a6e22e>unhealthyThresholdCount</span>: <span style=color:#66d9ef>4</span>,
      <span style=color:#a6e22e>healthyHttpCodes</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;200&#34;</span>,
    });

    <span style=color:#75715e>// æœ¬è³ªã§ã¯ãªã„ãŒã€Gravition2 ã§å‹•ä½œã•ã›ãŸã„ãŸã‚ã« RuntimePlatform ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸Šæ›¸ãã—ã¦ã„ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fargateServiceTaskdef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>defaultChild</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>CfnTaskDefinition</span>
    <span style=color:#a6e22e>fargateServiceTaskdef</span>.<span style=color:#a6e22e>addPropertyOverride</span>(<span style=color:#e6db74>&#39;RuntimePlatform&#39;</span>, {
      <span style=color:#a6e22e>CpuArchitecture</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ARM64&#34;</span>,
      <span style=color:#a6e22e>OperatingSystemFamily</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;LINUX&#34;</span>
    });

    <span style=color:#75715e>// AMP ã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸ã™ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>taskRole</span>.<span style=color:#a6e22e>addManagedPolicy</span>(
      <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>ManagedPolicy</span>.<span style=color:#a6e22e>fromAwsManagedPolicyName</span>(<span style=color:#e6db74>&#39;AmazonPrometheusRemoteWriteAccess&#39;</span>)
    )

    <span style=color:#75715e>// AMP ã¸ãƒ¡ãƒˆãƒªã‚¯ã‚¹æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã® Prometheus Agent ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>containerName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prometheus-agent`</span>
    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>addContainer</span>(<span style=color:#a6e22e>containerName</span>, {
      <span style=color:#a6e22e>containerName</span>,
      <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromAsset</span>(<span style=color:#e6db74>&#39;prometheus-agent&#39;</span>),
      <span style=color:#a6e22e>memoryReservationMiB</span>: <span style=color:#66d9ef>128</span>,
      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>REMOTE_WRITE_URL</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&lt;AMP ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ - ãƒªãƒ¢ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ URL&gt;&#39;</span>
      },
      <span style=color:#a6e22e>logging</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>AwsLogDriver</span>({
        <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/prometheus-agent`</span>,
        <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
      })
    });

    <span style=color:#75715e>// Grafana ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ä½œæˆã™ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>FargateTaskDefinition</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-taskdef`</span>, {
      <span style=color:#a6e22e>family</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-taskdef`</span>
    });
    <span style=color:#75715e>// Grafana ã®ã‚¿ã‚¹ã‚¯ãŒ Prometheus Query ã‚’å©ã‘ã‚‹ã‚ˆã†ã«æ¨©é™ä»˜ä¸ã™ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span>.<span style=color:#a6e22e>taskRole</span>.<span style=color:#a6e22e>addManagedPolicy</span>(
      <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>ManagedPolicy</span>.<span style=color:#a6e22e>fromAwsManagedPolicyName</span>(<span style=color:#e6db74>&#39;AmazonPrometheusQueryAccess&#39;</span>)
    )

    <span style=color:#75715e>// Grafana ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ ã™ã‚‹ã€‚ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã«ã¯ dashboard ã‚’è¨­å®šã™ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardContainerName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard`</span>
    <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span>.<span style=color:#a6e22e>addContainer</span>(<span style=color:#a6e22e>grafanaDashboardContainerName</span>, {
      <span style=color:#a6e22e>containerName</span>: <span style=color:#66d9ef>grafanaDashboardContainerName</span>,
      <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromRegistry</span>(<span style=color:#e6db74>&#39;public.ecr.aws/ubuntu/grafana&#39;</span>),
      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>AWS_SDK_LOAD_CONFIG</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;true&#39;</span>,
        <span style=color:#a6e22e>GF_AUTH_SIGV4_AUTH_ENABLED</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;true&#39;</span>,
        <span style=color:#a6e22e>GF_SERVER_SERVE_FROM_SUB_PATH</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;true&#39;</span>,
        <span style=color:#a6e22e>GF_SERVER_ROOT_URL</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;%(protocol)s://%(domain)s/dashboard&#39;</span>
      },
      <span style=color:#a6e22e>portMappings</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>3000</span> }],
      <span style=color:#a6e22e>memoryLimitMiB</span>: <span style=color:#66d9ef>512</span>,
      <span style=color:#a6e22e>logging</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>AwsLogDriver</span>({
        <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/grafana-dashboard`</span>,
        <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
      })
    });

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardServiceName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard-service`</span>
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>FargateService</span>(<span style=color:#66d9ef>this</span>, <span style=color:#a6e22e>grafanaDashboardServiceName</span>, {
      <span style=color:#a6e22e>serviceName</span>: <span style=color:#66d9ef>grafanaDashboardServiceName</span>,
      <span style=color:#a6e22e>cluster</span>: <span style=color:#66d9ef>fargateService.cluster</span>,
      <span style=color:#a6e22e>taskDefinition</span>: <span style=color:#66d9ef>grafanaDashboardTaskDefinition</span>,
      <span style=color:#a6e22e>desiredCount</span>: <span style=color:#66d9ef>1</span>
    });

    <span style=color:#75715e>// Grafana ã®ã‚¿ã‚¹ã‚¯ã‚’ ALB ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã«ç´ã¥ã‘ã‚‹
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>listener</span>.<span style=color:#a6e22e>addTargets</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard-target`</span>, {
      <span style=color:#a6e22e>priority</span>: <span style=color:#66d9ef>1</span>,
      <span style=color:#a6e22e>conditions</span><span style=color:#f92672>:</span> [
        <span style=color:#a6e22e>elbv2</span>.<span style=color:#a6e22e>ListenerCondition</span>.<span style=color:#a6e22e>pathPatterns</span>([<span style=color:#e6db74>&#39;/dashboard/*&#39;</span>]),
      ],
      <span style=color:#a6e22e>healthCheck</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/dashboard/login&#39;</span>,
        <span style=color:#a6e22e>interval</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>10</span>),
        <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>8</span>),
        <span style=color:#a6e22e>healthyThresholdCount</span>: <span style=color:#66d9ef>2</span>,
        <span style=color:#a6e22e>unhealthyThresholdCount</span>: <span style=color:#66d9ef>3</span>,
        <span style=color:#a6e22e>healthyHttpCodes</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;200&#34;</span>
      },
      <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>3000</span>,
      <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>elbv2.ApplicationProtocol.HTTP</span>,
      <span style=color:#a6e22e>targets</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>grafanaDashboardService</span>],
    });
  }
}

</code></pre></div><p>ãã®å¾Œã€<code>cdk deploy</code> ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/c7da0f6c6b5a57edee47ae20a8026f8f.png alt="CDK ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®æ§˜å­">
<strong>CDK ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚ŒãŸæ™‚ã®æ§˜å­</strong></p><p>ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèªã—ãŸã‚‰ã€<code>Outputs</code> ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®æœ«å°¾ã« <code>/metrics</code> ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯ <code>http://&lt;è­˜åˆ¥å­>.ap-northeast-1.elb.amazonaws.com</code> ã«ãªã‚Šã¾ã™ã€‚</p><p>ã¤ã¾ã‚Šã€<code>http://&lt;è­˜åˆ¥å­>.ap-northeast-1.elb.amazonaws.com/metrics</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/c13a2b0efc3bb96e79b4f1f5a2886a8a.png alt="ALB çµŒç”±ã§ Node.js ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã™ã‚‹">
<strong>ALB çµŒç”±ã§ Node.js ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã™ã‚‹</strong></p><p>ã“ã“ã¾ã§ã§ AWS CDK ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ä½œæ¥­ã¯å®Œäº†ã—ã¾ã—ãŸã€‚æœ€å¾Œã« Grafana ã§ AMP ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ä½œæ¥­ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚</p><h1 id=grafana-ã§-prometheus-amp-ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹>Grafana ã§ Prometheus (AMP) ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹<a hidden class=anchor aria-hidden=true href=#grafana-ã§-prometheus-amp-ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹>#</a></h1><p>å…ˆã»ã©ã® <code>/metrics</code> ãƒ‘ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åŒæ§˜ã€<code>Outputs</code> ã«å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ URL ã®æœ«å°¾ã« <code>/dashboard/login</code> ã‚’ä»˜ä¸ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚<strong>Grafana ã®åˆæœŸãƒ¦ãƒ¼ã‚¶ãŠã‚ˆã³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ <code>admin</code> ã¨ãªã‚Šã¾ã™ã€‚</strong></p><p>ã¤ã¾ã‚Šã€<code>http://&lt;è­˜åˆ¥å­>.ap-northeast-1.elb.amazonaws.com/dashboard/login</code> ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/fe4ea6515f54dec23234e10a93023a36.png alt=ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã†></p><p>ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒæ­£ã—ã‘ã‚Œã°ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§æ–°ãŸãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’çµ‚ãˆã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯ã€Prometheus (AMP) ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹ãŸã‚ã«ä¸‹è¨˜ã®æ“ä½œã‚’è¡Œã„ã¾ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/599d49e4167ccc35c5d44d5df7678036.png alt="1. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ <code>Data sources</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹">
<strong>1. æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ <code>Data sources</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/e88bfc58a35deaa16a16920a5e551837.png alt="2. <code>Add data source</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹">
<strong>2. <code>Add data source</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/1c8031a3182f03e20194bf0b76e66e5a.png alt="3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Prometheus ã‚’é¸æŠã™ã‚‹">
<strong>3. ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦ Prometheus ã‚’é¸æŠã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/1684c1fca9decb29e60bd654400fd06b.png alt="4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹"></p><p><img loading=lazy src=https://i.gyazo.com/2119361eac350044e783ed0c9280580a.png alt="4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹"></p><p><img loading=lazy src=https://i.gyazo.com/00cc7edbfc45dbd43ad3b0cccea72c7d.png alt="4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹">
<strong>4. Prometheus ã‚’ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã¨ã—ã¦è¿½åŠ ã™ã‚‹</strong></p><p>Prometheus (AMP) ã«é€ä¿¡ã—ãŸãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®æº–å‚™ãŒæ•´ã£ãŸã®ã§ã€å®Ÿéš›ã« Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã—ã¦ã¿ã¾ã™ã€‚æ‰‹ã£å–ã‚Šæ—©ããƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã¯ <a href=https://grafana.com/grafana/dashboards/11159>NodeJS Application Dashboard</a> ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/b36c0281e273e21fc9474666786281c3.png alt="1. + ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€<code>Import</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹">
<strong>1. + ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€<code>Import</code> ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/130718dff8b86758acb415764bd37338.png alt="2. <code>NodeJS Application Dashboard</code> ã® ID ã‚’å…¥åŠ›ã—ã¦ <code>Load</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹">
<strong>2. <code>NodeJS Application Dashboard</code> ã® ID ã‚’å…¥åŠ›ã—ã¦ <code>Load</code> ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/2aa8903f3f64d8021699cd5d4bfa9757.png alt="3. å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ <code>NodeJS Application Dashboard</code> ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹">
<strong>3. å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ <code>NodeJS Application Dashboard</code> ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’å®Œäº†ã™ã‚‹</strong></p><p><img loading=lazy src=https://i.gyazo.com/1378b09c281da28653917ee40494dee8.png alt="4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ Prometheus ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒç¢ºèªã§ãã‚‹">
<strong>4. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ Node.js ã‚¢ãƒ—ãƒªã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒç¢ºèªã§ãã‚‹</strong></p><p>ã“ã“ã¾ã§ã®æ‰‹é †ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å¯è¦–åŒ–ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€è² è·ã«å¿œã˜ã¦å®Ÿéš›ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒå¤‰åŒ–ã™ã‚‹æ§˜å­ã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚<a href=https://github.com/tsenart/vegeta>Vegeta</a> ã‚’åˆ©ç”¨ã—ã¦ã€å®Ÿéš›ã«è² è·ã‚’ã‹ã‘ã¦ã¿ã¾ã™ã€‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>echo <span style=color:#e6db74>&#39;GET http://&lt;è­˜åˆ¥å­&gt;.ap-northeast-1.elb.amazonaws.com/metrics&#39;</span> | vegeta attack -duration<span style=color:#f92672>=</span>5s | vegeta report
</code></pre></div><p>ãã®å¾Œã€å†ã³ Grafana ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã«ã„ãã¾ã™ã€‚è² è·ã‚’ã‹ã‘ãŸæ™‚é–“å¸¯ã®ã¿ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚</p><p><img loading=lazy src=https://i.gyazo.com/d019d33d3e4bd321ae4d1f4bbecc6ef8.png alt="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® CPU ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã£ãŸã“ã¨ãŒç¢ºèªã§ãã‚‹">
<strong>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã® CPU ä½¿ç”¨ç‡ã®ã‚°ãƒ©ãƒ•ã«å¤‰åŒ–ãŒã‚ã£ãŸã“ã¨ãŒç¢ºèªã§ãã‚‹</strong></p><h1 id=ãŠã‚ã‚Šã«>ãŠã‚ã‚Šã«<a hidden class=anchor aria-hidden=true href=#ãŠã‚ã‚Šã«>#</a></h1><p>ä»Šå›ã¯ ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ã§ Amazon Managed Service for Prometheus (AMP) ã«é€ä¿¡ã—ã€ãã‚Œã‚’ Grafana ã§å¯è¦–åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚</p><p>ECS ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ <a href=https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/service-discovery.html>ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒª</a> ã®åˆ©ç”¨ãŒå¯èƒ½ãªãŸã‚ã€Prometheus ã® <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config>ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªã®è¨­å®š</a> ã‚’è¡Œã†ã“ã¨ã§ã€å˜ä¸€ã® Prometheus ã§å…¨ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’æ‰±ã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p><p>ã¾ãŸ Node.js ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹éš›ã«åˆ©ç”¨ã—ãŸ <code>prom-client</code> ã§ <a href=https://github.com/siimon/prom-client#custom-metrics>ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹</a> ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ç›£è¦–ã—ãŸã„é …ç›®ã‚’è‡ªç”±ã«å¢—ã‚„ã™ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</p><p>æœ¬è¨˜äº‹ãŒ ECS Fargate ã®ç›£è¦–ã‚’è¡Œã†éš›ã®æ¤œè¨ææ–™ã® 1 ã¤ã¨ãªã‚ŒãŸã‚‰å¹¸ã„ã§ã™ã€‚</p><h1 id=å‚è€ƒãƒªãƒ³ã‚¯>å‚è€ƒãƒªãƒ³ã‚¯<a hidden class=anchor aria-hidden=true href=#å‚è€ƒãƒªãƒ³ã‚¯>#</a></h1><ul><li><a href=https://aws.amazon.com/jp/fargate/>AWS Fargateï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ç®¡ç†ãŒä¸è¦ãªã‚³ãƒ³ãƒ†ãƒŠã®ä½¿ç”¨ï¼‰| AWS</a></li><li><a href=https://prometheus.io/blog/2021/11/16/agent/>Introducing Prometheus Agent Mode, an Efficient and Cloud-Native Way for Metric Forwarding | Prometheus</a></li><li><a href=https://aws.amazon.com/jp/prometheus/>Amazon Managed Service for Prometheus | ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ Prometheus | Amazon Web Services</a></li><li><a href=https://grafana.com/>Grafana: The open observability platform | Grafana Labs</a></li><li><a href=https://aws.amazon.com/jp/cdk/>AWS ã‚¯ãƒ©ã‚¦ãƒ‰é–‹ç™ºã‚­ãƒƒãƒˆ â€“ ã‚¢ãƒã‚¾ãƒ³ ã‚¦ã‚§ãƒ– ã‚µãƒ¼ãƒ“ã‚¹</a></li><li><a href=https://github.com/siimon/prom-client>siimon/prom-client: Prometheus client for node.js</a></li><li><a href=https://github.com/tsenart/vegeta>tsenart/vegeta: HTTP load testing tool and library. It&rsquo;s over 9000!</a></li><li><a href=https://grafana.com/grafana/dashboards/11159>NodeJS Application Dashboard dashboard for Grafana | Grafana Labs</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://nikaera.com/tags/fargate/>fargate</a></li><li><a href=https://nikaera.com/tags/prometheus/>prometheus</a></li><li><a href=https://nikaera.com/tags/grafana/>grafana</a></li><li><a href=https://nikaera.com/tags/aws/>aws</a></li><li><a href=https://nikaera.com/tags/nodejs/>nodejs</a></li></ul><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on twitter" href="https://twitter.com/intent/tweet/?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&hashtags=fargate%2cprometheus%2cgrafana%2caws%2cnodejs"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zm-253.927 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&title=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&summary=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&source=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0v-129.439c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02v-126.056c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768h75.024zm-307.552-334.556c-25.674.0-42.448 16.879-42.448 39.002.0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&title=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zm-119.474 108.193c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zm-160.386-29.702c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978v-192.915h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on whatsapp" href="https://api.whatsapp.com/send?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b%20-%20https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512h-386.892c-34.524.0-62.554-28.03-62.554-62.554v-386.892c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23-13.314-11.876-22.304-26.542-24.916-31.026s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share ğŸ“” ECS Fargate ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus Agent ä½¿ã£ã¦ AMP ã«é€ã£ã¦ Grafana ã§ç›£è¦–ã™ã‚‹ on telegram" href="https://telegram.me/share/url?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47A3.38 3.38.0 0126.49 29.86zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://nikaera.com/>Nikaeraintokyo.</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu')
menu.scrollLeft=localStorage.getItem("menu-scroll-position");menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft);}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener("click",function(e){e.preventDefault();var id=this.getAttribute("href").substr(1);if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({behavior:"smooth"});}else{document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();}
if(id==="top"){history.replaceState(null,null," ");}else{history.pushState(null,null,`#${id}`);}});});</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){if(document.body.scrollTop>800||document.documentElement.scrollTop>800){mybutton.style.visibility="visible";mybutton.style.opacity="1";}else{mybutton.style.visibility="hidden";mybutton.style.opacity="0";}};</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{if(document.body.className.includes("dark")){document.body.classList.remove('dark');localStorage.setItem("pref-theme",'light');}else{document.body.classList.add('dark');localStorage.setItem("pref-theme",'dark');}})</script></body></html>