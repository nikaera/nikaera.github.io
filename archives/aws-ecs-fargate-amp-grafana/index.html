<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する | Nikaeraintokyo.</title><meta name=keywords content="fargate,prometheus,grafana,aws,nodejs"><meta name=description content="はじめに
この記事は AWS Advent Calendar 2021 の 5 日目の記事です。
Fargate で Node.js アプリのメトリクスを Prometheus Agent をサイドカーコンテナとして動かして、Amazon Managed Service for Prometheus (AMP) に送信して Grafana で見られるようにしてみました。
ちなみに Promethus Agent はまだ 実験的な機能 なため、実務での利用は推奨しません。
本記事の環境構築には AWS CDK を利用しています。
動作環境

Node.js v16.13.0
AWS CDK 2.0.0 (build 4b6ce31)
Prometheus 2.32.1

環境構築
早速環境構築を進めていきます。まだ AMP については CDK から操作できないようでしたので、ワークスペースの作成については AWS コンソールから手動で行います。(2021/12/06)
aws-aps を利用することで AWS CDK からでも Amazon Managed Service for Prometheus のワークスペースを作成すること確認できましたので、そちらの利用を推奨いたします&mldr; 🙇🙇
lib/prometheus-agent-test-stack.ts のコードも修正済みで AWS CDK で Amazon Managed Service for Prometheus のワークスペースを作成するように編集しました。(2021/12/18 追記)"><meta name=author content="Me"><link rel=canonical href=https://zenn.dev/nikaera/articles/aws-ecs-fargate-amp-grafana><meta name=google-site-verification content="G-39TEECMFQW"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://nikaera.com/favicon.ico><link rel=apple-touch-icon href=https://nikaera.com/apple-touch-icon.png><link rel=mask-icon href=https://nikaera.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TEECMFQW"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TEECMFQW")}</script><meta property="og:url" content="https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"><meta property="og:site_name" content="Nikaeraintokyo."><meta property="og:title" content="📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する"><meta property="og:description" content="はじめに この記事は AWS Advent Calendar 2021 の 5 日目の記事です。
Fargate で Node.js アプリのメトリクスを Prometheus Agent をサイドカーコンテナとして動かして、Amazon Managed Service for Prometheus (AMP) に送信して Grafana で見られるようにしてみました。
ちなみに Promethus Agent はまだ 実験的な機能 なため、実務での利用は推奨しません。
本記事の環境構築には AWS CDK を利用しています。
動作環境 Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.1 環境構築 早速環境構築を進めていきます。まだ AMP については CDK から操作できないようでしたので、ワークスペースの作成については AWS コンソールから手動で行います。(2021/12/06)
aws-aps を利用することで AWS CDK からでも Amazon Managed Service for Prometheus のワークスペースを作成すること確認できましたので、そちらの利用を推奨いたします… 🙇🙇
lib/prometheus-agent-test-stack.ts のコードも修正済みで AWS CDK で Amazon Managed Service for Prometheus のワークスペースを作成するように編集しました。(2021/12/18 追記)"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="archives"><meta property="article:published_time" content="2021-12-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-05T00:00:00+00:00"><meta property="article:tag" content="Fargate"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Grafana"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Nodejs"><meta property="og:image" content="https://i.gyazo.com/a6905ee24a684da236b8360697098672.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://i.gyazo.com/a6905ee24a684da236b8360697098672.png"><meta name=twitter:title content="📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する"><meta name=twitter:description content="はじめに
この記事は AWS Advent Calendar 2021 の 5 日目の記事です。
Fargate で Node.js アプリのメトリクスを Prometheus Agent をサイドカーコンテナとして動かして、Amazon Managed Service for Prometheus (AMP) に送信して Grafana で見られるようにしてみました。
ちなみに Promethus Agent はまだ 実験的な機能 なため、実務での利用は推奨しません。
本記事の環境構築には AWS CDK を利用しています。
動作環境

Node.js v16.13.0
AWS CDK 2.0.0 (build 4b6ce31)
Prometheus 2.32.1

環境構築
早速環境構築を進めていきます。まだ AMP については CDK から操作できないようでしたので、ワークスペースの作成については AWS コンソールから手動で行います。(2021/12/06)
aws-aps を利用することで AWS CDK からでも Amazon Managed Service for Prometheus のワークスペースを作成すること確認できましたので、そちらの利用を推奨いたします&mldr; 🙇🙇
lib/prometheus-agent-test-stack.ts のコードも修正済みで AWS CDK で Amazon Managed Service for Prometheus のワークスペースを作成するように編集しました。(2021/12/18 追記)"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Archives","item":"https://nikaera.com/archives/"},{"@type":"ListItem","position":2,"name":"📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する","item":"https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する","name":"📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する","description":"はじめに この記事は AWS Advent Calendar 2021 の 5 日目の記事です。\nFargate で Node.js アプリのメトリクスを Prometheus Agent をサイドカーコンテナとして動かして、Amazon Managed Service for Prometheus (AMP) に送信して Grafana で見られるようにしてみました。\nちなみに Promethus Agent はまだ 実験的な機能 なため、実務での利用は推奨しません。\n本記事の環境構築には AWS CDK を利用しています。\n動作環境 Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.1 環境構築 早速環境構築を進めていきます。まだ AMP については CDK から操作できないようでしたので、ワークスペースの作成については AWS コンソールから手動で行います。(2021/12/06)\naws-aps を利用することで AWS CDK からでも Amazon Managed Service for Prometheus のワークスペースを作成すること確認できましたので、そちらの利用を推奨いたします\u0026hellip; 🙇🙇\nlib/prometheus-agent-test-stack.ts のコードも修正済みで AWS CDK で Amazon Managed Service for Prometheus のワークスペースを作成するように編集しました。(2021/12/18 追記)\n","keywords":["fargate","prometheus","grafana","aws","nodejs"],"articleBody":"はじめに この記事は AWS Advent Calendar 2021 の 5 日目の記事です。\nFargate で Node.js アプリのメトリクスを Prometheus Agent をサイドカーコンテナとして動かして、Amazon Managed Service for Prometheus (AMP) に送信して Grafana で見られるようにしてみました。\nちなみに Promethus Agent はまだ 実験的な機能 なため、実務での利用は推奨しません。\n本記事の環境構築には AWS CDK を利用しています。\n動作環境 Node.js v16.13.0 AWS CDK 2.0.0 (build 4b6ce31) Prometheus 2.32.1 環境構築 早速環境構築を進めていきます。まだ AMP については CDK から操作できないようでしたので、ワークスペースの作成については AWS コンソールから手動で行います。(2021/12/06)\naws-aps を利用することで AWS CDK からでも Amazon Managed Service for Prometheus のワークスペースを作成すること確認できましたので、そちらの利用を推奨いたします… 🙇🙇\nlib/prometheus-agent-test-stack.ts のコードも修正済みで AWS CDK で Amazon Managed Service for Prometheus のワークスペースを作成するように編集しました。(2021/12/18 追記)\n手動で AMP のワークスペースを作成する手順 まず、AMP のコンソール画面 に遷移してワークスペースを作成します。\n1. AMP のコンソール画面 からワークスペース作成画面に遷移する\n2. AMP のワークスペースを作成する\n3. AMP のワークスペース作成完了を確認すると同時に設定値を控えておく\nAMP ワークスペースの エンドポイント - リモート書き込み URL は、Prometheus Agent で AMP にデータ送信する際や、Grafana でデータソースを登録する際などに必要となるため控えておきます。\nAWS CDK で環境構築する CDK で構築作業を進めます。まずは下記コマンドで CDK プロジェクトを作成します。使用言語は TypeScript を選択します。\nmkdir prometheus-agent-test \u0026\u0026 cd prometheus-agent-test cdk init --language typescript まず CDK でインフラ構築を進めていく前に、メトリクス収集テスト用の Node.js アプリを準備します。\nECS Fargate で動かす Node.js アプリを準備する prom-client を利用して、Node.js のメトリクスが取得できるだけの Node.js アプリを準備します。prometheus-agent-test フォルダで下記コマンドを実行します。\nmkdir metrics-app \u0026\u0026 cd metrics-app npm init -y npm install --save prom-client 次に metrics-app フォルダ内に index.js を作成して下記を編集します。\n// metrics-app/index.js \"use strict\"; const http = require(\"http\"); const server = http.createServer(); const client = require(\"prom-client\"); const register = new client.Registry(); // 5秒間隔でメトリクスを取得する client.collectDefaultMetrics({ register, timeout: 5 * 1000 }); server.on(\"request\", async function (req, res) { // /metrics にアクセスしたら、Prometheus のレポートを返す if (req.url === \"/metrics\") { res.setHeader(\"Content-Type\", register.contentType); const metrics = await register.metrics(); return res.end(metrics); } else { return res.writeHead(404, { \"Content-Type\": \"text/plain\" }); } }); server.listen(8080); node index.js コマンドを実行して http://localhost:8080/metrics にアクセスしてみます。下記のように各種メトリクスが出力されている様子が確認できれば OK です。\nPrometheus のレポートが正常に出力されている様子\n今回は ECS 上で Node.js アプリを動作させるため、Dockerfile も作成します。\n# metrics-app/Dockerfile FROM public.ecr.aws/docker/library/node:16-alpine3.12 AS builder EXPOSE 8080 WORKDIR /usr/src/app COPY package*.json ./ RUN npm install --max-old-space-size=4096 COPY . . CMD [ \"node\", \"index.js\" ] 上記 Dockerfile 作成後、再び動作検証のため下記コマンドを実行してから、http://localhost:8080/metrics にアクセスしてみます。\ndocker build -t prometheus-agent-test/metrics-app . docker run -p 8080:8080 prometheus-agent-test/metrics-app:latest 先ほどと同様に http://localhost:8080/metrics アクセス時に各種メトリクスが出力されている様子を確認できれば OK です。\nNode.js アプリを監視する Prometheus Agent を準備する まずは Prometheus 関連ファイルを配置するためのフォルダを作成します。prometheus-agent-test フォルダ内で下記コマンドを実行します。\nmkdir prometheus-agent \u0026\u0026 cd prometheus-agent 次に Prometheus の設定テンプレートファイルを作成します。テンプレートファイルは sed を利用して中身の __TASK_ID__ および __REMOTE_WRITE_URL__ を書き換えて利用します。\n# prometheus-agent/prometheus.tmpl.yml global: scrape_interval: 5s external_labels: monitor: \"prometheus\" scrape_configs: - job_name: \"prometheus-agent-test\" static_configs: - targets: [\"localhost:8080\"] labels: # デフォルトの localhost:8080 がインスタンスとして利用されると、 # メトリクスの判別がしづらくなるため ECS Task の ID を利用する instance: \"__TASK_ID__\" remote_write: # AMP ワークスペース作成時に控えておいた、 # `エンドポイント - リモート書き込み URL` を設定する箇所 - url: \"__REMOTE_WRITE_URL__\" sigv4: region: ap-northeast-1 queue_config: max_samples_per_send: 1000 max_shards: 200 capacity: 2500 設定ファイルの作成が完了したら、テンプレートファイルを利用して Prometheus の設定ファイルを作成し、Prometheus Agent を起動させるためのシェルスクリプトを作成します。\n# prometheus-agent/docker-entrypoint.sh #!/bin/sh while [ -z \"$taskId\" ] do # ECS Fargate で起動したタスク ID を取得する taskId=$(curl --silent ${ECS_CONTAINER_METADATA_URI}/task | jq -r '.TaskARN | split(\"/\") | .[-1]') echo \"waiting...\" sleep 1 done echo \"taskId: ${taskId}\" echo \"remoteWriteUrl: ${REMOTE_WRITE_URL}\" # タスク ID `taskId` および、環境変数 `REMOTE_WRITE_URL` で、 # Prometheus のテンプレートファイル `prometheus.tmpl.yml` の内容を書き換え、 # その結果を `/etc/prometheus/prometheus.yml` に出力する cat /etc/prometheus/prometheus.tmpl.yml | \\ sed \"s/__TASK_ID__/${taskId}/g\" | \\ sed \"s\u003e__REMOTE_WRITE_URL__\u003e${REMOTE_WRITE_URL}\u003eg\" \u003e /etc/prometheus/prometheus.yml # --enable-feature=agent で Prometheus を Agent モードで起動する # Prometheus のコンフィグファイルには上記で出力した `/etc/prometheus/prometheus.yml` を利用する /usr/local/bin/prometheus \\ --enable-feature=agent \\ --config.file=/etc/prometheus/prometheus.yml \\ --web.console.libraries=/etc/prometheus/console_libraries \\ --web.console.templates=/etc/prometheus/consoles これで Prometheus Agent 起動のための準備は整ったため、最後に Dockerfile を準備します。ちなみに Prometheus Agent は v2.32.0 以降で利用可能です。本記事では v2.32.1 を利用します。\n# prometheus-agent/Dockerfile FROM --platform=arm64 alpine:3.15 ADD prometheus.tmpl.yml /etc/prometheus/ RUN apk add --update --no-cache jq sed curl # ARM64 で動作する Prometheus v2.32.1 を curl でダウンロード展開する RUN curl -sL -O https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-arm64.tar.gz RUN tar -zxvf prometheus-2.32.1.linux-arm64.tar.gz \u0026\u0026 rm prometheus-2.32.1.linux-arm64.tar.gz # `prometheus` コマンドを `/usr/local/bin/prometheus` に移動する RUN mv prometheus-2.32.1.linux-arm64/prometheus /usr/local/bin/prometheus COPY ./docker-entrypoint.sh / RUN chmod +x /docker-entrypoint.sh CMD [\"/docker-entrypoint.sh\"] ここまでで CDK でインフラ整備を進めていくための下準備は完了です。\nECS Fargate 上で Node.js アプリおよび Prometheus Agent を動作させる あとは CDK で ECS Fargate 上で Node.js アプリおよび Prometheus Agent、Grafana を動作させるための環境を整備していきます。\nlib/prometheus-agent-test-stack.ts の内容を書き換えます。\n// lib/prometheus-agent-test-stack.ts import { Construct } from \"constructs\"; import { Stack, StackProps, aws_ecs as ecs, aws_logs as logs, aws_aps as aps, aws_ecs_patterns as ecs_patterns, aws_iam as iam, aws_elasticloadbalancingv2 as elbv2, Duration, CfnOutput, } from \"aws-cdk-lib\"; export class PrometheusAgentTestStack extends Stack { constructor(scope: Construct, id: string, props?: StackProps) { super(scope, id, props); // Node.js アプリに ecs_patterns.ApplicationLoadBalancedFargateService を利用して ALB 経由でアクセス可能にする const projectName = \"prometheus-agent-test\"; const fargateService = new ecs_patterns.ApplicationLoadBalancedFargateService( this, `${projectName}-fargate-service`, { serviceName: `${projectName}-fargate-service`, cpu: 256, desiredCount: 3, listenerPort: 80, taskImageOptions: { family: `${projectName}-taskdef`, image: ecs.ContainerImage.fromAsset(\"metrics-app\"), containerPort: 8080, logDriver: ecs.LogDrivers.awsLogs({ streamPrefix: `/${projectName}/metrics-app`, logRetention: logs.RetentionDays.ONE_DAY, }), }, cluster: new ecs.Cluster(this, `${projectName}-cluster`, { clusterName: `${projectName}-cluster`, }), memoryLimitMiB: 512, } ); fargateService.targetGroup.configureHealthCheck({ path: \"/metrics\", timeout: Duration.seconds(8), interval: Duration.seconds(10), healthyThresholdCount: 2, unhealthyThresholdCount: 4, healthyHttpCodes: \"200\", }); // 本質ではないが、Gravition2 で動作させたいために RuntimePlatform のプロパティを上書きしている const fargateServiceTaskdef = fargateService.taskDefinition.node .defaultChild as ecs.CfnTaskDefinition; fargateServiceTaskdef.addPropertyOverride(\"RuntimePlatform\", { CpuArchitecture: \"ARM64\", OperatingSystemFamily: \"LINUX\", }); // AMP への書き込み権限を付与する fargateService.taskDefinition.taskRole.addManagedPolicy( iam.ManagedPolicy.fromAwsManagedPolicyName( \"AmazonPrometheusRemoteWriteAccess\" ) ); // (2021/12/18) Amazon Managed Service for Prometheus のワークスペースを作成して、Prometheus の remote-write URL を取得する const apsWorkspace = new aps.CfnWorkspace( this, `${projectName}-prom-workspace`, { alias: `${projectName}-prom-workspace`, } ); const apsWorkspaceRemoteUrl = `${apsWorkspace.attrPrometheusEndpoint}api/v1/remote_write`; // (2021/12/18) 本記事で頻出する \"エンドポイント - リモート書き込み URL\" をコンソールに出力する new CfnOutput(this, \"prom-remote-write-url\", { value: apsWorkspaceRemoteUrl, description: \"Prometheus Workspace の remote-write URL\", exportName: \"PromRemoteWriteURL\", }); // AMP へメトリクス情報を送信するための Prometheus Agent コンテナを追加する const containerName = `${projectName}-prometheus-agent`; fargateService.taskDefinition.addContainer(containerName, { containerName, image: ecs.ContainerImage.fromAsset(\"prometheus-agent\"), memoryReservationMiB: 128, environment: { // (2021/12/18) CDK 経由で作成した Prometheus の remote-write URL を設定する REMOTE_WRITE_URL: apsWorkspaceRemoteUrl, }, logging: new ecs.AwsLogDriver({ streamPrefix: `/${projectName}/prometheus-agent`, logRetention: logs.RetentionDays.ONE_DAY, }), }); // Grafana のタスク定義を作成する const grafanaDashboardTaskDefinition = new ecs.FargateTaskDefinition( this, `${projectName}-grafana-taskdef`, { family: `${projectName}-grafana-taskdef`, } ); // Grafana のタスクが Prometheus Query を叩けるように権限付与する grafanaDashboardTaskDefinition.taskRole.addManagedPolicy( iam.ManagedPolicy.fromAwsManagedPolicyName(\"AmazonPrometheusQueryAccess\") ); // Grafana のコンテナを追加する。パスプレフィクスには dashboard を設定する const grafanaDashboardContainerName = `${projectName}-grafana-dashboard`; grafanaDashboardTaskDefinition.addContainer(grafanaDashboardContainerName, { containerName: grafanaDashboardContainerName, image: ecs.ContainerImage.fromRegistry(\"public.ecr.aws/ubuntu/grafana\"), environment: { AWS_SDK_LOAD_CONFIG: \"true\", GF_AUTH_SIGV4_AUTH_ENABLED: \"true\", GF_SERVER_SERVE_FROM_SUB_PATH: \"true\", GF_SERVER_ROOT_URL: \"%(protocol)s://%(domain)s/dashboard\", }, portMappings: [{ containerPort: 3000 }], memoryLimitMiB: 512, logging: new ecs.AwsLogDriver({ streamPrefix: `/${projectName}/grafana-dashboard`, logRetention: logs.RetentionDays.ONE_DAY, }), }); const grafanaDashboardServiceName = `${projectName}-grafana-dashboard-service`; const grafanaDashboardService = new ecs.FargateService( this, grafanaDashboardServiceName, { serviceName: grafanaDashboardServiceName, cluster: fargateService.cluster, taskDefinition: grafanaDashboardTaskDefinition, desiredCount: 1, } ); // Grafana のタスクを ALB のターゲットグループに紐づける fargateService.listener.addTargets( `${projectName}-grafana-dashboard-target`, { priority: 1, conditions: [elbv2.ListenerCondition.pathPatterns([\"/dashboard/*\"])], healthCheck: { path: \"/dashboard/login\", interval: Duration.seconds(10), timeout: Duration.seconds(8), healthyThresholdCount: 2, unhealthyThresholdCount: 3, healthyHttpCodes: \"200\", }, port: 3000, protocol: elbv2.ApplicationProtocol.HTTP, targets: [grafanaDashboardService], } ); } } その後、cdk deploy でインフラを構築します。\nCDK によるインフラ構築が正常に実行された時の様子\nデプロイが正常に完了したのを確認したら、Outputs に出力されている PrometheusAgentTestStack.prometheusagenttestfargateserviceServiceURL\u003c識別子\u003e の URL 末尾に /metrics を付与してアクセスしてみます。 出力されている URL のフォーマットは http://\u003c識別子\u003e.ap-northeast-1.elb.amazonaws.com になります。\nつまり、http://\u003c識別子\u003e.ap-northeast-1.elb.amazonaws.com/metrics にアクセスします。\nALB 経由で Node.js アプリにアクセス可能なことを確認する\nまた、Outputs に出力されている PrometheusAgentTestStack.promremotewriteurl は後に利用する エンドポイント - リモート書き込み URL で使用するので控えておきます。\nここまでで AWS CDK でのインフラ構築作業は完了しました。最後に Grafana で AMP のメトリクスを可視化するための作業を進めていきます。\nGrafana で Prometheus (AMP) のメトリクスを可視化する 先ほどの /metrics パスへのアクセス同様、Outputs に出力されている URL の末尾に /dashboard/login を付与してアクセスします。Grafana の初期ユーザおよびパスワードは admin となります。\nつまり、http://\u003c識別子\u003e.ap-northeast-1.elb.amazonaws.com/dashboard/login にアクセスしてみます。\nログイン情報が正しければ、新しいパスワードを設定する画面に遷移するので新たなパスワードを入力してログインを終えます。ログイン後は、Prometheus (AMP) をデータソースとして追加するために下記の操作を行います。\n1. 歯車アイコンをクリックして Data sources をクリックする\n2. Add data source ボタンをクリックする\n3. データソースとして Prometheus を選択する\n4. Prometheus をデータソースとして追加する\nPrometheus (AMP) に送信したメトリクスを Grafana で可視化するための準備が整ったので、実際に Grafana のダッシュボードでメトリクスを可視化してみます。手っ取り早くメトリクスを可視化するため、ダッシュボードには NodeJS Application Dashboard を利用します。\n1. + アイコンをクリックして、Import をクリックする\n2. NodeJS Application Dashboard の ID を入力して Load ボタンをクリックする\n3. 必要な情報を入力して NodeJS Application Dashboard のインポートを完了する\n4. ダッシュボードから Node.js アプリのメトリクスが確認できる\nここまでの手順でメトリクスの可視化は完了しましたが、負荷に応じて実際にメトリクスが変化する様子も確認してみます。Vegeta を利用して、実際に負荷をかけてみます。下記コマンドを実行します。\necho 'GET http://\u003c識別子\u003e.ap-northeast-1.elb.amazonaws.com/metrics' | vegeta attack -duration=5s | vegeta report その後、再び Grafana のダッシュボードを見にいきます。負荷をかけた時間帯のみグラフに変化があることを確認できるはずです。\nダッシュボードの CPU 使用率のグラフに変化があったことを確認できる\nおわりに 今回は ECS Fargate のメトリクスを Prometheus Agent で Amazon Managed Service for Prometheus (AMP) に送信し、それを Grafana で可視化する方法について紹介しました。\nECS のサービスでタスクを実行する場合は サービスディスカバリ の利用が可能なため、Prometheus の サービスディスカバリの設定 を行うことで、単一の Prometheus で全てのコンテナのメトリクスを扱うことも可能です。\nまた Node.js アプリを作成する際に利用した prom-client で カスタムメトリクス を作成することで、監視したい項目を自由に増やすことも可能です。\n本記事が ECS Fargate を監視する際の検討材料の 1 つとなれたら幸いです。\n参考リンク AWS Fargate（サーバーやクラスターの管理が不要なコンテナの使用）| AWS Introducing Prometheus Agent Mode, an Efficient and Cloud-Native Way for Metric Forwarding | Prometheus Amazon Managed Service for Prometheus | フルマネージド Prometheus | Amazon Web Services Grafana: The open observability platform | Grafana Labs AWS クラウド開発キット – アマゾン ウェブ サービス siimon/prom-client: Prometheus client for node.js tsenart/vegeta: HTTP load testing tool and library. It’s over 9000! NodeJS Application Dashboard dashboard for Grafana | Grafana Labs ","wordCount":"1139","inLanguage":"ja","image":"https://i.gyazo.com/a6905ee24a684da236b8360697098672.png","datePublished":"2021-12-05T00:00:00Z","dateModified":"2021-12-05T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nikaera.com/archives/aws-ecs-fargate-amp-grafana/"},"publisher":{"@type":"Organization","name":"Nikaeraintokyo.","logo":{"@type":"ImageObject","url":"https://nikaera.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://nikaera.com/ accesskey=h title="Nikaeraintokyo. (Alt + H)">Nikaeraintokyo.</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://nikaera.tumblr.com/ title="Music 🎵" target=_blank rel="noopener noreferrer"><span>Music 🎵</span></a></li><li><span>|</span></li><li><a href=https://nikaera.com/archives/ title="Archives 🗄️"><span>Archives 🗄️</span></a></li><li><a href=https://nikaera.com/rss_feeds/ title="RSS Feeds 🔖"><span>RSS Feeds 🔖</span></a></li><li><a href=https://nikaera.com/profile/ title="Profile 👦"><span>Profile 👦</span></a></li><li><a href=https://nikaera.com/portfolio/ title="Portfolio 💼"><span>Portfolio 💼</span></a></li><li><a href=https://nikaera.com/contact/ title="Contact 📥"><span>Contact 📥</span></a></li><li><a href=https://nikaera.com/search/ title="Search 🔍"><span>Search 🔍</span></a></li></ul></nav></header><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TEECMFQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TEECMFQW")</script><main class=main><article class=post-single><header class=post-header><h1 class=post-title>📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する</h1><div class=post-meta><span title='2021-12-05 00:00:00 +0000 UTC'>12月 5, 2021</span>&nbsp;·&nbsp;6 分&nbsp;·&nbsp;Me
<span style=text-align:right;margin-left:auto;font-size:1em>Originally published at <a href=https://zenn.dev/nikaera/articles/aws-ecs-fargate-amp-grafana target=_blank rel="noopener noreferrer">zenn.dev</a></span></div></header><figure class=entry-cover><img loading=lazy src=https://i.gyazo.com/a6905ee24a684da236b8360697098672.png alt="ECS Fargate のメトリクスを Grafana の画面で確認している様子"></figure><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p>この記事は <a href=https://qiita.com/advent-calendar/2021/aws>AWS Advent Calendar 2021</a> の 5 日目の記事です。</p><p><a href=https://aws.amazon.com/jp/fargate/>Fargate</a> で Node.js アプリのメトリクスを <a href=https://prometheus.io/blog/2021/11/16/agent/>Prometheus Agent</a> をサイドカーコンテナとして動かして、<a href=https://aws.amazon.com/jp/prometheus/>Amazon Managed Service for Prometheus (AMP)</a> に送信して <a href=https://grafana.com/>Grafana</a> で見られるようにしてみました。</p><p>ちなみに Promethus Agent はまだ <a href=https://prometheus.io/blog/2021/11/16/agent/#prometheus-agent-mode>実験的な機能</a> なため、<strong>実務での利用は推奨しません。</strong></p><p>本記事の環境構築には <a href=https://aws.amazon.com/jp/cdk/>AWS CDK</a> を利用しています。</p><h1 id=動作環境>動作環境<a hidden class=anchor aria-hidden=true href=#動作環境>#</a></h1><ul><li>Node.js v16.13.0</li><li>AWS CDK 2.0.0 (build 4b6ce31)</li><li>Prometheus 2.32.1</li></ul><h1 id=環境構築>環境構築<a hidden class=anchor aria-hidden=true href=#環境構築>#</a></h1><p><del>早速環境構築を進めていきます。まだ AMP については CDK から操作できないようでしたので、ワークスペースの作成については AWS コンソールから手動で行います。(2021/12/06)</del></p><p><strong><a href=https://docs.aws.amazon.com/cdk/api/latest/docs/aws-aps-readme.html><code>aws-aps</code></a> を利用することで AWS CDK からでも Amazon Managed Service for Prometheus のワークスペースを作成すること確認できましたので、そちらの利用を推奨いたします&mldr; 🙇🙇</strong></p><p><strong><a href=/archives/aws-ecs-fargate-amp-grafana/#ecs-fargate-%e4%b8%8a%e3%81%a7-node.js-%e3%82%a2%e3%83%97%e3%83%aa%e3%81%8a%e3%82%88%e3%81%b3-prometheus-agent-%e3%82%92%e5%8b%95%e4%bd%9c%e3%81%95%e3%81%9b%e3%82%8b>lib/prometheus-agent-test-stack.ts</a> のコードも修正済みで AWS CDK で Amazon Managed Service for Prometheus のワークスペースを作成するように編集しました。(2021/12/18 追記)</strong></p><h2 id=手動で-amp-のワークスペースを作成する手順><del>手動で AMP のワークスペースを作成する手順</del><a hidden class=anchor aria-hidden=true href=#手動で-amp-のワークスペースを作成する手順>#</a></h2><p>まず、<a href=https://ap-northeast-1.console.aws.amazon.com/prometheus/home>AMP のコンソール画面</a> に遷移してワークスペースを作成します。</p><p><img alt="AMP のコンソール画面からワークスペースを作成する" loading=lazy src=https://i.gyazo.com/bf30611d6bc0f6b93281fd80123b611e.png>
<strong>1. <a href=https://ap-northeast-1.console.aws.amazon.com/prometheus/home>AMP のコンソール画面</a> からワークスペース作成画面に遷移する</strong></p><p><img alt="2. AMP のワークスペースを作成する" loading=lazy src=https://i.gyazo.com/7199bed8693832b26f4594bcf5541c86.png>
<strong>2. AMP のワークスペースを作成する</strong></p><p><img alt="3. AMP のワークスペース作成完了と同時に設定値を控えておく" loading=lazy src=https://i.gyazo.com/e32231b46a716aaeb37c8ef88a02e434.png>
<strong>3. AMP のワークスペース作成完了を確認すると同時に設定値を控えておく</strong></p><p>AMP ワークスペースの <code>エンドポイント - リモート書き込み URL</code> は、<strong>Prometheus Agent で AMP にデータ送信する際や、Grafana でデータソースを登録する際などに必要となるため控えておきます。</strong></p><h2 id=aws-cdk-で環境構築する>AWS CDK で環境構築する<a hidden class=anchor aria-hidden=true href=#aws-cdk-で環境構築する>#</a></h2><p>CDK で構築作業を進めます。まずは下記コマンドで CDK プロジェクトを作成します。使用言語は <code>TypeScript</code> を選択します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir prometheus-agent-test <span style=color:#f92672>&amp;&amp;</span> cd prometheus-agent-test
</span></span><span style=display:flex><span>cdk init --language typescript
</span></span></code></pre></div><p>まず CDK でインフラ構築を進めていく前に、メトリクス収集テスト用の Node.js アプリを準備します。</p><h3 id=ecs-fargate-で動かす-nodejs-アプリを準備する>ECS Fargate で動かす Node.js アプリを準備する<a hidden class=anchor aria-hidden=true href=#ecs-fargate-で動かす-nodejs-アプリを準備する>#</a></h3><p><a href=https://github.com/siimon/prom-client>prom-client</a> を利用して、Node.js のメトリクスが取得できるだけの Node.js アプリを準備します。<code>prometheus-agent-test</code> フォルダで下記コマンドを実行します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir metrics-app <span style=color:#f92672>&amp;&amp;</span> cd metrics-app
</span></span><span style=display:flex><span>npm init -y
</span></span><span style=display:flex><span>npm install --save prom-client
</span></span></code></pre></div><p>次に <code>metrics-app</code> フォルダ内に <code>index.js</code> を作成して下記を編集します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// metrics-app/index.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#e6db74>&#34;use strict&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;http&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#34;prom-client&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>register</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Registry</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 5秒間隔でメトリクスを取得する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>collectDefaultMetrics</span>({ <span style=color:#a6e22e>register</span>, <span style=color:#a6e22e>timeout</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#34;request&#34;</span>, <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// /metrics にアクセスしたら、Prometheus のレポートを返す
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>url</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#34;/metrics&#34;</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>setHeader</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#a6e22e>register</span>.<span style=color:#a6e22e>contentType</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>register</span>.<span style=color:#a6e22e>metrics</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>(<span style=color:#a6e22e>metrics</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>writeHead</span>(<span style=color:#ae81ff>404</span>, { <span style=color:#e6db74>&#34;Content-Type&#34;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;text/plain&#34;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>8080</span>);
</span></span></code></pre></div><p><code>node index.js</code> コマンドを実行して <code>http://localhost:8080/metrics</code> にアクセスしてみます。下記のように各種メトリクスが出力されている様子が確認できれば OK です。</p><p><img alt="Prometheus のレポートが正常に出力されている様子" loading=lazy src=https://i.gyazo.com/a5feae6dba9a9f4eaecae0055dd9be9e.png>
<strong>Prometheus のレポートが正常に出力されている様子</strong></p><p>今回は ECS 上で Node.js アプリを動作させるため、<code>Dockerfile</code> も作成します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># metrics-app/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> public.ecr.aws/docker/library/node:16-alpine3.12 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /usr/src/app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package*.json ./<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install --max-old-space-size<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [ <span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;index.js&#34;</span> ]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>上記 <code>Dockerfile</code> 作成後、再び動作検証のため下記コマンドを実行してから、<code>http://localhost:8080/metrics</code> にアクセスしてみます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker build -t prometheus-agent-test/metrics-app .
</span></span><span style=display:flex><span>docker run -p 8080:8080 prometheus-agent-test/metrics-app:latest
</span></span></code></pre></div><p>先ほどと同様に <code>http://localhost:8080/metrics</code> アクセス時に各種メトリクスが出力されている様子を確認できれば OK です。</p><h3 id=nodejs-アプリを監視する-prometheus-agent-を準備する>Node.js アプリを監視する Prometheus Agent を準備する<a hidden class=anchor aria-hidden=true href=#nodejs-アプリを監視する-prometheus-agent-を準備する>#</a></h3><p>まずは Prometheus 関連ファイルを配置するためのフォルダを作成します。<code>prometheus-agent-test</code> フォルダ内で下記コマンドを実行します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir prometheus-agent <span style=color:#f92672>&amp;&amp;</span> cd prometheus-agent
</span></span></code></pre></div><p>次に Prometheus の設定テンプレートファイルを作成します。テンプレートファイルは <a href=https://atmarkit.itmedia.co.jp/ait/articles/1610/18/news008.html><code>sed</code></a> を利用して中身の <code>__TASK_ID__</code> および <code>__REMOTE_WRITE_URL__</code> を書き換えて利用します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># prometheus-agent/prometheus.tmpl.yml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>global</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>scrape_interval</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>external_labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>monitor</span>: <span style=color:#e6db74>&#34;prometheus&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#e6db74>&#34;prometheus-agent-test&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>targets</span>: [<span style=color:#e6db74>&#34;localhost:8080&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>          <span style=color:#75715e># デフォルトの localhost:8080 がインスタンスとして利用されると、</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># メトリクスの判別がしづらくなるため ECS Task の ID を利用する</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>instance</span>: <span style=color:#e6db74>&#34;__TASK_ID__&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>remote_write</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># AMP ワークスペース作成時に控えておいた、</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># `エンドポイント - リモート書き込み URL` を設定する箇所</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#e6db74>&#34;__REMOTE_WRITE_URL__&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sigv4</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>region</span>: <span style=color:#ae81ff>ap-northeast-1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>queue_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>max_samples_per_send</span>: <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>max_shards</span>: <span style=color:#ae81ff>200</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>capacity</span>: <span style=color:#ae81ff>2500</span>
</span></span></code></pre></div><p>設定ファイルの作成が完了したら、テンプレートファイルを利用して Prometheus の設定ファイルを作成し、Prometheus Agent を起動させるためのシェルスクリプトを作成します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># prometheus-agent/docker-entrypoint.sh</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#!/bin/sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#f92672>[</span> -z <span style=color:#e6db74>&#34;</span>$taskId<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># ECS Fargate で起動したタスク ID を取得する</span>
</span></span><span style=display:flex><span>  taskId<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>curl --silent <span style=color:#e6db74>${</span>ECS_CONTAINER_METADATA_URI<span style=color:#e6db74>}</span>/task | jq -r <span style=color:#e6db74>&#39;.TaskARN | split(&#34;/&#34;) | .[-1]&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  echo <span style=color:#e6db74>&#34;waiting...&#34;</span>
</span></span><span style=display:flex><span>  sleep <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;taskId: </span><span style=color:#e6db74>${</span>taskId<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;remoteWriteUrl: </span><span style=color:#e6db74>${</span>REMOTE_WRITE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># タスク ID `taskId` および、環境変数 `REMOTE_WRITE_URL` で、</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prometheus のテンプレートファイル `prometheus.tmpl.yml` の内容を書き換え、</span>
</span></span><span style=display:flex><span><span style=color:#75715e># その結果を `/etc/prometheus/prometheus.yml` に出力する</span>
</span></span><span style=display:flex><span>cat /etc/prometheus/prometheus.tmpl.yml | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed <span style=color:#e6db74>&#34;s/__TASK_ID__/</span><span style=color:#e6db74>${</span>taskId<span style=color:#e6db74>}</span><span style=color:#e6db74>/g&#34;</span> | <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    sed <span style=color:#e6db74>&#34;s&gt;__REMOTE_WRITE_URL__&gt;</span><span style=color:#e6db74>${</span>REMOTE_WRITE_URL<span style=color:#e6db74>}</span><span style=color:#e6db74>&gt;g&#34;</span> &gt; /etc/prometheus/prometheus.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># --enable-feature=agent で Prometheus を Agent モードで起動する</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Prometheus のコンフィグファイルには上記で出力した `/etc/prometheus/prometheus.yml` を利用する</span>
</span></span><span style=display:flex><span>/usr/local/bin/prometheus <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --enable-feature<span style=color:#f92672>=</span>agent <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --config.file<span style=color:#f92672>=</span>/etc/prometheus/prometheus.yml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --web.console.libraries<span style=color:#f92672>=</span>/etc/prometheus/console_libraries <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --web.console.templates<span style=color:#f92672>=</span>/etc/prometheus/consoles
</span></span></code></pre></div><p>これで Prometheus Agent 起動のための準備は整ったため、最後に <code>Dockerfile</code> を準備します。ちなみに Prometheus Agent は <code>v2.32.0</code> 以降で利用可能です。<strong>本記事では <code>v2.32.1</code> を利用します。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># prometheus-agent/Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> --platform=arm64 alpine:3.15</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ADD</span> prometheus.tmpl.yml /etc/prometheus/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --update --no-cache jq sed curl<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># ARM64 で動作する Prometheus v2.32.1 を curl でダウンロード展開する</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl -sL -O https://github.com/prometheus/prometheus/releases/download/v2.32.1/prometheus-2.32.1.linux-arm64.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> tar -zxvf prometheus-2.32.1.linux-arm64.tar.gz <span style=color:#f92672>&amp;&amp;</span> rm prometheus-2.32.1.linux-arm64.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># `prometheus` コマンドを `/usr/local/bin/prometheus` に移動する</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv prometheus-2.32.1.linux-arm64/prometheus /usr/local/bin/prometheus<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./docker-entrypoint.sh /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> chmod +x /docker-entrypoint.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/docker-entrypoint.sh&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>ここまでで CDK でインフラ整備を進めていくための下準備は完了です。</p><h3 id=ecs-fargate-上で-nodejs-アプリおよび-prometheus-agent-を動作させる>ECS Fargate 上で Node.js アプリおよび Prometheus Agent を動作させる<a hidden class=anchor aria-hidden=true href=#ecs-fargate-上で-nodejs-アプリおよび-prometheus-agent-を動作させる>#</a></h3><p>あとは CDK で ECS Fargate 上で Node.js アプリおよび Prometheus Agent、Grafana を動作させるための環境を整備していきます。</p><p><code>lib/prometheus-agent-test-stack.ts</code> の内容を書き換えます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// lib/prometheus-agent-test-stack.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Construct</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;constructs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Stack</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>StackProps</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_ecs</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_logs</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>logs</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_aps</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>aps</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_ecs_patterns</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs_patterns</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_iam</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>iam</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aws_elasticloadbalancingv2</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>elbv2</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Duration</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CfnOutput</span>,
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;aws-cdk-lib&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>PrometheusAgentTestStack</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>Stack</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>Construct</span>, <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>props?</span>: <span style=color:#66d9ef>StackProps</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>(<span style=color:#a6e22e>scope</span>, <span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>props</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Node.js アプリに ecs_patterns.ApplicationLoadBalancedFargateService を利用して ALB 経由でアクセス可能にする
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>projectName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;prometheus-agent-test&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fargateService</span> <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs_patterns</span>.<span style=color:#a6e22e>ApplicationLoadBalancedFargateService</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-fargate-service`</span>,
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-fargate-service`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cpu</span>: <span style=color:#66d9ef>256</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>desiredCount</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>listenerPort</span>: <span style=color:#66d9ef>80</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>taskImageOptions</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>family</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-taskdef`</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromAsset</span>(<span style=color:#e6db74>&#34;metrics-app&#34;</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>8080</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>logDriver</span>: <span style=color:#66d9ef>ecs.LogDrivers.awsLogs</span>({
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/metrics-app`</span>,
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>            }),
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cluster</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>Cluster</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster`</span>, {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>clusterName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-cluster`</span>,
</span></span><span style=display:flex><span>          }),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>memoryLimitMiB</span>: <span style=color:#66d9ef>512</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>targetGroup</span>.<span style=color:#a6e22e>configureHealthCheck</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/metrics&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>interval</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>healthyThresholdCount</span>: <span style=color:#66d9ef>2</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>unhealthyThresholdCount</span>: <span style=color:#66d9ef>4</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>healthyHttpCodes</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;200&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 本質ではないが、Gravition2 で動作させたいために RuntimePlatform のプロパティを上書きしている
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fargateServiceTaskdef</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>node</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>defaultChild</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>CfnTaskDefinition</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fargateServiceTaskdef</span>.<span style=color:#a6e22e>addPropertyOverride</span>(<span style=color:#e6db74>&#34;RuntimePlatform&#34;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>CpuArchitecture</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ARM64&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>OperatingSystemFamily</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;LINUX&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// AMP への書き込み権限を付与する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>taskRole</span>.<span style=color:#a6e22e>addManagedPolicy</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>ManagedPolicy</span>.<span style=color:#a6e22e>fromAwsManagedPolicyName</span>(
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;AmazonPrometheusRemoteWriteAccess&#34;</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (2021/12/18) Amazon Managed Service for Prometheus のワークスペースを作成して、Prometheus の remote-write URL を取得する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apsWorkspace</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>aps</span>.<span style=color:#a6e22e>CfnWorkspace</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prom-workspace`</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>alias</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prom-workspace`</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>apsWorkspaceRemoteUrl</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>apsWorkspace</span>.<span style=color:#a6e22e>attrPrometheusEndpoint</span><span style=color:#e6db74>}</span><span style=color:#e6db74>api/v1/remote_write`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// (2021/12/18) 本記事で頻出する &#34;エンドポイント - リモート書き込み URL&#34; をコンソールに出力する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CfnOutput</span>(<span style=color:#66d9ef>this</span>, <span style=color:#e6db74>&#34;prom-remote-write-url&#34;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>apsWorkspaceRemoteUrl</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Prometheus Workspace の remote-write URL&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exportName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;PromRemoteWriteURL&#34;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// AMP へメトリクス情報を送信するための Prometheus Agent コンテナを追加する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>containerName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-prometheus-agent`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>taskDefinition</span>.<span style=color:#a6e22e>addContainer</span>(<span style=color:#a6e22e>containerName</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>containerName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromAsset</span>(<span style=color:#e6db74>&#34;prometheus-agent&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>memoryReservationMiB</span>: <span style=color:#66d9ef>128</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// (2021/12/18) CDK 経由で作成した Prometheus の remote-write URL を設定する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>REMOTE_WRITE_URL</span>: <span style=color:#66d9ef>apsWorkspaceRemoteUrl</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logging</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>AwsLogDriver</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/prometheus-agent`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana のタスク定義を作成する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>FargateTaskDefinition</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-taskdef`</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>family</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-taskdef`</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana のタスクが Prometheus Query を叩けるように権限付与する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span>.<span style=color:#a6e22e>taskRole</span>.<span style=color:#a6e22e>addManagedPolicy</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iam</span>.<span style=color:#a6e22e>ManagedPolicy</span>.<span style=color:#a6e22e>fromAwsManagedPolicyName</span>(<span style=color:#e6db74>&#34;AmazonPrometheusQueryAccess&#34;</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana のコンテナを追加する。パスプレフィクスには dashboard を設定する
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardContainerName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard`</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grafanaDashboardTaskDefinition</span>.<span style=color:#a6e22e>addContainer</span>(<span style=color:#a6e22e>grafanaDashboardContainerName</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>containerName</span>: <span style=color:#66d9ef>grafanaDashboardContainerName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>image</span>: <span style=color:#66d9ef>ecs.ContainerImage.fromRegistry</span>(<span style=color:#e6db74>&#34;public.ecr.aws/ubuntu/grafana&#34;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>AWS_SDK_LOAD_CONFIG</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>GF_AUTH_SIGV4_AUTH_ENABLED</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>GF_SERVER_SERVE_FROM_SUB_PATH</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;true&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>GF_SERVER_ROOT_URL</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;%(protocol)s://%(domain)s/dashboard&#34;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>portMappings</span><span style=color:#f92672>:</span> [{ <span style=color:#a6e22e>containerPort</span>: <span style=color:#66d9ef>3000</span> }],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>memoryLimitMiB</span>: <span style=color:#66d9ef>512</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logging</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>AwsLogDriver</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>streamPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/grafana-dashboard`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>logRetention</span>: <span style=color:#66d9ef>logs.RetentionDays.ONE_DAY</span>,
</span></span><span style=display:flex><span>      }),
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardServiceName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard-service`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grafanaDashboardService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ecs</span>.<span style=color:#a6e22e>FargateService</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>grafanaDashboardServiceName</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>serviceName</span>: <span style=color:#66d9ef>grafanaDashboardServiceName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cluster</span>: <span style=color:#66d9ef>fargateService.cluster</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>taskDefinition</span>: <span style=color:#66d9ef>grafanaDashboardTaskDefinition</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>desiredCount</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Grafana のタスクを ALB のターゲットグループに紐づける
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>fargateService</span>.<span style=color:#a6e22e>listener</span>.<span style=color:#a6e22e>addTargets</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>projectName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-grafana-dashboard-target`</span>,
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>priority</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conditions</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>elbv2</span>.<span style=color:#a6e22e>ListenerCondition</span>.<span style=color:#a6e22e>pathPatterns</span>([<span style=color:#e6db74>&#34;/dashboard/*&#34;</span>])],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthCheck</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;/dashboard/login&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>interval</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>Duration.seconds</span>(<span style=color:#ae81ff>8</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>healthyThresholdCount</span>: <span style=color:#66d9ef>2</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>unhealthyThresholdCount</span>: <span style=color:#66d9ef>3</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>healthyHttpCodes</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;200&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>3000</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>protocol</span>: <span style=color:#66d9ef>elbv2.ApplicationProtocol.HTTP</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>targets</span><span style=color:#f92672>:</span> [<span style=color:#a6e22e>grafanaDashboardService</span>],
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>その後、<code>cdk deploy</code> でインフラを構築します。</p><p><img alt="CDK によるインフラ構築が正常に実行された時の様子" loading=lazy src=https://i.gyazo.com/c7da0f6c6b5a57edee47ae20a8026f8f.png>
<strong>CDK によるインフラ構築が正常に実行された時の様子</strong></p><p>デプロイが正常に完了したのを確認したら、<code>Outputs</code> に出力されている <strong><code>PrometheusAgentTestStack.prometheusagenttestfargateserviceServiceURL&lt;識別子></code> の URL 末尾に <code>/metrics</code> を付与してアクセスしてみます。</strong> 出力されている URL のフォーマットは <code>http://&lt;識別子>.ap-northeast-1.elb.amazonaws.com</code> になります。</p><p>つまり、<strong><code>http://&lt;識別子>.ap-northeast-1.elb.amazonaws.com/metrics</code> にアクセスします。</strong></p><p><img alt="ALB 経由で Node.js アプリにアクセス可能なことを確認する" loading=lazy src=https://i.gyazo.com/c13a2b0efc3bb96e79b4f1f5a2886a8a.png>
<strong>ALB 経由で Node.js アプリにアクセス可能なことを確認する</strong></p><p>また、<code>Outputs</code> に出力されている <strong><code>PrometheusAgentTestStack.promremotewriteurl</code> は後に利用する <code>エンドポイント - リモート書き込み URL</code> で使用するので控えておきます。</strong></p><p>ここまでで AWS CDK でのインフラ構築作業は完了しました。最後に Grafana で AMP のメトリクスを可視化するための作業を進めていきます。</p><h1 id=grafana-で-prometheus-amp-のメトリクスを可視化する>Grafana で Prometheus (AMP) のメトリクスを可視化する<a hidden class=anchor aria-hidden=true href=#grafana-で-prometheus-amp-のメトリクスを可視化する>#</a></h1><p>先ほどの <code>/metrics</code> パスへのアクセス同様、<code>Outputs</code> に出力されている URL の末尾に <code>/dashboard/login</code> を付与してアクセスします。<strong>Grafana の初期ユーザおよびパスワードは <code>admin</code> となります。</strong></p><p>つまり、<code>http://&lt;識別子>.ap-northeast-1.elb.amazonaws.com/dashboard/login</code> にアクセスしてみます。</p><p><img alt=ログインを行う loading=lazy src=https://i.gyazo.com/fe4ea6515f54dec23234e10a93023a36.png></p><p>ログイン情報が正しければ、新しいパスワードを設定する画面に遷移するので新たなパスワードを入力してログインを終えます。ログイン後は、Prometheus (AMP) をデータソースとして追加するために下記の操作を行います。</p><p><img alt="1. 歯車アイコンをクリックして <code>Data sources</code> をクリックする" loading=lazy src=https://i.gyazo.com/599d49e4167ccc35c5d44d5df7678036.png>
<strong>1. 歯車アイコンをクリックして <code>Data sources</code> をクリックする</strong></p><p><img alt="2. <code>Add data source</code> ボタンをクリックする" loading=lazy src=https://i.gyazo.com/e88bfc58a35deaa16a16920a5e551837.png>
<strong>2. <code>Add data source</code> ボタンをクリックする</strong></p><p><img alt="3. データソースとして Prometheus を選択する" loading=lazy src=https://i.gyazo.com/1c8031a3182f03e20194bf0b76e66e5a.png>
<strong>3. データソースとして Prometheus を選択する</strong></p><p><img alt="4. Prometheus をデータソースとして追加する" loading=lazy src=https://i.gyazo.com/1684c1fca9decb29e60bd654400fd06b.png></p><p><img alt="4. Prometheus をデータソースとして追加する" loading=lazy src=https://i.gyazo.com/2119361eac350044e783ed0c9280580a.png></p><p><img alt="4. Prometheus をデータソースとして追加する" loading=lazy src=https://i.gyazo.com/00cc7edbfc45dbd43ad3b0cccea72c7d.png>
<strong>4. Prometheus をデータソースとして追加する</strong></p><p>Prometheus (AMP) に送信したメトリクスを Grafana で可視化するための準備が整ったので、実際に Grafana のダッシュボードでメトリクスを可視化してみます。手っ取り早くメトリクスを可視化するため、ダッシュボードには <a href=https://grafana.com/grafana/dashboards/11159>NodeJS Application Dashboard</a> を利用します。</p><p><img alt="1. + アイコンをクリックして、<code>Import</code> をクリックする" loading=lazy src=https://i.gyazo.com/b36c0281e273e21fc9474666786281c3.png>
<strong>1. + アイコンをクリックして、<code>Import</code> をクリックする</strong></p><p><img alt="2. <code>NodeJS Application Dashboard</code> の ID を入力して <code>Load</code> ボタンをクリックする" loading=lazy src=https://i.gyazo.com/130718dff8b86758acb415764bd37338.png>
<strong>2. <code>NodeJS Application Dashboard</code> の ID を入力して <code>Load</code> ボタンをクリックする</strong></p><p><img alt="3. 必要な情報を入力して <code>NodeJS Application Dashboard</code> のインポートを完了する" loading=lazy src=https://i.gyazo.com/2aa8903f3f64d8021699cd5d4bfa9757.png>
<strong>3. 必要な情報を入力して <code>NodeJS Application Dashboard</code> のインポートを完了する</strong></p><p><img alt="4. ダッシュボードから Prometheus のメトリクスが確認できる" loading=lazy src=https://i.gyazo.com/1378b09c281da28653917ee40494dee8.png>
<strong>4. ダッシュボードから Node.js アプリのメトリクスが確認できる</strong></p><p>ここまでの手順でメトリクスの可視化は完了しましたが、負荷に応じて実際にメトリクスが変化する様子も確認してみます。<a href=https://github.com/tsenart/vegeta>Vegeta</a> を利用して、実際に負荷をかけてみます。下記コマンドを実行します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#39;GET http://&lt;識別子&gt;.ap-northeast-1.elb.amazonaws.com/metrics&#39;</span> | vegeta attack -duration<span style=color:#f92672>=</span>5s | vegeta report
</span></span></code></pre></div><p>その後、再び Grafana のダッシュボードを見にいきます。負荷をかけた時間帯のみグラフに変化があることを確認できるはずです。</p><p><img alt="ダッシュボードの CPU 使用率のグラフに変化があったことを確認できる" loading=lazy src=https://i.gyazo.com/d019d33d3e4bd321ae4d1f4bbecc6ef8.png>
<strong>ダッシュボードの CPU 使用率のグラフに変化があったことを確認できる</strong></p><h1 id=おわりに>おわりに<a hidden class=anchor aria-hidden=true href=#おわりに>#</a></h1><p>今回は ECS Fargate のメトリクスを Prometheus Agent で Amazon Managed Service for Prometheus (AMP) に送信し、それを Grafana で可視化する方法について紹介しました。</p><p>ECS のサービスでタスクを実行する場合は <a href=https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/service-discovery.html>サービスディスカバリ</a> の利用が可能なため、Prometheus の <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/#dns_sd_config>サービスディスカバリの設定</a> を行うことで、単一の Prometheus で全てのコンテナのメトリクスを扱うことも可能です。</p><p>また Node.js アプリを作成する際に利用した <code>prom-client</code> で <a href=https://github.com/siimon/prom-client#custom-metrics>カスタムメトリクス</a> を作成することで、監視したい項目を自由に増やすことも可能です。</p><p>本記事が ECS Fargate を監視する際の検討材料の 1 つとなれたら幸いです。</p><h1 id=参考リンク>参考リンク<a hidden class=anchor aria-hidden=true href=#参考リンク>#</a></h1><ul><li><a href=https://aws.amazon.com/jp/fargate/>AWS Fargate（サーバーやクラスターの管理が不要なコンテナの使用）| AWS</a></li><li><a href=https://prometheus.io/blog/2021/11/16/agent/>Introducing Prometheus Agent Mode, an Efficient and Cloud-Native Way for Metric Forwarding | Prometheus</a></li><li><a href=https://aws.amazon.com/jp/prometheus/>Amazon Managed Service for Prometheus | フルマネージド Prometheus | Amazon Web Services</a></li><li><a href=https://grafana.com/>Grafana: The open observability platform | Grafana Labs</a></li><li><a href=https://aws.amazon.com/jp/cdk/>AWS クラウド開発キット – アマゾン ウェブ サービス</a></li><li><a href=https://github.com/siimon/prom-client>siimon/prom-client: Prometheus client for node.js</a></li><li><a href=https://github.com/tsenart/vegeta>tsenart/vegeta: HTTP load testing tool and library. It&rsquo;s over 9000!</a></li><li><a href=https://grafana.com/grafana/dashboards/11159>NodeJS Application Dashboard dashboard for Grafana | Grafana Labs</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://nikaera.com/tags/fargate/>Fargate</a></li><li><a href=https://nikaera.com/tags/prometheus/>Prometheus</a></li><li><a href=https://nikaera.com/tags/grafana/>Grafana</a></li><li><a href=https://nikaera.com/tags/aws/>Aws</a></li><li><a href=https://nikaera.com/tags/nodejs/>Nodejs</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on x" href="https://x.com/intent/tweet/?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&amp;hashtags=fargate%2cprometheus%2cgrafana%2caws%2cnodejs"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&amp;title=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;summary=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;source=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f&title=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on whatsapp" href="https://api.whatsapp.com/send?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b%20-%20https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on telegram" href="https://telegram.me/share/url?text=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&amp;url=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 ECS Fargate のメトリクスを Prometheus Agent 使って AMP に送って Grafana で監視する on ycombinator" href="https://news.ycombinator.com/submitlink?t=%f0%9f%93%94%20ECS%20Fargate%20%e3%81%ae%e3%83%a1%e3%83%88%e3%83%aa%e3%82%af%e3%82%b9%e3%82%92%20Prometheus%20Agent%20%e4%bd%bf%e3%81%a3%e3%81%a6%20AMP%20%e3%81%ab%e9%80%81%e3%81%a3%e3%81%a6%20Grafana%20%e3%81%a7%e7%9b%a3%e8%a6%96%e3%81%99%e3%82%8b&u=https%3a%2f%2fnikaera.com%2farchives%2faws-ecs-fargate-amp-grafana%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://nikaera.com/>Nikaeraintokyo.</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>