<!doctype html><html lang=ja dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>📔 PlayFab の API 制限に引っかかった | Nikaeraintokyo.</title><meta name=keywords content="article,playfab,cloudfunction"><meta name=description content="はじめに
PlayFab で CloudFunction を利用しているときに API 制限に引っかかってしまいました。負荷テストをした際に初めて気づいたのですが、公式ページにも言及が無かったため発覚が遅れてしまいました。そのため、PlayFab に依存していた機能を部分的に外す必要が出てきてしまい苦労しました。
本記事では、上記のような事態に陥る方を減らすため、API 制限に気づくまでの軌跡を辿りながら、PlayFab の CloudFunction を利用する際の注意点について、記事として残しておきたいと思います。
PlayFab の API 制限に引っかかった要因
PlayFab の CloudFunction を利用すると、PlayFab 経由で独自 Web API を実行することが可能になります。また、CloudFunction 経由で独自 Web API を実行すると、PlayFab ユーザ情報が含まれたパラメタが含まれた状態でリクエストが飛んでくるため、その情報を利用することでサーバーサイドで PlayFab の操作を行うことが出来るようになり大変便利です。
そのため、あるプロジェクトでは PlayFab CloudFunction を Azure Function や AWS Lambda のような FaaS を使っている感じで利用しておりました。そして、その利用の仕方は誤りであったことに後々気づきます&mldr;
負荷テストを実装するフェーズで CloudFunction を大量に叩いてみる
PlayFab の CloudFunction を実行するにあたり利用した PlayFab の API は Server-Side Cloud Script - Execute Function というものになります。
同接 2000 人想定で負荷テストのシナリオを実装することが求められていたため、その通りシンプルに 2000 件同時に Server-Side Cloud Script - Execute Function を実行するシナリオを Gatling で組んでみました。すると、何回やっても数十件以上は必ずエラーが発生していることが分かりました。"><meta name=author content="Me"><link rel=canonical href=https://nikaera.com/archives/playfab-api-call-limitation/><meta name=google-site-verification content="G-39TEECMFQW"><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://nikaera.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://nikaera.com/favicon.ico><link rel=apple-touch-icon href=https://nikaera.com/apple-touch-icon.png><link rel=mask-icon href=https://nikaera.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=ja href=https://nikaera.com/archives/playfab-api-call-limitation/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script type=speculationrules>
  {
    "prerender": [{ "where": { "href_matches": "/*" }, "eagerness": "moderate" }],
    "prefetch": [{ "where": { "href_matches": "/*" }, "eagerness": "moderate" }]
  }
</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-39TEECMFQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-39TEECMFQW")</script><meta property="og:url" content="https://nikaera.com/archives/playfab-api-call-limitation/"><meta property="og:site_name" content="Nikaeraintokyo."><meta property="og:title" content="📔 PlayFab の API 制限に引っかかった"><meta property="og:description" content="はじめに PlayFab で CloudFunction を利用しているときに API 制限に引っかかってしまいました。負荷テストをした際に初めて気づいたのですが、公式ページにも言及が無かったため発覚が遅れてしまいました。そのため、PlayFab に依存していた機能を部分的に外す必要が出てきてしまい苦労しました。
本記事では、上記のような事態に陥る方を減らすため、API 制限に気づくまでの軌跡を辿りながら、PlayFab の CloudFunction を利用する際の注意点について、記事として残しておきたいと思います。
PlayFab の API 制限に引っかかった要因 PlayFab の CloudFunction を利用すると、PlayFab 経由で独自 Web API を実行することが可能になります。また、CloudFunction 経由で独自 Web API を実行すると、PlayFab ユーザ情報が含まれたパラメタが含まれた状態でリクエストが飛んでくるため、その情報を利用することでサーバーサイドで PlayFab の操作を行うことが出来るようになり大変便利です。
そのため、あるプロジェクトでは PlayFab CloudFunction を Azure Function や AWS Lambda のような FaaS を使っている感じで利用しておりました。そして、その利用の仕方は誤りであったことに後々気づきます…
負荷テストを実装するフェーズで CloudFunction を大量に叩いてみる PlayFab の CloudFunction を実行するにあたり利用した PlayFab の API は Server-Side Cloud Script - Execute Function というものになります。
同接 2000 人想定で負荷テストのシナリオを実装することが求められていたため、その通りシンプルに 2000 件同時に Server-Side Cloud Script - Execute Function を実行するシナリオを Gatling で組んでみました。すると、何回やっても数十件以上は必ずエラーが発生していることが分かりました。"><meta property="og:locale" content="ja"><meta property="og:type" content="article"><meta property="article:section" content="archives"><meta property="article:published_time" content="2021-03-14T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-14T00:00:00+00:00"><meta property="article:tag" content="Article"><meta property="article:tag" content="Playfab"><meta property="article:tag" content="Cloudfunction"><meta property="og:image" content="https://nikaera.com/cover_image.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nikaera.com/cover_image.jpg"><meta name=twitter:title content="📔 PlayFab の API 制限に引っかかった"><meta name=twitter:description content="はじめに
PlayFab で CloudFunction を利用しているときに API 制限に引っかかってしまいました。負荷テストをした際に初めて気づいたのですが、公式ページにも言及が無かったため発覚が遅れてしまいました。そのため、PlayFab に依存していた機能を部分的に外す必要が出てきてしまい苦労しました。
本記事では、上記のような事態に陥る方を減らすため、API 制限に気づくまでの軌跡を辿りながら、PlayFab の CloudFunction を利用する際の注意点について、記事として残しておきたいと思います。
PlayFab の API 制限に引っかかった要因
PlayFab の CloudFunction を利用すると、PlayFab 経由で独自 Web API を実行することが可能になります。また、CloudFunction 経由で独自 Web API を実行すると、PlayFab ユーザ情報が含まれたパラメタが含まれた状態でリクエストが飛んでくるため、その情報を利用することでサーバーサイドで PlayFab の操作を行うことが出来るようになり大変便利です。
そのため、あるプロジェクトでは PlayFab CloudFunction を Azure Function や AWS Lambda のような FaaS を使っている感じで利用しておりました。そして、その利用の仕方は誤りであったことに後々気づきます&mldr;
負荷テストを実装するフェーズで CloudFunction を大量に叩いてみる
PlayFab の CloudFunction を実行するにあたり利用した PlayFab の API は Server-Side Cloud Script - Execute Function というものになります。
同接 2000 人想定で負荷テストのシナリオを実装することが求められていたため、その通りシンプルに 2000 件同時に Server-Side Cloud Script - Execute Function を実行するシナリオを Gatling で組んでみました。すると、何回やっても数十件以上は必ずエラーが発生していることが分かりました。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Archives","item":"https://nikaera.com/archives/"},{"@type":"ListItem","position":2,"name":"📔 PlayFab の API 制限に引っかかった","item":"https://nikaera.com/archives/playfab-api-call-limitation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"📔 PlayFab の API 制限に引っかかった","name":"📔 PlayFab の API 制限に引っかかった","description":"はじめに PlayFab で CloudFunction を利用しているときに API 制限に引っかかってしまいました。負荷テストをした際に初めて気づいたのですが、公式ページにも言及が無かったため発覚が遅れてしまいました。そのため、PlayFab に依存していた機能を部分的に外す必要が出てきてしまい苦労しました。\n本記事では、上記のような事態に陥る方を減らすため、API 制限に気づくまでの軌跡を辿りながら、PlayFab の CloudFunction を利用する際の注意点について、記事として残しておきたいと思います。\nPlayFab の API 制限に引っかかった要因 PlayFab の CloudFunction を利用すると、PlayFab 経由で独自 Web API を実行することが可能になります。また、CloudFunction 経由で独自 Web API を実行すると、PlayFab ユーザ情報が含まれたパラメタが含まれた状態でリクエストが飛んでくるため、その情報を利用することでサーバーサイドで PlayFab の操作を行うことが出来るようになり大変便利です。\nそのため、あるプロジェクトでは PlayFab CloudFunction を Azure Function や AWS Lambda のような FaaS を使っている感じで利用しておりました。そして、その利用の仕方は誤りであったことに後々気づきます\u0026hellip;\n負荷テストを実装するフェーズで CloudFunction を大量に叩いてみる PlayFab の CloudFunction を実行するにあたり利用した PlayFab の API は Server-Side Cloud Script - Execute Function というものになります。\n同接 2000 人想定で負荷テストのシナリオを実装することが求められていたため、その通りシンプルに 2000 件同時に Server-Side Cloud Script - Execute Function を実行するシナリオを Gatling で組んでみました。すると、何回やっても数十件以上は必ずエラーが発生していることが分かりました。\n","keywords":["article","playfab","cloudfunction"],"articleBody":"はじめに PlayFab で CloudFunction を利用しているときに API 制限に引っかかってしまいました。負荷テストをした際に初めて気づいたのですが、公式ページにも言及が無かったため発覚が遅れてしまいました。そのため、PlayFab に依存していた機能を部分的に外す必要が出てきてしまい苦労しました。\n本記事では、上記のような事態に陥る方を減らすため、API 制限に気づくまでの軌跡を辿りながら、PlayFab の CloudFunction を利用する際の注意点について、記事として残しておきたいと思います。\nPlayFab の API 制限に引っかかった要因 PlayFab の CloudFunction を利用すると、PlayFab 経由で独自 Web API を実行することが可能になります。また、CloudFunction 経由で独自 Web API を実行すると、PlayFab ユーザ情報が含まれたパラメタが含まれた状態でリクエストが飛んでくるため、その情報を利用することでサーバーサイドで PlayFab の操作を行うことが出来るようになり大変便利です。\nそのため、あるプロジェクトでは PlayFab CloudFunction を Azure Function や AWS Lambda のような FaaS を使っている感じで利用しておりました。そして、その利用の仕方は誤りであったことに後々気づきます…\n負荷テストを実装するフェーズで CloudFunction を大量に叩いてみる PlayFab の CloudFunction を実行するにあたり利用した PlayFab の API は Server-Side Cloud Script - Execute Function というものになります。\n同接 2000 人想定で負荷テストのシナリオを実装することが求められていたため、その通りシンプルに 2000 件同時に Server-Side Cloud Script - Execute Function を実行するシナリオを Gatling で組んでみました。すると、何回やっても数十件以上は必ずエラーが発生していることが分かりました。\n# Gatling で負荷テストを実行した際に 50件失敗している様子 ================================================================================ ---- Global Information -------------------------------------------------------- \u003e request count 2000 (OK=1950 KO=50 ) \u003e min response time 320 (OK=320 KO=354 ) \u003e max response time 14459 (OK=9723 KO=14459 ) \u003e mean response time 998 (OK=934 KO=3485 ) \u003e std deviation 1510 (OK=1304 KO=4310 ) \u003e response time 50th percentile 545 (OK=543 KO=656 ) \u003e response time 75th percentile 1085 (OK=1077 KO=7209 ) \u003e response time 95th percentile 2243 (OK=2029 KO=10210 ) \u003e response time 99th percentile 7947 (OK=7775 KO=14353 ) \u003e mean requests/sec 100 (OK=97.5 KO=2.5 ) ---- Response Time Distribution ------------------------------------------------ \u003e t \u003c 800 ms 1393 ( 70%) \u003e 800 ms \u003c t \u003c 1200 ms 367 ( 18%) \u003e t \u003e 1200 ms 190 ( 10%) \u003e failed 50 ( 3%) ---- Errors -------------------------------------------------------------------- \u003e status.find.is(200), but actually found 400 50 (100.0%) ================================================================================ 正直 2000件程度の API アクセスであれば、何の問題もなく負荷テストが通ると考えていたので、この結果には驚きました。原因は何なのか調べたところ、Azure Function で PlayFab ユーザ認証を行うために利用していた Authentication - Validate Entity Token で 503 エラーが発生していることが分かりました。\n少ない API 実行件数で負荷テストを実行する場合は問題ないのですが、件数が一定数超えたタイミングで 503 エラーが返却されるようになってしまいます。しかし、たまに同じ件数を実行しているはずなのにスムーズに全件 API 実行に成功することもありました。これは何らかのレートリミット等に引っかかっているのかも知れないということで調査したところ、次の事実が判明しました。\nCloudFunction は FaaS の用途には適さない どうやら PlayFab 公式フォーラムの ある投稿 によると、PlayFab の Server API を呼び出す際は 10秒間に 1000回という制限があるようでした。 そして、この制限を突破するには商用のための契約をした後にインスタンス割当に関する交渉をすることで可能になるかも知れないとのことでした。\nServers are rate limited to 1,000 calls per 10 seconds. What jital is highlighting that the per-player rate should be no more than a few times a minute. A server can call at a higher rate, as it is calling for a lot of users, potentially. If you need a higher limit than 1,000 per 10 seconds, you’ll want to talk to our sales team about getting on an Enterprise contract so that we can work with you on custom limits. There’s an option on the Contact Us form on the main site to message them, if you want to go that route.\nつまり、普通に PlayFab を利用している限りはプランをアップグレードしようと制限に引っかかるということが分かりました。 また、今年 1月に投稿された内容 を見るに 10秒以内に 5000以上のユーザーがログイン/登録できたとあり、もう API の 10秒間に 1000回呼び出し制限は撤廃されたのかを聞いているユーザがいたのですが、まだ撤廃されていないと返信されていたので偶然だったようでした。\nちなみに私も上記が気になったので、セッションごとにレートリミットのかかり方が変わるのか検証するために異なるユーザ情報を用いてリクエスト 2000件を並列に実行してみましたが、503 エラーは変わらず返却され続けていたので、少なくとも私の手元の環境では効果はなさそうでした。\nNo, the rate limits on the Client and Server API calls has not changed. However, the rate limits are currently enforced on a per-server basis. And since the service runs a great many servers for load balancing, it is possible to exceed those limits from time to time.\n原因の調査中 PlayFab は EC2 の us-west-2 リージョンでリクエストを受けていそうなことが分かったのですが、そのアクセス先のインスタンスがロードバランサによって分散されているため、レートリミットの制限がインスタンス先により、時と場合によって制限されるかどうかが決まってくるのかもしれないとのことでした。\n以上のことから、PlayFab の CloudFunction については Azure Function や AWS Lambda のような FaaS のような用途には使わず、あくまでもアプリケーションで補助的に利用するための独自スクリプトを動かす程度に留めて利用するのが正解なように感じました。\nPlayFab のユーザ認証情報である SessionTicket や EntityToken を利用することで、認証周りの実装部分を省くことが出来るかも知れないと思い期待していたのですが、それは別の BaaS を使うか IaaS で自前で作るのが良さそうでした。\nおわりに API の 10秒間に 1000回呼び出し制限については明示的にドキュメントに記載があるわけでもなかったため、気づくことが出来ずプロジェクト終盤で気づくという事故が起きてしまったのですが、私と似たような境遇に陥る人が少しでも減るようにと記事を書いてみました。\nとはいえ、少し調べれば出てくるような制限だったので純粋に調査不足だったなあと反省しました。。CloudFunction はとても便利ですが、利用する際は API の呼び出し制限等用法には十分お気をつけてご利用くださいませ。\nPlayFab が便利な BaaS であることに疑いの余地は無いので今後も利用すると思いますが、知見を貯めつつ効果的に使えるよう勉強していきたいと考えております。また何か知見を得たら随時ブログ記事に書き溜めていきたいと思います。\n参考リンク Azure 関数を使用した PlayFab CloudScript - PlayFab | Microsoft Docs Server-Side Cloud Script - Execute Function (PlayFab CloudScript) | Microsoft Docs Authentication - Validate Entity Token (PlayFab Authentication) | Microsoft Docs Server API limitations - Playfab Community Server API limitations - Playfab Community ","wordCount":"505","inLanguage":"ja","image":"https://nikaera.com/cover_image.jpg","datePublished":"2021-03-14T00:00:00Z","dateModified":"2021-03-14T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://nikaera.com/archives/playfab-api-call-limitation/"},"publisher":{"@type":"Organization","name":"Nikaeraintokyo.","logo":{"@type":"ImageObject","url":"https://nikaera.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://nikaera.com/ accesskey=h title="Nikaeraintokyo. (Alt + H)">Nikaeraintokyo.</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)">
<svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></span></div><ul id=menu><li><a href=https://nikaera.tumblr.com/ title="Music 🎵" target=_blank rel="noopener noreferrer"><span>Music 🎵</span></a></li><li><span>|</span></li><li><a href=https://nikaera.com/archives/ title="Archives 🗄️"><span>Archives 🗄️</span></a></li><li><a href=https://nikaera.com/rss_feeds/ title="RSS Feeds 🔖"><span>RSS Feeds 🔖</span></a></li><li><a href=https://nikaera.com/profile/ title="Profile 👦"><span>Profile 👦</span></a></li><li><a href=https://nikaera.com/portfolio/ title="Portfolio 💼"><span>Portfolio 💼</span></a></li><li><a href=https://nikaera.com/contact/ title="Contact 📥"><span>Contact 📥</span></a></li><li><a href=https://nikaera.com/search/ title="Search 🔍"><span>Search 🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>📔 PlayFab の API 制限に引っかかった</h1><div class=post-meta><span title='2021-03-14 00:00:00 +0000 UTC'>3月 14, 2021</span>&nbsp;·&nbsp;3 分&nbsp;·&nbsp;Me</div></header><div class=post-content><h1 id=はじめに>はじめに<a hidden class=anchor aria-hidden=true href=#はじめに>#</a></h1><p><a href=https://docs.microsoft.com/ja-jp/gaming/playfab/features/automation/cloudscript-af/>PlayFab で CloudFunction</a> を利用しているときに API 制限に引っかかってしまいました。負荷テストをした際に初めて気づいたのですが、公式ページにも言及が無かったため発覚が遅れてしまいました。そのため、PlayFab に依存していた機能を部分的に外す必要が出てきてしまい苦労しました。</p><p>本記事では、上記のような事態に陥る方を減らすため、API 制限に気づくまでの軌跡を辿りながら、PlayFab の CloudFunction を利用する際の注意点について、記事として残しておきたいと思います。</p><h1 id=playfab-の-api-制限に引っかかった要因>PlayFab の API 制限に引っかかった要因<a hidden class=anchor aria-hidden=true href=#playfab-の-api-制限に引っかかった要因>#</a></h1><p>PlayFab の CloudFunction を利用すると、<strong>PlayFab 経由で独自 Web API を実行することが可能になります。また、CloudFunction 経由で独自 Web API を実行すると、PlayFab ユーザ情報が含まれたパラメタが含まれた状態でリクエストが飛んでくるため、その情報を利用することでサーバーサイドで PlayFab の操作を行うことが出来るようになり大変便利です。</strong></p><p>そのため、あるプロジェクトでは PlayFab CloudFunction を Azure Function や AWS Lambda のような FaaS を使っている感じで利用しておりました。<em>そして、その利用の仕方は誤りであったことに後々気づきます&mldr;</em></p><h2 id=負荷テストを実装するフェーズで-cloudfunction-を大量に叩いてみる>負荷テストを実装するフェーズで CloudFunction を大量に叩いてみる<a hidden class=anchor aria-hidden=true href=#負荷テストを実装するフェーズで-cloudfunction-を大量に叩いてみる>#</a></h2><p>PlayFab の CloudFunction を実行するにあたり利用した PlayFab の API は <a href="https://docs.microsoft.com/en-us/rest/api/playfab/cloudscript/server-side-cloud-script/executefunction?view=playfab-rest"><code>Server-Side Cloud Script - Execute Function</code></a> というものになります。</p><p>同接 2000 人想定で負荷テストのシナリオを実装することが求められていたため、その通りシンプルに 2000 件同時に <code>Server-Side Cloud Script - Execute Function</code> を実行するシナリオを Gatling で組んでみました。すると、<strong>何回やっても数十件以上は必ずエラーが発生していることが分かりました。</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># Gatling で負荷テストを実行した際に 50件失敗している様子</span>
</span></span><span style=display:flex><span><span style=color:#f92672>================================================================================</span>
</span></span><span style=display:flex><span>---- Global Information --------------------------------------------------------
</span></span><span style=display:flex><span>&gt; request count                                       <span style=color:#ae81ff>2000</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>1950</span>   KO<span style=color:#f92672>=</span><span style=color:#ae81ff>50</span>    <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; min response time                                    <span style=color:#ae81ff>320</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>320</span>    KO<span style=color:#f92672>=</span><span style=color:#ae81ff>354</span>   <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; max response time                                  <span style=color:#ae81ff>14459</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>9723</span>   KO<span style=color:#f92672>=</span><span style=color:#ae81ff>14459</span> <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; mean response time                                   <span style=color:#ae81ff>998</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>934</span>    KO<span style=color:#f92672>=</span><span style=color:#ae81ff>3485</span>  <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; std deviation                                       <span style=color:#ae81ff>1510</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>1304</span>   KO<span style=color:#f92672>=</span><span style=color:#ae81ff>4310</span>  <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; response time 50th percentile                        <span style=color:#ae81ff>545</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>543</span>    KO<span style=color:#f92672>=</span><span style=color:#ae81ff>656</span>   <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; response time 75th percentile                       <span style=color:#ae81ff>1085</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>1077</span>   KO<span style=color:#f92672>=</span><span style=color:#ae81ff>7209</span>  <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; response time 95th percentile                       <span style=color:#ae81ff>2243</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>2029</span>   KO<span style=color:#f92672>=</span><span style=color:#ae81ff>10210</span> <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; response time 99th percentile                       <span style=color:#ae81ff>7947</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span><span style=color:#ae81ff>7775</span>   KO<span style=color:#f92672>=</span><span style=color:#ae81ff>14353</span> <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; mean requests/sec                                    <span style=color:#ae81ff>100</span> <span style=color:#f92672>(</span>OK<span style=color:#f92672>=</span>97.5   KO<span style=color:#f92672>=</span>2.5   <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>---- Response Time Distribution ------------------------------------------------
</span></span><span style=display:flex><span>&gt; t &lt; <span style=color:#ae81ff>800</span> ms                                          <span style=color:#ae81ff>1393</span> <span style=color:#f92672>(</span> 70%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; <span style=color:#ae81ff>800</span> ms &lt; t &lt; <span style=color:#ae81ff>1200</span> ms                                 <span style=color:#ae81ff>367</span> <span style=color:#f92672>(</span> 18%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; t &gt; <span style=color:#ae81ff>1200</span> ms                                          <span style=color:#ae81ff>190</span> <span style=color:#f92672>(</span> 10%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>&gt; failed                                                <span style=color:#ae81ff>50</span> <span style=color:#f92672>(</span>  3%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>---- Errors --------------------------------------------------------------------
</span></span><span style=display:flex><span>&gt; status.find.is<span style=color:#f92672>(</span>200<span style=color:#f92672>)</span>, but actually found <span style=color:#ae81ff>400</span>                        <span style=color:#ae81ff>50</span> <span style=color:#f92672>(</span>100.0%<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>================================================================================</span>
</span></span></code></pre></div><p>正直 2000件程度の API アクセスであれば、何の問題もなく負荷テストが通ると考えていたので、この結果には驚きました。<strong>原因は何なのか調べたところ、Azure Function で PlayFab ユーザ認証を行うために利用していた <a href="https://docs.microsoft.com/en-us/rest/api/playfab/authentication/authentication/validateentitytoken?view=playfab-rest"><code>Authentication - Validate Entity Token</code></a> で 503 エラーが発生していることが分かりました。</strong></p><p>少ない API 実行件数で負荷テストを実行する場合は問題ないのですが、<strong>件数が一定数超えたタイミングで 503 エラーが返却されるようになってしまいます。しかし、たまに同じ件数を実行しているはずなのにスムーズに全件 API 実行に成功することもありました。これは何らかのレートリミット等に引っかかっているのかも知れないということで調査したところ、次の事実が判明しました。</strong></p><h2 id=cloudfunction-は-faas-の用途には適さない>CloudFunction は FaaS の用途には適さない<a hidden class=anchor aria-hidden=true href=#cloudfunction-は-faas-の用途には適さない>#</a></h2><p>どうやら PlayFab 公式フォーラムの <a href=https://community.playfab.com/questions/30828/server-api-limitations.html>ある投稿</a> によると、<strong>PlayFab の Server API を呼び出す際は 10秒間に 1000回という制限があるようでした。</strong> そして、この制限を突破するには商用のための契約をした後にインスタンス割当に関する交渉をすることで可能になるかも知れないとのことでした。</p><blockquote><p>Servers are rate limited to 1,000 calls per 10 seconds. What jital is highlighting that the per-player rate should be no more than a few times a minute. A server can call at a higher rate, as it is calling for a lot of users, potentially. If you need a higher limit than 1,000 per 10 seconds, you&rsquo;ll want to talk to our sales team about getting on an Enterprise contract so that we can work with you on custom limits. There&rsquo;s an option on the Contact Us form on the main site to message them, if you want to go that route.</p></blockquote><p>つまり、<strong>普通に PlayFab を利用している限りはプランをアップグレードしようと制限に引っかかるということが分かりました。</strong> また、<a href=https://community.playfab.com/comments/48674/view.html>今年 1月に投稿された内容</a> を見るに 10秒以内に 5000以上のユーザーがログイン/登録できたとあり、もう API の 10秒間に 1000回呼び出し制限は撤廃されたのかを聞いているユーザがいたのですが、まだ撤廃されていないと返信されていたので偶然だったようでした。</p><p>ちなみに私も上記が気になったので、<strong>セッションごとにレートリミットのかかり方が変わるのか検証するために異なるユーザ情報を用いてリクエスト 2000件を並列に実行してみましたが、503 エラーは変わらず返却され続けていたので、少なくとも私の手元の環境では効果はなさそうでした。</strong></p><blockquote><p>No, the rate limits on the Client and Server API calls has not changed. However, the rate limits are currently enforced on a per-server basis. And since the service runs a great many servers for load balancing, it is possible to exceed those limits from time to time.</p></blockquote><p>原因の調査中 PlayFab は EC2 の us-west-2 リージョンでリクエストを受けていそうなことが分かったのですが、そのアクセス先のインスタンスがロードバランサによって分散されているため、レートリミットの制限がインスタンス先により、時と場合によって制限されるかどうかが決まってくるのかもしれないとのことでした。</p><p>以上のことから、<strong>PlayFab の CloudFunction については Azure Function や AWS Lambda のような FaaS のような用途には使わず、あくまでもアプリケーションで補助的に利用するための独自スクリプトを動かす程度に留めて利用するのが正解なように感じました。</strong></p><p><strong>PlayFab のユーザ認証情報である SessionTicket や EntityToken を利用することで、認証周りの実装部分を省くことが出来るかも知れないと思い期待していたのですが、それは別の BaaS を使うか IaaS で自前で作るのが良さそうでした。</strong></p><h1 id=おわりに>おわりに<a hidden class=anchor aria-hidden=true href=#おわりに>#</a></h1><p>API の 10秒間に 1000回呼び出し制限については明示的にドキュメントに記載があるわけでもなかったため、気づくことが出来ずプロジェクト終盤で気づくという事故が起きてしまったのですが、私と似たような境遇に陥る人が少しでも減るようにと記事を書いてみました。</p><p>とはいえ、少し調べれば出てくるような制限だったので純粋に調査不足だったなあと反省しました。。CloudFunction はとても便利ですが、利用する際は API の呼び出し制限等用法には十分お気をつけてご利用くださいませ。</p><p>PlayFab が便利な BaaS であることに疑いの余地は無いので今後も利用すると思いますが、知見を貯めつつ効果的に使えるよう勉強していきたいと考えております。また何か知見を得たら随時ブログ記事に書き溜めていきたいと思います。</p><h1 id=参考リンク>参考リンク<a hidden class=anchor aria-hidden=true href=#参考リンク>#</a></h1><ul><li><a href=https://docs.microsoft.com/ja-jp/gaming/playfab/features/automation/cloudscript-af/>Azure 関数を使用した PlayFab CloudScript - PlayFab | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/rest/api/playfab/cloudscript/server-side-cloud-script/executefunction?view=playfab-rest">Server-Side Cloud Script - Execute Function (PlayFab CloudScript) | Microsoft Docs</a></li><li><a href="https://docs.microsoft.com/en-us/rest/api/playfab/authentication/authentication/validateentitytoken?view=playfab-rest">Authentication - Validate Entity Token (PlayFab Authentication) | Microsoft Docs</a></li><li><a href=https://community.playfab.com/questions/30828/server-api-limitations.html>Server API limitations - Playfab Community</a></li><li><a href="https://community.playfab.com/questions/30828/server-api-limitations.html?childToView=48674#comment-48674">Server API limitations - Playfab Community</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://nikaera.com/tags/article/>Article</a></li><li><a href=https://nikaera.com/tags/playfab/>Playfab</a></li><li><a href=https://nikaera.com/tags/cloudfunction/>Cloudfunction</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on x" href="https://x.com/intent/tweet/?text=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f&amp;url=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f&amp;hashtags=article%2cplayfab%2ccloudfunction"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f&amp;title=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f&amp;summary=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f&amp;source=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f&title=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on whatsapp" href="https://api.whatsapp.com/send?text=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f%20-%20https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on telegram" href="https://telegram.me/share/url?text=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f&amp;url=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share 📔 PlayFab の API 制限に引っかかった on ycombinator" href="https://news.ycombinator.com/submitlink?t=%f0%9f%93%94%20PlayFab%20%e3%81%ae%20API%20%e5%88%b6%e9%99%90%e3%81%ab%e5%bc%95%e3%81%a3%e3%81%8b%e3%81%8b%e3%81%a3%e3%81%9f&u=https%3a%2f%2fnikaera.com%2farchives%2fplayfab-api-call-limitation%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://nikaera.com/>Nikaeraintokyo.</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>